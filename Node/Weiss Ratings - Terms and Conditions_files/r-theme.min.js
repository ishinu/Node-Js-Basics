(function(n){function r(t,i){var u=this,s,f,h,c,a,k,v,y,o=0,d,e,b,r={},l,p,w;n.extend(u,{init:function(){if(i=n.extend({},i),f=t.closest(".r-viewport"),f.length||(t.wrap('<div class="r-paged-content r-page-last r-page-first"><div class="r-viewport"><\/div><\/div>'),f=t.parent()),s=f.parent(),h=s.find("> .r-prev"),h.length)h.on("click touchend",n.proxy(u.onPrevClick,u));else s.prepend(h=n("<div class='r-prev'><\/div>").on("click touchend",n.proxy(u.onPrevClick,u)));if(c=s.find("> .r-next"),c.length)c.on("click touchend",n.proxy(u.onNextClick,u));else s.append(c=n("<div class='r-next'><\/div>").on("click touchend",n.proxy(u.onNextClick,u)));a=h.add(c);k=function(){for(var i=document.createElement("div"),t=["WebkitPerspective","MozPerspective","OPerspective","msPerspective"],n=0;n<t.length;n++)if(i.style[t[n]]!==undefined)return v=t[n].replace("Perspective","").toLowerCase(),y="-"+v+"-transform",!0;return!1}();u.refresh(!1);b=s.width();n(window).on("orientationchange resize",n.proxy(u.onWindowResize,u));f.on("touchstart MSPointerDown pointerdown",n.proxy(u.onTouchStart,u));f.on("click","> *",function(t){var u,i,f;if(!t.isDefaultPrevented()){if(t.target._ratClickHandled){t.preventDefault();return}if(r.hasMove){t.preventDefault();return}if(t.target._ratClickHandled=!0,setTimeout(function(){delete t.target._ratClickHandled},0),u=n(t.target).closest(".r-uses-callback").data("r-callback"),typeof u=="function"){t.preventDefault();u(t);return}i=n(t.target).closest("a").attr("href");i&&(t.preventDefault(),f=n(t.target).closest("a").attr("target"),f?window.open(i,f):window.location=i)}})},goToPage:function(n,t){typeof n!="number"||n<0?n=0:n>=e.length&&(n=e.length-1);o=n;o===0?(s.addClass("r-page-first"),h.addClass("r-disabled")):(s.removeClass("r-page-first"),h.removeClass("r-disabled"));o===e.length-1?(s.addClass("r-page-last"),c.addClass("r-disabled")):(s.removeClass("r-page-last"),c.removeClass("r-disabled"));u.setPositionProperty(-e[o],t)},refresh:function(r){var l,p,nt,tt,y,it,rt;d=[];e=[];l=t.children();p=t.outerWidth()-t.width();l.each(function(){p+=n(this).outerWidth()});t.css("width",p+"px");s.addClass("r-page-last");s.addClass("r-page-first");var w=f.width(),k=h.outerWidth(),ut=c.outerWidth(),a=0;if(i.wholePage){for(nt=0,tt=Math.max(1,Math.ceil(p/w)),a=0;a<tt;a++)e.push(nt),nt+=w-(a===tt-1?k:k+ut);e.length>1&&(e.pop(),e.push(p-w))}else{var g=undefined,b=w-(p-t.width()),ft=l.length,v=0;do if(y=n(l[v]),g===undefined&&(g=v,y.data("ratPageStart",a),d.push(y),e.push(a===0?0:y.position().left-k)),b-=y.outerWidth(),b<=0){b-=ut;do{if(v===g)break;b+=y.outerWidth();v--;y=n(l[v])}while(v>=0&&b<0);a++;b=w-k;g=undefined}while(++v<ft);e.length>1&&(it=n(l[l.length-1]),rt=it.position().left+it.outerWidth(),e.pop(),e.push(rt-w+(t.outerWidth()-rt)))}o>=e.length&&(o=e.length-1);u.goToPage(o,r)},setPositionProperty:function(i,r,f){var e,o;if(typeof f!="number"&&(f=500),f<=0&&(r=!1),k){if(e="translate3d("+i+"px, 0, 0)",r===!0)if(t.css("-"+v+"-transition-duration",f/1e3+"s"),t.css(y,e),f!==0)t.on("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(i){n(i.target).is(t)&&(t.off("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd"),u.onAfterTransition())});else u.onAfterTransition();else t.css("-"+v+"-transition-duration",""),t.css(y,e);return}o={};o.left=i;r===!0?t.animate(o,f,"swing",function(){u.onAfterTransition()}):t.css(y,i)},onAfterTransition:function(){},onPrevClick:function(n){(n.preventDefault(),h.hasClass("r-disabled"))||u.goToPage(o-1,!0)},onNextClick:function(n){(n.preventDefault(),c.hasClass("r-disabled"))||u.goToPage(o+1,!0)},onWindowResize:function(n){var t=s.width();(b!==t||n.type==="orientationchange")&&(b=t,u.refresh(!1))},onTouchStart:function(i){if((i.type==="touchstart"||i.button===0)&&!document.body.classList.contains("r-popover-visible")){i.preventDefault();a.addClass("r-disabled");r.originalPos=t.position();var e=i.originalEvent,o=typeof e.changedTouches!="undefined"?e.changedTouches:[e],s=typeof PointerEvent=="function";if(!s||e.pointerId!==undefined){r.startX=o[0].pageX;r.hasMove=!1;r.originalClickTarget=e.originalTarget||e.target;r.originalClickButton=e.button;r.originalClickButtons=e.buttons;r.originalEventType=e.type;typeof r.endTimer=="number"&&clearTimeout(r.endTimer);f.get(0).setPointerCapture&&(r.pointerId=e.pointerId,f.get(0).setPointerCapture(r.pointerId));l||(l=n.proxy(u.onTouchMove,u),p=n.proxy(u.onTouchEnd,u),w=n.proxy(u.onPointerCancel,u));f.on("touchmove MSPointerMove pointermove",l);f.on("touchend MSPointerUp pointerup",p);f.on("touchcancel MSPointerCancel pointercancel",w)}}},onTouchMove:function(t){var i=t.originalEvent,e=typeof i.changedTouches!="undefined"?i.changedTouches:[i],f;(t.type!=="touchmove"&&t.preventDefault(),f=e[0].pageX-r.startX,Math.abs(f)<1)||(r.hasMove===!1&&(r.hasMove=!0,n.ratObjects.PopoverGlobal.closeAll()),u.setPositionProperty(r.originalPos.left+f,!1))},onTouchEnd:function(i){var v,s,h,c;i.preventDefault();i.stopPropagation();a.removeClass("r-disabled");f.off("touchmove MSPointerMove pointermove",l);f.off("touchend MSPointerUp pointerup",p);f.off("touchcancel MSPointerCancel pointercancel",w);try{f.get(0).releasePointerCapture&&f.get(0).releasePointerCapture(r.pointerId)}catch(d){}if(delete r.pointerId,r.hasMove){if(v=t.position().left,s=v-r.originalPos.left,o===0&&s>0||o===e.length-1&&s<0)u.setPositionProperty(-e[o],!0);else{for(v=e[o]-s,h=0,c=0;c<e.length;c++)if(v>=e[c])h=c;else break;h===o&&(h+=Math.abs(s)<=10?0:s<0?1:-1);u.goToPage(h,!0)}r.endTimer=setTimeout(function(){r={};delete r.endTimer},10)}else if(r.originalClickButton===0||r.originalEventType==="touchstart"){var y=i.originalEvent?i.originalEvent.ctrlKey:!1,k=i.originalEvent?i.originalEvent.altKey:!1,b=i.originalEvent?i.originalEvent.shiftKey:!1;if(r.originalClickTarget.nodeName==="A"&&(y||b)){y?window.open(r.originalClickTarget.href,"_blank").focus():window.open(r.originalClickTarget.href).focus();return}n(r.originalClickTarget).trigger({type:"click",button:r.originalClickButton,buttons:r.originalClickButtons,ctrlKey:y,altKey:k,shiftKey:b})}},onPointerCancel:function(n){n.preventDefault();alert("touch-cancel");u.setPositionProperty(-e[o],!0);a.removeClass("r-disabled");f.off("touchmove MSPointerMove pointermove",l);f.off("touchend MSPointerUp pointerup",p);f.off("touchcancel MSPointerCancel pointercancel",w);try{f.get(0).releasePointerCapture&&f.get(0).releasePointerCapture(r.pointerId)}catch(t){}delete r.pointerId;r.endTimer=setTimeout(function(){r={};delete r.endTimer},10)}});u.init()}var i,t;window.ratHelpMode=function(){return document.body.classList.contains("r-help-mode")};window.ratRatingChangeAlertKey=function(){return window._ratRatingChangeAlertKey||(window._ratRatingChangeAlertKey=n.rat.page.$body.data("rating-change-alert-key"))};n.ratObjects.renders={rating:function(t){var u,f;if(typeof t=="string"&&t)u=t;else if(typeof t=="object"&&t&&typeof t.rating=="string")u=t.rating,f=t.providerName;else return n("<span class='r-none'>").text(T("Ratings.Common|--"));var i=u.substring(0,1),o=i==="A"||i==="B"?"r-green":i==="C"?"r-yellow":i==="D"||i==="E"?"r-red":i==="U"||i==="F"?"r-gray":"r-"+i.toLocaleLowerCase(),e=n("<span class='r-rating'>").addClass(o),s=n("<span class='r-inner'>").text(i).appendTo(e),r=u.length>1?u.substring(1,2):null;return r==="+"||r==="-"?s.addClass(r==="+"?"r-plus":"r-minus"):r=null,f&&typeof f=="string"&&e.attr("data-key","rating_"+f.toLocaleLowerCase()+"_"+i.toLocaleLowerCase()+(r?"_"+r.replace("+","plus").replace("-","minus"):"")),e},ratingChange:function(t){var i=n("<span class='r-rating-change r-alertable'>").attr("data-help-id","rating-change").attr("data-alert-key",ratRatingChangeAlertKey()).attr("data-content-id",t),r;return n.rat.authenticated?(r=n.rat.page._myAlerts._ratingChanges,r?typeof r[t]=="number"?i.addClass("r-rating-change-on").data("user-alert-key",r[t]):i.addClass("r-rating-change-off"):i.addClass("r-rating-change-off r-rating-change-busy")):i.addClass("r-rating-change-off"),i},ratingRecentChange:function(t){return t.rating?t.ratingChange?n("<span class='r-rating-recent-change'>").addClass(t.ratingChange===1?"r-rating-up":"r-rating-down").attr("title",t.ratingChange===1?T("Ratings.Common|The rating was recently upgraded"):T("Ratings.Common|The rating was recently downgraded")):n("<span class='r-rating-recent-change'>"):n("<span class='r-rating-recent-change r-none'>")},formatDollar:function(n,t){var r=numeral(n),i;return isNaN(r.value())?T("Rating.Common|--"):(typeof t=="string"&&t||(t="$0,0.00;$0,0.000000"),i=t.split(";"),n<1)?r.format(i.length==1?i[0]:i[1]):r.format(i[0])},formatNumber:function(n,t){var i=numeral(n);return isNaN(i.value())?T("Rating.Common|--"):(typeof t=="string"&&t||(t="0a,0.00"),i.format(t))},formatPercent:function(n,t){var i=numeral(n);return isNaN(i.value())?T("Rating.Common|--"):(typeof t=="string"&&t||(t="0,0.00%"),i.format(t))},"quote-live-price":function(t,i){t.text(n.ratObjects.renders.formatDollar(i,t.data("quote-format")))},"quote-live-percent-change":function(t,i){t.text(n.ratObjects.renders.formatPercent(i,t.data("quote-format"))).removeClass("r-gain r-loss").addClass(i>=0?"r-gain":"r-loss")},"quote-live-price-chg":function(t,i){t.text(n.ratObjects.renders.formatPercent(i,t.data("quote-format"))).removeClass("r-gain r-loss").addClass(i>=0?"r-gain":"r-loss")},"quote-live-vol":function(t,i){t.text(n.ratObjects.renders.formatNumber(i,t.data("quote-format")||"0,0"))},"quote-live-crypto-vol":function(t,i){t.text(n.ratObjects.renders.formatNumber(i,t.data("quote-format")||"$0a,0.00"))},"quote-live-market-cap":function(t,i){t.text(n.ratObjects.renders.formatNumber(i,t.data("quote-format")||"$0a,0.00"))},EditorialContent:function(t,i){n("<a class='r-content r-editorial-content'>").attr("href",t.url).addClass(t.code?"r-content-"+t.code:null).append(n("<div>").append(n("<div class='r-preview-image'>").append(n("<img>").attr("src",t.f9),t.badge?n("<span class='r-badge'>").html(t.badge):null)),n("<div>").append(n("<div class='r-type'>").html(t.typeDisplayName),n("<div>").append(n("<span class='r-title'>").html(t.displayText)))).appendTo(i)},results:function(t,i){for(var u,f,r=0;r<t.length;r++)u=t[r],f=this[u.providerName],typeof f=="function"?f.call(this,u,i):i.append(n("<div class='alert alert-danger'>").text("Unknown provider type."))},Stock:function(t,i){n("<a class='r-content r-content-rating r-investment r-stock'>").data("r-item",t).attr("href",t.url).append(n("<div>").append(n("<span class='r-type'>").html(t.productName).css({color:t.productNameColor})),n("<div>").append(n("<div class='r-rating-wrap r-large'>").append(this.ratingChange(t.contentId),this.rating(t),this.ratingRecentChange(t)),n("<div>").append(n("<div>").append(n("<span class='r-name'>").text(t.displayText||t.name)),n("<div>").append(t.ticker?n("<span class='r-ticker'>").html(t.ticker):null,t.exchange?n("<span class='r-exchange'>").html(t.exchange):null)))).appendTo(i)},Bank:function(t,i){n("<a class='r-content r-content-rating r-safety r-bank'>").data("r-item",t).attr("href",t.url).append(n("<div>").append(n("<span class='r-type'>").attr("data-help-id","name").html(t.productName).css({color:t.productNameColor})),n("<div>").append(n("<div class='r-rating-wrap r-large'>").append(this.ratingChange(t.contentId),this.rating(t),this.ratingRecentChange(t)),n("<div>").append(n("<div>").append(n("<span class='r-name'>").attr("data-help-id","name").text(t.displayText||t.name)),n("<div>").append(t.headquarters?n("<span class='r-exchange'>").attr("data-help-id","exchange").html(t.headquarters):null)))).appendTo(i)},CreditUnion:function(t,i){n("<a class='r-content r-content-rating r-safety r-credit-union'>").data("r-item",t).attr("href",t.url).append(n("<div>").append(n("<span class='r-type'>").attr("data-help-id","name").html(t.productName).css({color:t.productNameColor})),n("<div>").append(n("<div class='r-rating-wrap r-large'>").append(this.ratingChange(t.contentId),this.rating(t),this.ratingRecentChange(t)),n("<div>").append(n("<div>").append(n("<span class='r-name'>").attr("data-help-id","name").text(t.displayText||t.name)),n("<div>").append(t.headquarters?n("<span class='r-exchange'>").attr("data-help-id","exchange").html(t.headquarters):null)))).appendTo(i)},Etf:function(t,i){n("<a class='r-content r-content-rating r-investment r-etf'>").data("r-item",t).attr("href",t.url).append(n("<div>").append(n("<span class='r-type'>").attr("data-help-id","name").html(t.productName).css({color:t.productNameColor})),n("<div>").append(n("<div class='r-rating-wrap r-large'>").append(this.ratingChange(t.contentId),this.rating(t),this.ratingRecentChange(t)),n("<div>").append(n("<div>").append(n("<span class='r-name'>").attr("data-help-id","name").text(t.displayText||t.name)),n("<div>").append(t.ticker?n("<span class='r-ticker'>").attr("data-help-id","symbol").html(t.ticker):null,t.exchange?n("<span class='r-exchange'>").attr("data-help-id","exchange").html(t.exchange):null)))).appendTo(i)},MutualFund:function(t,i){n("<a class='r-content r-content-rating r-investment r-mutualfund'>").data("r-item",t).attr("href",t.url).append(n("<div>").append(n("<span class='r-type'>").attr("data-help-id","name").html(t.productName).css({color:t.productNameColor})),n("<div>").append(n("<div class='r-rating-wrap r-large'>").append(this.ratingChange(t.contentId),this.rating(t),this.ratingRecentChange(t)),n("<div>").append(n("<div>").append(n("<span class='r-name'>").attr("data-help-id","name").text(t.displayText||t.name)),n("<div>").append(t.ticker?n("<span class='r-ticker'>").attr("data-help-id","symbol").html(t.ticker):null,t.exchange?n("<span class='r-exchange'>").attr("data-help-id","exchange").html(t.exchange):null)))).appendTo(i)},Insurance:function(t,i){n("<a class='r-content r-content-rating r-safety r-credit-union'>").data("r-item",t).attr("href",t.url).append(n("<div>").append(n("<span class='r-type'>").attr("data-help-id","name").html(t.productName).css({color:t.productNameColor})),n("<div>").append(n("<div class='r-rating-wrap r-large'>").append(this.ratingChange(t.contentId),this.rating(t),this.ratingRecentChange(t)),n("<div>").append(n("<div>").append(n("<span class='r-name'>").attr("data-help-id","name").text(t.displayText||t.name)),n("<div>").append(t.headquarters?n("<span class='r-ticker'>").attr("data-help-id","symbol").html(t.headquarters):null,t.companyType?n("<span class='r-exchange'>").attr("data-help-id","exchange").html(t.companyType):null)))).appendTo(i)},Crypto:function(t,i){n("<a class='r-content r-content-rating r-crypto'>").data("r-item",t).attr("href",t.url).append(n("<div>").append(n("<span class='r-type'>").html(t.productName).css({color:t.productNameColor})),n("<div>").append(n("<div class='r-rating-wrap r-large'>").append(this.ratingChange(t.contentId),this.rating(t),this.ratingRecentChange(t)),n("<div>").append(n("<div>").append(n("<span class='r-crypto-logo-container'>").append(n("<img class='r-crypto-logo' role='presentation'>").attr("src",t.dataState===1?"https://cdn.weisscrypto.com/images/"+t.contentId.toLowerCase()+"-small.png":"https://cdn.weisscrypto.com/images/coin-default.png")),n("<span class='r-name'>").text(t.displayText||t.name)),n("<div>").append(t.ticker?n("<span class='r-ticker'>").html(t.ticker):null)))).appendTo(i)},Option:function(t,i){n("<a class='r-content r-option'>").data("r-item",t).append(n("<div>").append(n("<span class='r-type'>").html(t.productName).css({color:t.productNameColor})),n("<div>").append(n("<div>").append(n("<span class='r-name'>").text(t.displayText||t.name)),n("<div>").append(n("<span class='r-ticker'>").html(t.ticker)))).appendTo(i)},"picker-item":function(t,i,r){var u=t.text||t.value;r&&u.toLocaleLowerCase().startsWith(r.toLocaleLowerCase())?i.html("<b>"+u.substring(0,r.length)+"<\/b>"+u.substring(r.length)):i.text(u);typeof t.count=="number"&&i.parent().append(n("<span class='r-badge'>").text(numeral(t.count).format("0,0")))}};n.ratObjects.RatMyLists=n.ratObjects.Class.extend({init:function(t){this._contentId=t;n(".r-my-lists").click(n.proxy(this.onMyButtonClick,this)).on("ratings-remote-setup",function(n){n.remoteName==="my-lists"&&(n.remoteData.contentId=t)}).on("ratings-remote-ready",function(n){n.remoteName==="my-lists"&&(n.remoteSuccess!==!1&&n.remoteResult.count>0?n.$element.removeClass("r-none").find(".r-icon").attr("data-counter",n.remoteResult.count):n.$element.addClass("r-none"),n.$element.addClass("r-ready").ratBusy(!1))})},onMyButtonClick:function(t){if(!ratHelpMode()){if(t.preventDefault(),!n.rat.authenticated){n.rat.signInForm(t);return}var i=this;if(i._popover){i._popover.hide();return}i.myLists={};i._$button=n(t.target);i._popover=i._$button.ratPopover({autoShow:!0,destroyOnHide:!0,className:"r-my-lists-popover",onRender:function(t){var f=n("<div class='r-tabs-container'>").appendTo(t).on("click","> .r-tab",n.proxy(i.onTabClick,i)),u,r;i._$tabSelected=n("<div class='r-tab r-active' data-tab='r-tab-selected'>").text(T("Selected")).appendTo(f);i._$tabAll=n("<div class='r-tab' data-tab='r-tab-all'>").text(T("All")).append(n("<span class='r-badge r-none'>").text("0")).appendTo(f);u=n("<div class='r-tabs-content'>").appendTo(t);i._$tabSelectedContent=n("<div class='r-tab-content r-tab-selected r-active'>").appendTo(u);i._$tabAllContent=n("<div class='r-tab-content r-tab-all'>").appendTo(u);i._$selectedInput=n("<input class='r-selected-input' type='text'>").attr("maxlength","50").attr("placeholder",T("Ratings.Common|Add List")).attr("aria-label",T("Ratings.Common|Add List")).val("").ratInputAutoChange(n.proxy(i.onInputChanged,i));i._$selectedButton=n("<button class='btn btn-primary'>").click(n.proxy(i.onAdd,i));n("<div class='r-search'>").append(i._$selectedInput,i._$selectedButton).appendTo(i._$tabSelectedContent);i._$selectedList=n("<div class='r-list'>").on("click",".r-wrap-left",n.proxy(i.onCheckboxClick,i)).on("click",".r-item",n.proxy(i.onItemClick,i)).on("scroll",n.proxy(i.listScroll,i)).appendTo(i._$tabSelectedContent);i._$allInput=n("<input type='text'>").attr("maxlength","50").attr("placeholder",T("Ratings.Common|Search")).val("").ratInputAutoChange(n.proxy(i.onInputChanged,i));i._$allButton=n("<button class='btn btn-primary r-searching'>").click(n.proxy(i.onInputChanged,i));n("<div class='r-search'>").append(i._$allInput,i._$allButton).appendTo(i._$tabAllContent);i._$allList=n("<div class='r-list'>").on("click",".r-wrap-left",n.proxy(i.onCheckboxClick,i)).on("click",".r-item",n.proxy(i.onItemClick,i)).on("scroll",n.proxy(i.listScroll,i)).appendTo(i._$tabAllContent);u.find("input[type='text']").on("focus",function(t){n(t.target).parent().addClass("r-focus")}).on("blur",function(t){n(t.target).parent().removeClass("r-focus")});if(i.busy(!0),i._data){i.onDataReady();return}try{r=JSON.parse(localStorage.getItem("r-remote-my-lists-all"));Array.isArray(r)||(r=null)}catch(e){r=null}n.ajax({url:ratDataApiUrl+"/my-lists/"+encodeURIComponent(i._contentId)+(r?"/false":""),method:"GET",cache:!1,success:function(u){(t.css({"max-width":t.outerWidth()+"px"}),n.rat.handleError(T("Unable to retrieve your lists. Please try again later."),u,t))||(Array.isArray(u.all)?localStorage.setItem("r-remote-my-lists-all",JSON.stringify(u.all)):u.all=r||[],i._data=u,i.onDataReady(),i._popover.updatePosition())},error:function(i){t.css({"max-width":t.outerWidth()+"px"});n.rat.handleError(T("Unable to retrieve your lists. Please try again later."),i,t)}})},onShown:function(){setTimeout(function(){i._$selectedInput.focus()},100)},onHidden:function(){delete i.myLists;delete i._popover}}).data("ratPopover")}},onDataReady:function(){var t=this._data,i,e,r,u,f,o;if(t.$all={},t.$selected={},!t.norm)for(t.norm=!0,t.allDic={},e=t.allDic,r=t.all,i=0;i<r.length;i++)r[i].nameNorm=r[i].name.toLocaleLowerCase(),e[r[i].nameNorm]=r[i];if(e=t.allDic,u=this._$selectedList,u.ratEmpty(),t.selected.length===0)this._$button.addClass("r-none").find(">.r-icon").attr("data-counter",""),u.addClass("r-is-empty").append(n("<div class='r-empty'>").text(T("Ratings.Common|No lists are selected.")));else{for(this._$button.removeClass("r-none").find(">.r-icon").attr("data-counter",numeral(t.selected.length).format("0,0")),u.removeClass("r-is-empty"),o=[],r=t.selected,i=0;i<r.length;i++)(f=e[r[i].toLocaleLowerCase()],f)&&(o.push(f.nameNorm),this.createElement(f,!0).appendTo(u));t.selected=o}if(u=this._$allList,u.ratEmpty(),t.all.length===0)u.addClass("r-is-empty").append(n("<div class='r-empty'>").html(T("Ratings.Common|No lists to display.")));else for(u.removeClass("r-is-empty"),r=t.all,i=0;i<r.length;i++)(f=r[i],f)&&this.createElement(f,!1).appendTo(u);t.selected.length===0&&t.all.length>0&&this._$tabAll.click();this.updateAllBadge();this.busy(!1)},onTabClick:function(t){var i=n(t.target).closest(".r-tab");if(this.myLists.activeTab=i.data("tab")==="r-tab-selected"?0:1,!i.hasClass("r-active")){var r=i.closest(".r-container").find(".r-tab-content."+i.data("tab")),u=i.parent().find(".r-tab.r-active"),e=u.closest(".r-container").find(".r-tab-content."+u.data("tab")),f=this;if(r.hasClass("r-tab-selected")){this.myLists.activeTab=0;this.onInputChanged(this._$selectedInput,!1)}else{this.myLists.activeTab=1;this.onInputChanged(this._$allInput,!1)}i.addClass("r-active");r.addClass("r-active");u.removeClass("r-active");e.removeClass("r-active");r.hasClass("r-tab-selected")?setTimeout(function(){f._$selectedInput.focus()},0):setTimeout(function(){f._$allInput.focus()},0)}},busy:function(n,t){n?(this._$selectedInput.attr("disabled","disabled"),this._$selectedButton.attr("disabled","disabled"),this._$allInput.attr("disabled","disabled"),this._$allButton.attr("disabled","disabled"),this._$tabSelectedContent.ratBusy({fill:!0,inline:!0,translucent:!0,message:t}),this._$tabAllContent.ratBusy({fill:!0,inline:!0,translucent:!0,message:t})):(this._$selectedInput.removeAttr("disabled"),this._$selectedButton.removeAttr("disabled"),this._$allInput.removeAttr("disabled"),this._$allButton.removeAttr("disabled"),this._$tabSelectedContent.ratBusy(!1),this._$tabAllContent.ratBusy(!1))},onAdd:function(){var t=this,u=this._$tabAll.hasClass("r-active"),i=u?this._$allInput:this._$selectedInput,r=i.val().trim();if(!r){i.focus();return}this.busy(!0,T("Ratings.Common|Adding..."));n.ajax({url:ratDataApiUrl+"/my-lists",method:"PUT",data:{i:t._contentId,n:r},success:function(r){if(t.busy(!1),!n.rat.handleError(T("Unable to add to list. Please try again later."),r)){r.nameNorm=r.name.toLocaleLowerCase();t.selectItem(r);t.updateList(r);i.val("");t.onInputChanged(i,!1)}},error:function(i){t.busy(!1);n.rat.handleError(T("Unable to add to list. Please try again later."),i)}})},createElement:function(t,i){var r=n("<div class='r-item'>").append(n("<span class='r-wrap-left'>").append(n("<span class='r-checkbox'>")),n("<span class='r-wrap-center'>").append(n("<span class='r-my-list'>").text(t.name).addClass("r-style-"+t.style)),n("<span class='r-wrap-right'>").append(n("<span class='r-badge'>").text(numeral(t.count).format("0,0")))).data("r-list",t).attr("data-search",t.nameNorm||t.name.toLocaleLowerCase()),u;return i?this._data.$selected[t.nameNorm]=r.addClass("r-selected"):(this._data.$all[t.nameNorm]=r,u=this._data.$selected[t.nameNorm],u&&u.hasClass("r-selected")&&r.addClass("r-selected")),r},onInputChanged:function(t,i){var e=this._$tabAll.hasClass("r-active"),u,o,f;t instanceof jQuery||(t=n(t.target).closest(".r-tab-content").find("> .r-search >  input[type=text]"),t.focus(),i=e&&!this._$allButton.hasClass("r-searching"));var s=t.val().trim().toLocaleLowerCase(),h=s.length===0,r=t.closest(".r-tab-content").find("> .r-list");if(i){this.onAdd();return}u=!0;o=this.myLists.activeTab===0?this._data.selected:this._data.all;h?(r.find("> .r-item").show(),u=o.length===0):r.find("> .r-item").each(function(t,i){var r=n(i),f=r.attr("data-search");f.includes(s)?(r.show(),u=!1):r.hide()});u?(f=r.find("> .r-empty"),f.length===0&&(f=n("<div class='r-empty'>").appendTo(r)),e&&this._$allButton.removeClass("r-searching"),f.text(o.length===0?T("Ratings.Common|No lists are selected."):T("Ratings.Common|No lists to display."))):(r.find("> .r-empty").remove(),e&&this._$allButton.addClass("r-searching"))},onCheckboxClick:function(t){t.stopPropagation();t.preventDefault();var i=n(t.target).closest(".r-item"),r=i.data("r-list");this.toggleList(r)},onItemClick:function(t){t.preventDefault();var r=this,u=n(t.target).closest(".r-item"),i=u.data("r-list");if(!u.hasClass("r-is-busy")){var f=u.parent(),e=f.offset().top,s=e+f.height(),o=u.offset().top,h=o+u.outerHeight();o<e?(this.myLists._allowScroll=!0,f.scrollTop(f.scrollTop()-(e-o))):h>s&&(this.myLists._allowScroll=!0,f.scrollTop(f.scrollTop()+(h-s)));this.myLists._popover=u.ratPopover({autoShow:!0,destroyOnHide:!0,exclusive:!1,boundary:"viewport",className:"r-popover-more-options r-keep-padding",onRender:function(t){var f=r.isSelected(i),u=n("<ul class='r-menu r-menu-vertical'>").on("click","*",function(t){var u=n(t.target).closest(".r-item"),f=u.data("action");if(!f||typeof r[f]!="function"){u.hasClass("r-option")&&r.changeStyle(i,u.data("value"),u);return}r.myLists._popover&&(t.preventDefault(),r.myLists._popover.hide(),r[f](i))}).appendTo(t);n("<li class='r-separator'>").append(n("<a>").addClass("r-view-content").append(n("<span class='r-icon'>")).append(n("<span class='r-text'>").text(T("View List"))).attr("href",ratSearchUrl+"?q=my-lists("+encodeURIComponent(i.name).replaceAll("%20","+")+")&k="+n.rat.user.userKey)).appendTo(u);n("<li class='r-separator'>").append(n("<span class='r-item'>").data("action","toggleList").addClass(f?"r-unselect":"r-select").append(n("<span class='r-icon'>")).append(n("<span class='r-text'>").text(T(f?"Remove from List":"Add to List")))).appendTo(u);n("<li class='r-separator'>").append(n("<span class='r-item'>").data("action","renameList").addClass("r-rename").append(n("<span class='r-icon'>")).append(n("<span class='r-text'>").text(T("Rename List")))).appendTo(u);n("<li>").append(n("<div class='r-title'>").text(T("Style")),n("<div class='r-options' data-row-size='5'>").append(n("<span class='r-item r-option' data-value='1'>").append(n("<span class='r-my-list r-is-option r-style-1'>")).addClass(i.style===1?"r-selected":null),n("<span class='r-item r-option' data-value='2'>").append(n("<span class='r-my-list r-is-option r-style-2'>")).addClass(i.style===2?"r-selected":null),n("<span class='r-item r-option' data-value='3'>").append(n("<span class='r-my-list r-is-option r-style-3'>")).addClass(i.style===3?"r-selected":null),n("<span class='r-item r-option' data-value='4'>").append(n("<span class='r-my-list r-is-option r-style-4'>")).addClass(i.style===4?"r-selected":null),n("<span class='r-item r-option' data-value='5'>").append(n("<span class='r-my-list r-is-option r-style-5'>")).addClass(i.style===5?"r-selected":null),n("<span class='r-item r-option' data-value='6'>").append(n("<span class='r-my-list r-is-option r-style-6'>")).addClass(i.style===6?"r-selected":null),n("<span class='r-item r-option' data-value='7'>").append(n("<span class='r-my-list r-is-option r-style-7'>")).addClass(i.style===7?"r-selected":null),n("<span class='r-item r-option' data-value='8'>").append(n("<span class='r-my-list r-is-option r-style-8'>")).addClass(i.style===8?"r-selected":null),n("<span class='r-item r-option' data-value='9'>").append(n("<span class='r-my-list r-is-option r-style-9'>")).addClass(i.style===9?"r-selected":null),n("<span class='r-item r-option' data-value='10'>").append(n("<span class='r-my-list r-is-option r-style-10'>")).addClass(i.style===10?"r-selected":null))).appendTo(u)},onHidden:function(){delete r.myLists._popover}}).data("ratPopover")}},listScroll:function(){if(this.myLists._allowScroll){delete this.myLists._allowScroll;return}this.myLists._popover&&this.myLists._popover.hide()},renameList:function(t){var f=this,u,r,i=n.rat.dialog({title:T("Rename List"),cssClass:"r-my-lists-rename-dialog",onRender:function(i){i.append(n("<div class='r-row'>").append(n("<span span='r-label'>").html(T("You are renaming the list '<b>{name}<\/b>'.").replaceAll("{name}",t.name))),n("<div class='r-row'>").append(u=n("<input class='r-input' type='text' maxlength='50'>").val(t.name),r=n("<div class='r-error'>")))},onShown:function(){setTimeout(function(){u.ratSetSelectionRange().focus()},0)}});i.enterButton(T("Rename"),function(){var o=u.val().trim(),s=o.toLocaleLowerCase(),e=f._data;return o===t.name?!0:s?e.$all[s]&&s!==t.nameNorm?(r.show().text(T("A list with the specified name already exists.")).ratBlink(),u.focus(),!1):(r.hide(),i.busy(T("Renaming...")),n.ajax({url:ratDataApiUrl+"/my-lists-rename",method:"POST",data:{n:t.name,e:o},success:function(u){if(u.success===!1){i.busy(!1);r.show().text(n.rat.errorMessage(typeof u.message=="string"?null:T("Unable to rename list."),u)).ratBlink();return}e.selected.removeByValue(t.nameNorm);e.all.removeByValue(t);delete e.allDic[t.nameNorm];e.$all[t.nameNorm]&&e.$all[t.nameNorm].remove();delete e.$all[t.nameNorm];e.$selected[t.nameNorm]&&e.$selected[t.nameNorm].remove();delete e.$selected[t.nameNorm];t.name=o;t.nameNorm=s;f.selectItem(t);f.updateList(t);i.hide()},error:function(t){i.busy(!1);r.show().text(n.rat.errorMessage(T("Unable to rename list."),t)).ratBlink()}}),!1):(r.show().text(T("The list name cannot be empty.")).ratBlink(),u.focus(),!1)},"btn-primary");i.cancelButton();i.show()},changeStyle:function(t,i,r){var u=r.closest(".r-container"),f=this._data;if(t.style!==i){t.stylePrev=t.style;t.style=i;var o=(f.$selected[t.nameNorm]||n()).find(".r-my-list"),s=(f.$all[t.nameNorm]||n()).find(".r-my-list"),e=function(n,t){o.removeClass().addClass("r-my-list r-style-"+n);s.removeClass().addClass("r-my-list r-style-"+n);u.find(".r-option[data-value='"+n+"']").addClass("r-selected");u.find(".r-option[data-value='"+t+"']").removeClass("r-selected")};e(t.style,t.stylePrev);u.ratBusy({inline:!0,fill:!0,translucent:!0,message:T("Saving...")});n.ajax({url:ratDataApiUrl+"/my-lists-style",method:"POST",data:{n:t.name,s:i},success:function(n){n.success===!1&&(e(t.stylePrev,t.style),t.style=t.stylePrev);localStorage.setItem("r-remote-my-lists-all",JSON.stringify(f.all));delete t.stylePrev;u.ratBusy(!1)},error:function(i){e(t.stylePrev,t.style);t.style=t.stylePrev;delete t.stylePrev;u.ratBusy(!1);n.rat.handleError(T("Unable to update list. Please try again later."),i)}})}},toggleList:function(t){var i;if(i=this._$tabSelected.hasClass("r-active")?this._data.$selected[t.nameNorm]:this._data.$all[t.nameNorm],i&&!i.hasClass("r-is-busy")){i.ratPopover("hide");var r=this,u=i.find("> .r-wrap-left"),f=this.isSelected(t);i.addClass("r-is-busy");u.ratBusy({inline:!0,fill:!0,message:""});n.ajax({url:ratDataApiUrl+"/my-lists",method:f?"DELETE":"PUT",data:{i:r._contentId,n:t.name},success:function(e){(i.removeClass("r-is-busy"),u.ratBusy(!1),n.rat.handleError(T("Unable to update list. Please try again later."),e))||(e.nameNorm=e.name.toLocaleLowerCase(),f?(i.removeClass("r-selected"),r._data.selected.removeByValue(t.nameNorm)):(i.addClass("r-selected"),r.selectItem(t,!1)),r.updateList(e))},error:function(t){i.removeClass("r-is-busy");u.ratBusy(!1);n.rat.handleError(T("Unable to update list. Please try again later."),t)}})}},selectItem:function(n,t){var r=this._data,i,u;r.selected.indexOf(n.nameNorm)<0&&(r.selected.push(n.nameNorm),r.selected.sort(function(n,t){return n.localeCompare(t)}));i=r.$selected[n.nameNorm];i?i.find(".r-my-list").text(n.name).removeClass().addClass("r-my-list r-style-"+n.style):(u=r.selected.indexOf(n.nameNorm),i=this.createElement(n,!0),this._$selectedList.hasClass("r-is-empty")&&this._$selectedList.removeClass("r-is-empty").empty(),u>0?r.$selected[r.selected[u-1]].after(i):this._$selectedList.prepend(i));t!==!1&&this._$tabSelected.hasClass("r-active")&&this._$selectedList.animate({scrollTop:i.offset().top-this._$selectedList.offset().top+this._$selectedList.scrollTop()-(this._$selectedList.height()/2-i.outerHeight())},100,function(){i.addClass("r-showing");setTimeout(function(){i.removeClass("r-showing")},200)})},isSelected:function(n){return this._data.selected.indexOf(n.nameNorm)>=0},updateAll:function(n,t,i){var r=this._data,e,u,f;n&&n.count>0&&!r.allDic[n.nameNorm]?(r.allDic[n.nameNorm]=n,r.all.push(n)):n&&n.count===0&&(r.all.removeByValue(n),delete r.allDic[n.nameNorm]);i!==!1&&r.all.sort(function(n,t){return n.nameNorm.localeCompare(t.nameNorm)});n&&n.count>0&&(e=this.isSelected(n),u=r.$all[n.nameNorm],u?(u[e?"addClass":"removeClass"]("r-selected").find(".r-badge").text(numeral(n.count).format("0,0")),u.find(".r-my-list").text(n.name).removeClass().addClass("r-my-list r-style-"+n.style)):(f=r.all.indexOf(n),u=this.createElement(n,!1),this._$allList.hasClass("r-is-empty")&&this._$allList.removeClass("r-is-empty").empty(),f>0?r.$all[r.all[f-1].nameNorm].after(u):this._$allList.prepend(u),this._$tabAll.hasClass("r-active")&&this._$allList.animate({scrollTop:u.offset().top-this._$allList.offset().top+this._$allList.scrollTop()-(this._$allList.height()/2-u.outerHeight())},100,function(){u.addClass("r-showing");setTimeout(function(){u.removeClass("r-showing")},200)})));this.updateAllBadge();t!==!1&&localStorage.setItem("r-remote-my-lists-all",JSON.stringify(r.all))},updateAllBadge:function(){var n=this._data;this._$tabAll.find(".r-badge").text(numeral(n.all.length).format("0,0"))[n.all.length>0?"removeClass":"addClass"]("r-none")},updateList:function(n){var i,t,r,u,f;n.nameNorm||(n.nameNorm=n.name.toLocaleLowerCase());i=this._data;t=i.allDic[n.nameNorm];t?(t.name=n.name,t.count=n.count):t=n;this.updateAll(t);r=this.isSelected(t);u=i.$selected[t.nameNorm];u&&u[r?"addClass":"removeClass"]("r-selected").find(".r-badge").text(numeral(t.count).format("0,0"));f=i.$all[t.nameNorm];f&&f[r?"addClass":"removeClass"]("r-selected").find(".r-badge").text(numeral(t.count).format("0,0"));this._$button[i.selected.length===0?"addClass":"removeClass"]("r-none").find(">.r-icon").attr("data-counter",i.selected.length===0?"":numeral(i.selected.length).format("0,0"))}});n.ratObjects.RatMyAlerts=n.ratObjects.Class.extend({init:function(){var t=n(".r-my-alerts"),i={},r=[];t.each(function(){var t=n(this),u=t.data("content-id");typeof u=="string"&&u&&(r.push(u),i[u]=t,t.data("r-alerts",[]),t.data("r-alerts-by-key",{}))});this._$myAlerts=t;this._$myAlertsById=i;this._contentIds=r},getContentIds:function(){return this._contentIds},isReady:function(){return this._ratingChanges!==undefined},infoReady:function(t){var i=this,r=n("header .r-alerts");this._alertsPreview={$alerts:r,unreadCount:t?t.unreadCount:0};t&&typeof t.unreadCount=="number"&&t.unreadCount>0?r.ratBusy(!1).done(function(){setTimeout(function(){i.alertsUpdateBadge()},0)}):(r.ratBusy(!1),this._alertsPreview.unreadCount=0);this._alertsPreview.lastAlertDate=moment(t?t.lastAlertDate:null);this._alertsPreview.lastAlertDate.isValid()||(this._alertsPreview.lastAlertDate=moment("20000101"));n.rat.authenticated&&(this._alertsPreview.pulseInterval=setInterval(n.proxy(this.alertsPulse,this),3e4));this._alertsPreview.popover=r.ratPopover({mode:"mouseTrack",className:"r-alerts-popover"+(t&&t.hasAlerts?" r-has-alerts":""),onRender:function(r){if(!n.rat.authenticated||!t||!t.hasAlerts){r.html(n("#r-alerts-popover").html());n.rat.page.signInBind(r);return}if(!t){r.html(n("<div class='alert alert-danger'>").text(T("Ratings.Common|Unable to load alerts.")));return}i._alertsPreview.$container=r;i.alertsPopoverLoad()},onHide:function(){i._alertsPreview.cache=i._alertsPreview.$container&&i._alertsPreview.$container.find(".r-busy").length===0&&i._alertsPreview.$list?i._alertsPreview.$container.html():null;delete i._alertsPreview.$container},onElementClick:function(n){return n.attr("href").toLocaleLowerCase()!==window.location.pathname.toLocaleLowerCase()?(window.location=n.attr("href"),!1):undefined}}).data("ratPopover")},alertsReady:function(t){if(n.rat.authenticated&&!t){this._$myAlerts.addClass("r-disabled").ratBusy(!1);return}n.rat.authenticated||(this._ratingChanges={});this.changed(t,!0);this._$myAlerts.click(n.proxy(this.onMyButtonClick,this)).addClass("r-ready").ratBusy(!1)},ratingChangesReady:function(n){var r,t,i;if(!n){this._ratingChanges={};return}for(r=this._ratingChanges={},t=0;t<n.length;t++)i=n[t],r[i[1]]=i[0]},changed:function(n,t){var s,e,h,f,c,r,o,l,a,u,i;if(n&&typeof n=="object"&&(typeof n.contentId=="string"||n instanceof jQuery)&&(n=this.get(n)),s=this.getContentIds().slice(),n)for(e in n)if((h=n[e],Array.isArray(h))&&(s.removeByValue(e),i=this._$myAlertsById[e],i)&&(f=i.data("r-alerts"),c=i.data("r-alerts-by-key"),Array.isArray(f)&&c)){for(u=0;u<h.length;u++){if(r=h[u],r.contentId=e,this._editor&&Array.isArray(this._editor.alertsInfo))for(o=0;o<this._editor.alertsInfo.length;o++)if(this._editor.alertsInfo[o].alert.userAlertId===r.userAlertId){this._editor.alertsInfo[o].alert=r;break}(this.releaseAlert(r),r.enabled!==!1)&&(f.push(r),l=c[r.alertKey],l||(c[r.alertKey]=l=[]),l.push(r))}i.data("r-is-dirty",!0);a=f.length>0;i.find(".r-badge").length?i[a?"removeClass":"addClass"]("r-none").find(".r-badge").text(numeral(f.length).format("0,0")):i[a?"removeClass":"addClass"]("r-none").find(".r-icon").attr("data-counter",f.length)}if(t)for(u=0;u<s.length;u++)(i=this._$myAlertsById[s[u]],i)&&(i.find(".r-badge").length?i.addClass("r-none").find(".r-badge").text(numeral(0).format("0,0")):i.addClass("r-none").find(".r-icon").attr("data-counter",0))},get:function(t){var u,i,f,r,o,s,e;return t instanceof jQuery?(f=t.data("alert-key"),r=t.data("content-id"),r&&(o=this._$myAlertsById[r],s=o?o.data("r-alerts-by-key"):null,f&&typeof f=="string"&&s&&(u=s[f],u)))?(i={},i[r]=u,i):r&&typeof r=="string"&&f===ratRatingChangeAlertKey()&&(u=this.getRatingChange(r),u)?(i={},i[r]=[u],i):null:typeof t=="number"?(e=null,this._$myAlerts.each(function(){for(var u=n(this),r=u.data("r-alerts"),i=0;i<r.length;i++)if(r[i].userAlertId===t)return e={},e[r[i].contentId]=[r[i]],!1}),e):t&&typeof t=="object"&&typeof t.contentId=="string"?(i={},i[t.contentId]=[t],i):null},releaseAlert:function(n){var u,f,i,e,t,r;if(n&&typeof n=="object"&&typeof n.contentId=="string"&&(u=this._$myAlertsById[n.contentId],u)){for(f=u.data("r-alerts"),i=0;i<f.length;i++)if(f[i].userAlertId===n.userAlertId){f.splice(i,1);break}if(e=u.data("r-alerts-by-key"),t=e?e[n.alertKey]:null,t){for(r=0;r<t.length;r++)t[r].userAlertId===n.userAlertId&&t.splice(r,1);t.length===0&&delete e[n.alertKey]}}},getRatingChange:function(n){if(typeof n!="string")return null;var t=this._ratingChanges[n];return typeof t=="number"?{userAlertId:t,alertKey:ratRatingChangeAlertKey()}:null},onMyButtonClick:function(t){t.preventDefault();t.stopPropagation();var i=this;if(i._popover){i._popover.hide();return}if(!n.rat.authenticated){n.rat.signInForm(t);return}i._editor={};i._editor.list={};i._editor.$button=n(t.target).closest(".r-my-alerts");i._editor.providerName=i._editor.$button.data("provider-name")||n.rat.page.$body.data("provider-name");i._popover=i._editor.$button.ratPopover({autoShow:!0,destroyOnHide:!0,className:"r-my-alerts-popover",onRender:function(t){if(i._$content=t,i._definitions&&i._definitions[i._editor.providerName]){t.ratEmpty().append(i.renderAlertsPanel()).ratBusy(!1);return}t.ratBusy();n.ajax({url:ratAlertsApiUrl+"/definition/"+encodeURIComponent(i._editor.providerName),method:"GET",dataType:"json",success:function(r){if(!n.rat.handleError(T("Ratings.Common|Unable to retrieve alerts."),r,t)){i.onDefinitionReady(r);t.ratEmpty().append(i.renderAlertsPanel()).ratBusy(!1)}},error:function(i){n.rat.handleError(T("Ratings.Common|Unable to retrieve alerts."),i,t);t.ratBusy(!1)}})},onShown:function(){},onHidden:function(){delete i._editor;delete i._popover}}).data("ratPopover")},renderAlertsPanel:function(){var u,f,t,i,e,r,o;for(this._editor.$alertsPanel||(u=this._editor.$button.data("content-short-name")||null,this._editor.$alertsPanel=n("<div class='r-alerts-panel'>").append(n("<div class='r-header'>").append(n("<div class='r-title'>").text(u?T("Ratings.Common|My {short-name} Alerts").replaceAll("{short-name}",u):T("Ratings.Common|My Alerts")),n(n("<div class='r-button-light r-alert-add'>")).text(T("Ratings.Common|Add Alert")).click(n.proxy(this.onAddAlert,this))))),f=this._editor.$button.data("r-alerts"),t=this._editor.alertsInfo=[],i=0;i<f.length;i++)(e=f[i],r=this._definitionByAlertKey[e.alertKey],r)&&(this.definitionTemplateBuild(r),o={alert:e,definition:r},this.alertTitle(o),t.push(o));return t.length===0?this.renderEmpty():(t.sort(function(n,t){return n.titleText.localeCompare(t.titleText)}),this.renderMyAlerts()),this._editor.$alertsPanel.fadeIn(0)},renderEmpty:function(){this._editor.$alertsPanel.find(".r-empty").length||(this._editor.$alertsPanel.find(".r-list").remove(),delete this._editor.$myAlertsList,n("<div class='r-empty'>").append(n("<div class='r-icon-large' role='presentation'>"),n("<div class='r-message'>").text(T("Ratings.Common|There are no alerts to display."))).appendTo(this._editor.$alertsPanel))},renderMyAlerts:function(){var t,i,r;for(this._editor.$alertsPanel.find(".r-empty").remove(),this._editor.$myAlertsList?this._editor.$myAlertsList.empty():this._editor.$myAlertsList=n("<div class='r-list'>").on("click","> .r-item > .r-checkbox-wrap",n.proxy(this.onMyAlertCheckbox,this)).on("click","> .r-item",n.proxy(this.onMyAlertClick,this)).on("scroll",n.proxy(this.myAlertsListScroll,this)).appendTo(this._editor.$alertsPanel),t=0;t<this._editor.alertsInfo.length;t++)i=this._editor.alertsInfo[t],r=n("<div class='r-item r-selected'>").data("ratId",i.alert.userAlertId).data("r-alert-info",i).append(n("<span class='r-checkbox-wrap'>").append(n("<span class='r-checkbox'>")),n("<span class='r-title'>").html(i.title)),this._editor.$myAlertsList.append(r)},onMyAlertCheckbox:function(t){var i,r,u,f;(t instanceof jQuery?i=t:(t.preventDefault(),t.stopPropagation(),i=n(t.target).closest(".r-item")),r=i.data("r-alert-info"),r)&&((u=i.find("> .r-checkbox-wrap"),u.hasClass("r-is-busy"))||(this._myAlertsListPopover&&(this._myAlertsListPopover._cancelSave=!0,this._myAlertsListPopover.hide()),f=!i.hasClass("r-selected"),u.ratBusy({inline:!0,fill:!0,message:""}),n.ajax({url:ratAlertsApiUrl+"/update",method:"POST",data:{u:r.alert.userAlertId,e:f,m:r.alert.message||null,d:r.alert.data?JSON.stringify(r.alert.data):null},success:function(t){(u.ratBusy(!1),n.rat.handleError(T("Ratings.Alert|Unable to update the alert. Please try again later."),t))||(n.rat.page.alertableChanged(t),i[f?"addClass":"removeClass"]("r-selected"))},error:function(t){u.ratBusy(!1);n.rat.handleError(T("Ratings.Alert|Unable to update the alert. Please try again later."),t)}})))},onMyAlertClick:function(t){var u,e,i;if(t instanceof jQuery?u=t:(t.preventDefault(),t.stopPropagation(),u=n(t.target).closest(".r-item")),this._myAlertsListPopover){this._myAlertsListPopover.hide();return}if((e=u.find("> .r-checkbox-wrap"),!e.hasClass("r-is-busy"))&&(i=u.data("r-alert-info"),i)){typeof i.alert.enabled!="boolean"&&(i.alert.enabled=!0);var r=this,f=u.parent(),o=f.offset().top,h=o+f.height(),s=u.offset().top,c=s+u.outerHeight();s<o?(this._myAlertsListAllowScroll=!0,f.scrollTop(f.scrollTop()-(o-s))):c>h&&(this._myAlertsListAllowScroll=!0,f.scrollTop(f.scrollTop()+(c-h)));this._myAlertsListPopover=u.ratPopover({autoShow:!0,destroyOnHide:!0,exclusive:!1,boundary:"viewport",className:"r-my-alerts-edit-popover",onRender:function(t){var h=n("<ul class='r-menu r-menu-vertical'>").on("click","*",function(t){var e=n(t.target),i,f,o;if(!e.is("input")){if(i=e.closest("li"),f=i.find("> .r-editor"),f.length){f.ratFocusFirstInput();return}if(o=i.data("action"),o==="toggleAlert")r.onMyAlertCheckbox(u);r._myAlertsListPopover&&(t.preventDefault(),r._myAlertsListPopover.hide())}}).appendTo(t),o,f,c,s,e,a,v;if(i.definition.templateInfo){o=i.definition;f=[];for(c in o.templateInfo)Object.prototype.hasOwnProperty.call(o.templateInfo,c)&&f.push(o.templateInfo[c]);for(f.sort(function(n,t){return t.ordinal-n.ordinal}),i.alert.data||(i.alert.data={}),i.oldData=n.rat.copyProperties({},i.alert.data),s=0;s<f.length;s++)(e=f[s],e.hidden)||(a=n("<li class='r-separator'>").appendTo(h),v=n("<div class='r-editor'>").append(n("<div class='r-title'>").html(e.title||e.name)).appendTo(a),r.definitionTemplatePropEditor(i,e,v))}var y=n("<li class='r-separator'>").appendTo(h),p=n("<div class='r-editor'>").append(n("<div class='r-title'>").html(T("Ratings.Common|My message"))).appendTo(y),l=n("<input type='text' class='r-input' maxlength='50'>").appendTo(p).val((i.alert.message||"").trim()).on("change",function(){var n=l.val().trim();(i.alert.message||"")!==n&&(i.isDirty=!0,i.alert.message=n?n:null)}).on("keyup",function(n){n.originalEvent.keyCode===13?(l.trigger("change"),r._myAlertsListPopover&&r._myAlertsListPopover.hide()):n.originalEvent.keyCode===27&&r._myAlertsListPopover&&(r._myAlertsListPopover._cancelSave=!0,r._myAlertsListPopover.hide())}).on("blur",function(){l.trigger("change")});n("<li class='r-separator'>").data("action","toggleAlert").append(n("<span>").addClass(i.alert.enabled!==!1?"r-unselect":"r-select").append(n("<span class='r-icon'>")).append(n("<span class='r-text'>").text(T(i.alert.enabled!==!1?"Remove alert":"Add alert")))).appendTo(h)},onShown:function(){var n=this;setTimeout(function(){n.popoverElement().ratFocusFirstInput()},10)},onHidden:function(){var t,f;if(r._myAlertsListPopover._cancelSave&&(i.alert.data=i.oldData,delete i.isDirty),t=function(n){n&&(i.alert.data=i.oldData,r.alertTitle(i),u.find("> .r-title").html(i.title));delete r._myAlertsListPopover;delete i.oldData;delete i.isDirty},i.isDirty!==!0){t();return}r.alertTitle(i);u.find("> .r-title").html(i.title);e.ratBusy({inline:!0,fill:!0,message:""});i.alert.enabled=!0;f=i.definition.templateInfo?i.definition.templateInfo.base:null;f&&(i.alert.data.base=r.definitionTemplatePropDefault(f));n.ajax({url:ratAlertsApiUrl+"/update",method:"POST",data:{u:i.alert.userAlertId,e:i.alert.enabled,m:i.alert.message,d:i.alert.data?JSON.stringify(i.alert.data):null},success:function(r){if(e.ratBusy(!1),n.rat.handleError(T("Ratings.Alert|Unable to update the alert. Please try again later."),r)){t(!0);return}t();n.rat.page.alertableChanged(r);u[i.alert.enabled?"addClass":"removeClass"]("r-selected")},error:function(i){t(!0);e.ratBusy(!1);n.rat.handleError(T("Ratings.Alert|Unable to update the alert. Please try again later."),i)}})}}).data("ratPopover")}},myAlertsListScroll:function(){if(this._listAllowScroll){delete this._myAlertsListAllowScroll;return}this._myAlertsListPopover&&this._myAlertsListPopover.hide()},onAddAlert:function(){var t=this,i,r,u;this._editor.$alertsPanel.hide().fadeOut(0);this._editor.add={};this._editor.add.$addPanel=n("<div class='r-alerts-panel'>").fadeOut(0).appendTo(this._$content).append(n("<div class='r-header'>").append(n("<div class='r-title'>").text(T("Ratings.Common|Add Alert")),n(n("<span class='btn btn-light'>")).text(T("Ratings.Common|Cancel")).click(n.proxy(this.onAddAlertClose,this))));i=n("<div class='r-tabs'>").appendTo(this._editor.add.$addPanel);r=n("<div class='r-tabs-container'>").appendTo(i);this._$tabCommon=n("<div class='r-tab r-active' data-tab='r-tab-selected'>").text(T("Ratings.Common|Common Alerts")).appendTo(r);this._$tabAll=n("<div class='r-tab' data-tab='r-tab-all'>").text(T("Ratings.Common|All Alerts")).appendTo(r);u=n("<div class='r-tabs-content'>").appendTo(i);this._$tabCommonContent=n("<div class='r-tab-content r-tab-selected r-active'>").appendTo(u);this._$tabAllContent=n("<div class='r-tab-content r-tab-all'>").appendTo(u);this._$allSearchInput=n("<input type='text'>").attr("maxlength","50").attr("placeholder",T("Ratings.Common|Search")).val("").ratInputAutoChange(n.proxy(this.onAllSearchInputChanged,this));n("<div class='r-search'>").append(this._$allSearchInput).appendTo(this._$tabAllContent);this.renderAddAlertDefinitions(this._$tabCommonContent,this._definitions[t._editor.providerName].common);this.renderAddAlertDefinitions(this._$tabAllContent,this._definitions[t._editor.providerName].all);i.ratTabs({onTabChanged:function(){t._popover&&t._popover.updatePosition()}});this._editor.add.$addPanel.fadeIn("normal",function(){t._popover&&t._popover.updatePosition()})},onAddAlertClose:function(t){var i=this,r=n.Deferred();return this._editor.add?this._editor.add.$addedConfirmPanel&&(this._editor.add.$addedConfirmPanel.remove(),delete this._editor.add.$addedConfirmPanel,t!==!0)?(this._editor.add.$addPanel.fadeIn("normal",function(){i._popover&&i._popover.updatePosition();r.resolve()}),i._popover&&i._popover.updatePosition(),r.promise()):(this._editor.add.$addPanel.remove(),delete this._editor.add,i._editor.$alertsPanel.fadeIn("normal",function(){i._popover&&i._popover.updatePosition();r.resolve()}),i._popover&&i._popover.updatePosition(),r.promise()):(setTimeout(function(){r.resolve()},0),r.promise())},onDefinitionReady:function(n){var u,i,r,t;if(n.sort(function(n,t){return t.ordinal===n.ordinal?n.title.localeCompare(t.title):t.ordinal-n.ordinal}),this._editor){for(u=[],i=this._definitionByAlertKey,i||(i=this._definitionByAlertKey={}),r=0;r<n.length;r++)t=n[r],t.common&&u.push(t),i[t.key]=t;this._definitions||(this._definitions={});this._definitions[this._editor.providerName]={all:n,common:u}}},renderAddAlertDefinitions:function(t,i){for(var r,f=n("<div class='r-list'>").on("click","> .r-item",n.proxy(this.onAddAlertClick,this)).appendTo(t),u=0;u<i.length;u++)r=i[u],n("<div class='r-item'>").data("r-definition",r).attr("data-search",(r.title||"").toLocaleLowerCase()).addClass(this.definitionSelected(r)?"r-selected":null).append(n("<span class='r-icon'>"),n("<span class='r-title'>").html(r.title||"NO TITLE")).appendTo(f)},onAllSearchInputChanged:function(t){var f=t.val().trim().toLocaleLowerCase(),e=f.length===0,i=t.closest(".r-tab-content").find("> .r-list"),u=!0,r;e?(i.find("> .r-item").show(),u=!1,t.val("")):i.find("> .r-item").each(function(t,i){var r=n(i),e=r.attr("data-search");e.includes(f)?(r.show(),u=!1):r.hide()});u?(r=i.find("> .r-empty"),r.length===0&&(r=n("<div class='r-empty'>").appendTo(i)),r.text(T("No alerts to display"))):i.find("> .r-empty").remove()},onAddAlertClick:function(t){var f=n(t.target).closest(".r-item"),e=f.closest(".r-alerts-panel");if(!e.hasClass("r-is-busy")){var u=this,i=f.data("r-definition"),r=this._editor.$button.data("r-alerts-by-key")[i.key];r&&r.length>0?(r=r[0],this._editor.add.$addPanel.hide().fadeOut(0),i.multiple?(this._editor.add.$addedConfirmPanel=n("<div class='r-alerts-panel'>").fadeOut(0).appendTo(this._$content).append(n("<div class='r-header'>").append(n("<div class='r-title'>").text(T("Ratings.Common|Add Alert")))),n("<div class='r-panel-body'>").append(n("<div class='r-message'>").html(T("Ratings.Common|The alert '{alert}' is already selected. What would you like to do?").replaceAll("{alert}",i.title||"NO TITLE"))).append(n("<div class='r-buttons'>").append(n("<span class='btn btn-primary'>").text(T("Ratings.Common|Edit Existing")).click(function(){u.editAlert(r)}),n("<span class='btn btn-primary'>").text(T("Ratings.Common|Add New")).click(function(){u.addAlert(i)}),n("<span class='btn btn-light'>").text(T("Ratings.Common|Cancel")).click(n.proxy(this.onAddAlertClose,this)))).appendTo(this._editor.add.$addedConfirmPanel)):(this._editor.add.$addedConfirmPanel=n("<div class='r-alerts-panel'>").fadeOut(0).appendTo(this._$content).append(n("<div class='r-header'>").append(n("<div class='r-title'>").text(T("Ratings.Common|Add Alert")))),n("<div class='r-panel-body'>").append(n("<div class='r-message'>").html(T("Ratings.Common|The alert '{alert}' is already selected. Do you want to remove it?").replaceAll("{alert}",i.title||"NO TITLE"))).append(n("<div class='r-buttons'>").append(n("<span class='btn btn-danger'>").text(T("Ratings.Common|Remove")).click(function(){u.removeAlert(r)}),n("<span class='btn btn-light'>").text(T("Ratings.Common|Cancel")).click(n.proxy(this.onAddAlertClose,this)))).appendTo(this._editor.add.$addedConfirmPanel)),this._editor.add.$addedConfirmPanel.fadeIn("normal",function(){u._popover&&u._popover.updatePosition()})):this.addAlert(i)}},addAlert:function(t){var i=this,u=i._editor.$alertsPanel.closest(".popover-body"),f,e,r,s,o;u.ratBusy({fill:!0,translucent:!0,message:T("Ratings.Common|Adding...")});this.definitionTemplateBuild(t);f=!1;e={};for(r in t.templateInfo)Object.prototype.hasOwnProperty.call(t.templateInfo,r)&&(s=t.templateInfo[r],o=this.definitionTemplatePropDefault(s),o!==null&&(e[r]=o,f=!0));n.ajax({url:ratAlertsApiUrl+"/add",method:"POST",data:{c:this._editor.$button.data("content-id"),k:t.key,d:f?JSON.stringify(e):null},success:function(t){n.rat.handleError(T("Ratings.Alert|Unable to add alert."),t)||n.rat.page.alertableChanged(t);i.renderAlertsPanel();u.ratBusy(!1);i.onAddAlertClose(!0).done(function(){for(var n=0;n<t.length;n++)if(t[n].enabled){i.editAlert(t[n]);break}})},error:function(t){n.rat.handleError(T("Ratings.Alert|Unable to add alert."),t);u.ratBusy(!1)}})},editAlert:function(n){var t=this;this.onAddAlertClose(!0).done(function(){var i=t._editor.$myAlertsList.find(".r-item:ratData(ratId=="+n.userAlertId+")");t.onMyAlertClick(i)})},removeAlert:function(t){var i=this,r=i._editor.$alertsPanel.closest(".popover-body");r.ratBusy({fill:!0,translucent:!0,message:T("Ratings.Common|Removing...")});n.ajax({url:ratAlertsApiUrl+"/update",method:"POST",data:{u:t.userAlertId,e:!1,m:t.message,d:t.data?JSON.stringify(t.data):null},success:function(u){if(r.ratBusy(!1),!n.rat.handleError(T("Ratings.Alert|Unable to update the alert. Please try again later."),u)){n.rat.page.alertableChanged(u);i._editor.$myAlertsList.find(".r-item:ratData(ratId=="+t.userAlertId+")").removeClass("r-selected");i.onAddAlertClose(!0)}},error:function(t){r.ratBusy(!1);n.rat.handleError(T("Ratings.Alert|Unable to update the alert. Please try again later."),t)}})},definitionSelected:function(n){if(!this._editor)return!1;var t=this._editor.$button.data("r-alerts-by-key");return t[n.key]!==undefined},definitionTemplateBuild:function(t){if(typeof t.templateInfo!="undefined")return t.templateInfo;if(!t.template||typeof t.template!="string")return t.templateInfo=null;var r={},f=/(?:; )?([^=]+)\=([^;]+)/gm,u=0,i,e=0;return t.templateInfo=(t.templateHtml=t.template.replace(/[{]([^}]+)[}]/gm,function(t,o){var s={},h,c,l;do(i=f.exec(o),i)&&(h=i[2].trim(),c=n.rat.parseFloatEntire(h),s[i[1].trim()]=isNaN(c)?h.toString().toLowerCase()==="false"?!1:h.toString().toLowerCase()==="true"?!0:h:c);while(i);return s.name&&typeof s.name=="string"?(s.type=typeof s.type!="string"?"":s.type.toLocaleLowerCase(),s.ordinal=e++,r[s.name]=s,u++,s.hidden)?"":(l=n("<span>").addClass("r-prop").attr("data-name",s.name),l.ratOuterHTML()):"<b>Invalid Property<\/b>"}),u===0)?null:r},definitionTemplatePropDefault:function(t){var i=t.default,r,u,f;if(typeof t.defaultSelector=="string")try{r=n(t.defaultSelector);r.length&&(r=r.first());i=r.length===0?null:r.val()||r.text()}catch(e){}return i!==undefined&&i!==null&&(u=numeral(i),typeof u.value()!="number"||isNaN(u.value())||(i=u.value())),typeof i=="number"&&typeof t.defaultNearest=="number"&&(i=i+i*t.defaultNearest),typeof i=="number"&&i>=1&&t.round!==!1&&t.type!=="percent"&&(f=i,i=Math.ceil(Math.ceil(i)*.1)*10,i-f>5&&(i-=5)),i===undefined?null:i},definitionTemplatePropDisplayValue:function(n,t){var i,r,u,f;return t===null||t===undefined?T("Ratings.Common|--"):(i=n.type,i==="percent")?(r=numeral(t),r.value()===null?T("Ratings.Common|--"):r.format(n.format||"0.[00]%")):i==="money"?(u=numeral(t),u.value()===null?T("Ratings.Common|--"):u.format(n.format||"$0,0.00")):typeof t=="number"?(f=numeral(t),f.value()===null?T("Ratings.Common|--"):f.format(n.format||"0,0.00")):t},definitionTemplatePropEditor:function(t,i,r){var f=this,h=i.type,c=t.alert.data,s,u,o,e;h==="money"?(s=1,typeof i.format!="string"&&(i.format="$0,0.00"),typeof i.min!="number"&&(i.min=.01),typeof i.increase!="number"&&(i.increase=5)):h==="percent"?(s=.05,typeof i.format!="string"&&(i.format="0.00%"),typeof i.min!="number"&&(i.min=.01),typeof i.increase!="number"&&(i.increase=.05)):(s=1,typeof i.format!="string"&&(i.format="0,0.00"),typeof i.increase!="number"&&(i.increase=5));u=numeral(c[i.name]);u.value()===null&&(u=numeral(s));o=u.value();e=n("<input type='text' class='r-input'>").val(u.format(i.format)).on("change",function(){if(!f._myAlertsListPopover||!f._myAlertsListPopover._cancelSave){var n=e.val().trim();(u=numeral(n),i.type==="percent"&&u.value()!==null&&n.indexOf("%")<=0&&(u=numeral(u.value()/100)),u.value()===null&&(u=numeral(o)),typeof i.min=="number"&&u.value()<i.min&&u.set(i.min),e.val(u.format(i.format)),o!==u.value())&&(c[i.name]=o=u.value(),t.isDirty=!0)}}).on("keydown",function(n){n.originalEvent.keyCode===38?f.increaseInputValue(e,i.increase,i.format,o):n.originalEvent.keyCode===40&&f.increaseInputValue(e,-i.increase,i.format,o,i.min)}).on("keyup",function(n){n.originalEvent.keyCode===13?(e.trigger("change"),f._myAlertsListPopover&&f._myAlertsListPopover.hide()):n.originalEvent.keyCode===27?f._myAlertsListPopover&&(f._myAlertsListPopover._cancelSave=!0,f._myAlertsListPopover.hide()):(n.originalEvent.keyCode===38||n.originalEvent.keyCode===40)&&e.ratSetSelectionRange()}).on("focus",function(){e.ratSetSelectionRange()}).on("blur",function(){e.trigger("change")}).appendTo(r)},increaseInputValue:function(n,t,i,r,u){var f=numeral(n.val().trim());f.value()===null&&(f=numeral(r));f.add(t);typeof u=="number"&&f.value()<u&&f.set(u);t>=1&&f.set(Math.floor(f.value()));n.val(f.format(i))},alertTitle:function(t){var r=t.definition,i,u;if(typeof r.templateHtml!="string"){t.title=r.title||"NO TITLE";t.titleText=t.title;return}i=this;u=n("<div>").html(r.templateHtml);u.find("> span.r-prop").each(function(u,f){var e=n(f),l=e.data("name"),h=r.templateInfo[l],o,s,c;if(!h){e.html("Invalid Property").addClass("r-error");return}o=(t.alert.data?t.alert.data[l]:null)||i.definitionTemplatePropDefault(h);o==null?e.html(T("Ratings.Common|--")).addClass("r-empty"):(e.html(i.definitionTemplatePropDisplayValue(h,o)).addClass("r-empty"),h.type==="percent"&&t.alert.data&&typeof t.alert.data.base=="number"&&(s=t.alert.data.base,c=t.definition.templateInfo.base,e.append(n("<span class='r-targets'>").append(i.definitionTemplatePropDisplayValue(c,Math.max(s-s*o,0))).append(n("<span class='r-or'>").text(T("Ratings.Common|or"))).append(i.definitionTemplatePropDisplayValue(c,s+s*o)))))});t.title=u.html();t.titleText=u.text()},alertsPopoverRender:function(t){var u=this,r=this._alertsPreview.$container,i=r.find("> .r-list"),f,e,o;if(i.length>0)f=n("<div>").html(t).find("> .r-list"),r.find("> .r-list").empty().html(f.html()),u._alertsPreview.$list=i;else{r.ratEmpty().append(t).find('[data-toggle="tooltip"]').bstooltip();r.find(".r-actions-bar > .r-action").on("click",n.proxy(this.alertsPopoverOnAction,this));i=u._alertsPreview.$list=r.find("> .r-list");i.on("click","> .r-alert",n.proxy(this.alertsPopoverOnAlertClick,this))}e=i.data("unread-count");this.alertsUpdateBadge(e);i.find("> .r-alert").length===0&&i.empty().prepend(n("#r-alerts-popover").html());o=r.find(".r-actions-bar > .r-action.r-action-unread");o[localStorage.getItem("r-alerts-undead")?"addClass":"removeClass"]("r-checked")},alertsPopoverOnAction:function(t){var r=this,i=n(t.target).closest(".r-action").bstooltip("hide"),u;if(!i.hasClass("r-disabled")){if(this._alertsPreview.popover.stopMouseTracking(),i.hasClass("r-action-cog")){window.location=i.parent().attr("data-manage-alerts-url");return}if(i.hasClass("r-action-unread")){this.alertsPopoverUnread();return}i.hasClass("r-action-read-all")&&(i.ratBusy({fill:!0,inline:!0,message:""}),u=moment(this._alertsPreview.$list.find("> .r-alert:first").data("date")),n.ajax({url:ratAlertsApiUrl+"/mark-all-as-read",method:"PUT",data:{d:u.toISOString()},success:function(t){(i.ratBusy(!1),n.rat.handleError(t))||(r.alertsUpdateBadge(0),i.addClass("r-disabled"),localStorage.getItem("r-alerts-undead")==="1"?(r._alertsPreview.$list.find("> .r-alert").remove(),r._alertsPreview.$list.prepend(n("#r-alerts-popover").html())):r._alertsPreview.$list.find("> .r-alert.r-new").removeClass("r-new"))},error:function(t){i.ratBusy(!1);n.rat.handleError(t)}}))}},alertsPopoverUnread:function(){var n=this._alertsPreview.popover._$popover.find(".r-actions-bar > .r-action.r-action-unread");localStorage.getItem("r-alerts-undead")?(localStorage.removeItem("r-alerts-undead"),n.removeClass("r-checked").ratBusy({fill:!0,inline:!0,message:""})):(localStorage.setItem("r-alerts-undead","1"),n.addClass("r-checked").ratBusy({fill:!0,inline:!0,message:""}));this.alertsPopoverLoad(!0,function(){n.ratBusy(!1)})},alertsPopoverLoad:function(t,i){var e,f;if(!this._alertsPreview.popover||!this._alertsPreview.$container){i&&i.call(this,!1);return}var r=this,u=r._alertsPreview.$container,o=localStorage.getItem("r-alerts-undead")==="1";if(!u.hasClass("r-is-busy")){if(e=t!==!0?r._alertsPreview.cache:null,e){this.alertsPopoverRender(e);i&&i.call(this,!0);return}f=u.find("> .r-list").length===0;f&&u.ratBusy();n.ajax({url:ratAlertsApiUrl+"/preview"+(o?"?u=1":""),method:"GET",cache:!1,success:function(t){if(r._alertsPreview.$container){if(n.rat.handleError(t)){r._alertsPreview.popover.hide();r._alertsPreview.cache=null;return}f&&u.ratEmpty();r.alertsPopoverRender(t);f&&u.ratBusy(!1);i&&i.call(this,!0)}},error:function(t){r._alertsPreview.popover.hide();r._alertsPreview.cache=null;n.rat.handleError(t);i&&i.call(this,!1)}})}},alertsPopoverOnAlertClick:function(t){var i,r;(this._alertsPreview.popover.stopMouseTracking(),i=n(t.target).closest(".r-alert"),t.preventDefault(),t.stopPropagation(),i.hasClass("r-is-busy"))||(r=this,this._alertsPreview._isNavigating=!0,i.ratBusy({message:""}),n.ajax({url:ratAlertsApiUrl+"/mark-as-read",method:"PUT",data:{i:i.data("id")},success:function(t){if(n.rat.handleError(t)){i.ratBusy(!1);return}i.removeClass("r-new");r.alertsUpdateBadge(r._alertsPreview.unreadCount-1,!1);r._alertsPreview.unreadCount<=0&&r._alertsPreview.popover._$popover.find(".r-actions-bar > .r-action.r-action-read-all").addClass("r-disabled");window.location=i.attr("href")},error:function(t){i.ratBusy(!1);n.rat.handleError(t)}}))},alertsUpdateBadge:function(t,i){var r,u;if(typeof t=="number"&&(this._alertsPreview.unreadCount!==t&&(this._alertsPreview.unreadCount=t,t>0&&i!==!1&&this._alertsPreview.popover&&this._alertsPreview.popover.hide(),this._alertsPreview.cache=null),this._alertsPreview.$list&&this._alertsPreview.$list.data("unread-count",t).attr("data-unread-count",t)),r=this._alertsPreview.$alerts,t=this._alertsPreview.unreadCount,t<=0){r.find("> .r-badge").ratFadeOutRemove();return}u=r.find("> .r-badge");u.length===0&&(u=n("<span class='r-badge'>").hide().appendTo(r).fadeIn());u.text(t>99?T("Ratings.Common|+99"):""+t)},alertsPulse:function(){if(n.rat.authenticated&&!this._alertsPreview._pulse&&!this._alertsPreview._isNavigating){this._alertsPreview._pulse=!0;var t=this;n.ajax({url:ratAlertsApiUrl+"/pulse?d="+encodeURIComponent(this._alertsPreview.lastAlertDate.toISOString()),method:"POST",dataType:"json",cache:!1,success:function(i){if(delete t._alertsPreview._pulse,!t._alertsPreview._isNavigating){if(n.rat.handleError(i)){t._alertsPreview.popover.hide();return}typeof i.unreadCount=="number"&&(t.alertsUpdateBadge(i.unreadCount),t.alertsPopoverLoad(!0))}},error:function(i){delete t._alertsPreview._pulse;t._alertsPreview.popover.hide();n.rat.handleError(i)}})}}});n.ratObjects.RatPage=n.ratObjects.Class.extend({init:function(t,i){if(n.rat.page)throw new"Page was already initiated.";n.rat.page=this;this.$body=t;this._contentId=t.data("content-id")||null;i!==!1&&this.track();this.initHeader();this.initQuickSearch();this.initSidemenu();this.initUser();this.initArea();this.initTags();this.initLists();this.initShare();this.initAlerts();this.initWn();this.initAnalysisReport();this.bindContainer(null,!0);window.addEventListener("resize",n.proxy(this.onWindowResize,this));window.addEventListener("scroll",n.proxy(this.onWindowScroll,this));n('[data-toggle="tooltip"]').bstooltip();n.ratObjects.startupLast.push(n.proxy(this.remoteData,this))},getContentId:function(){return this._contentId},track:function(){var t=this,n=this.$body;n.attr("data-remote","true").attr("data-remote-name","analytics").on("ratings-remote-setup",function(i){i.remoteName==="analytics"&&(i.remoteData.url=window.location.href,i.remoteData.title=document.title,i.remoteData.contentType=n.data("content-type")||null,i.remoteData.contentId=t._contentId)})},remoteData:function(){var u=this,t=[],r={},f=sessionStorage.getItem("r-remote-session")==="1",i;if(!f)for(i in localStorage)Object.prototype.hasOwnProperty.call(localStorage,i)&&i.startsWith("r-remote")&&localStorage.removeItem(i);if(n('[data-remote="true"]').each(function(i,u){var e=n(u),o=e.data("remote-name"),h,l,s,c;try{if(f&&(h=JSON.parse(localStorage.getItem("r-remote-"+o)),h&&(l=e.trigger({type:"ratings-remote-ready",$element:e,remoteName:o,remoteResult:h,fromCache:!0}),l!==!1))){e.attr("data-remote","ready");return}}catch(a){}(s=r[o]={},c={},e.trigger({type:"ratings-remote-setup",$element:e,remoteName:o,remoteData:s,cache:c}),s.cancel!==!0)&&(r[o]=s,t.push({$element:e,remoteName:o,remoteData:s,cache:c}))}),sessionStorage.setItem("r-remote-session","1"),t.length===0){u.alertsBind();return}n.ajax({url:ratDataApiUrl+"/remote",method:"POST",dataType:"json",data:JSON.stringify(r),success:function(n){for(var i,r,f=0;f<t.length;f++)i=t[f],r=n[i.remoteName]||{success:!1},i.$element.trigger({type:"ratings-remote-ready",$element:i.$element,remoteName:i.remoteName,remoteResult:r,remoteData:i.remoteData,cache:i.cache}).attr("data-remote",r.success!==!1?"ready":"error"),r.success!==!1&&r.sessionCache===!0&&(delete r.success,delete r.sessionCache,localStorage.setItem("r-remote-"+i.remoteName,JSON.stringify(r)));u.alertsBind()},error:function(){for(var i,n=0;n<t.length;n++)i=t[n],i.$element.trigger({type:"ratings-remote-ready",$element:i.$element,remoteName:i.remoteName,remoteSuccess:!1})}})},initHeader:function(){this._hasStickyHeader=document.body.classList.contains("r-has-sticky-header");this._hasStickyHeader&&(this._stickyScrollInfo={last:0,lastDir:0,start:0,stickyReady:!1});this.$body.find("> nav > .r-header-navigation ul, > .r-header-subnav > div ul").ratPagedContent();this.headerUpdate()},initQuickSearch:function(){var t=this;this._$quickSearch=n("#r-quick-search").on("mouseover",function(){t._$quickSearch.addClass("r-hover")}).on("mouseout",function(){t._$quickSearch.removeClass("r-hover")}).on("click",function(){if(t._$quickSearch._clickHandled){delete t._$quickSearch._clickHandled;return}t._$quickSearchInput.focus()});this._$quickSearchInput=this._$quickSearch.find("> input[type=text]").on("focus",function(){t._$quickSearch.addClass("r-focused");t.quickSearchOpen()}).on("blur",function(){t._$quickSearch.removeClass("r-focused")}).on("change",function(){t._$quickSearch[n(this).val().trim().length===0?"removeClass":"addClass"]("r-has-value")}).on("keydown",function(i){var e=t._$quickSearch._$popover,o,f,u,r;if(e){if(i.keyCode===13){o=e.find(".r-container > .r-results > a.r-active");o.length===1&&(i.preventDefault(),window.location=o.attr("href"));return}f=0;switch(i.keyCode){case 38:f=-1;break;case 40:f=1}f!==0&&(u=e.find(".r-container > .r-results > a"),u.length)&&(r=t._$quickSearch.ratActiveIndex,typeof r!="number"&&(r=-1),r>=0&&r<u.length&&n(u[r]).removeClass("r-active"),r+=f,r=r<0?u.length-1:r>=u.length?0:r,t._$quickSearch.ratActiveIndex=r,n(u[r]).addClass("r-active")[f===1?"ratScrollToTop":"ratScrollToBottom"]())}}).ratInputAutoChange(function(){t.quickSearch()},300).removeAttr("disabled");n(".r-search-start").click(function(n){(n.preventDefault(),t._$quickSearch._clickHandled=!0,ratHelpMode())||t.searchStart()});this._$quickSearch.find("> .r-area").click(function(i){i.preventDefault();i.stopPropagation();setTimeout(function(){var r,u;t._$quickSearch._areas||(r=n("#r-quick-search-area").val().trim(),t._$quickSearch._areas=[{text:T("Ratings.Area|All"),value:"",separator:!0,selected:r===""},{text:T("Ratings.Area|Stocks & Funds"),value:"stock,etf,mf",selected:r==="stock,etf,mf"},{text:T("Ratings.Area|Crypto"),value:"crypto",selected:r==="crypto"},{text:T("Ratings.Area|Banking"),value:"bank,cu",selected:r==="bank,cu"},{text:T("Ratings.Area|Insurance"),value:"ins",selected:r==="ins"},]);u=!1;t._$quickSearch._popoverArea=n(i.target).closest(".r-area").find(".r-value").ratPopover({autoShow:!0,exclusive:!1,closeOnSelect:!0,boundary:"viewport",items:t._$quickSearch._areas,className:"r-quick-search-area-popover",onChanged:function(i){i.selected&&(u=!0,t._$quickSearch.find("> .r-area .r-value").text(i.text),n("#r-quick-search-area").val(i.value),t.quickSearch(null))},onHidden:function(){delete t._$quickSearch._popoverArea;(u||t._$quickSearch.hasClass("r-dropdown-open"))&&setTimeout(function(){t._$quickSearchInput.focus()},0)}},"Select").data("ratPopover")})});this._$quickSearch.find("> .r-clear").click(function(n){n.preventDefault();t._$quickSearchInput.val("").trigger("change").focus();setTimeout(function(){t._$quickSearchInput.focus()},0)});this._$quickSearch.find("> .r-dropdown").click(function(n){(n.preventDefault(),t._$quickSearch._clickHandled=!0,ratHelpMode())||(t._$quickSearch.hasClass("r-dropdown-open")?t.quickSearchClose():t.quickSearchOpen())});this._$quickSearch.on("submit",function(n){n.preventDefault();t.searchStart()});window.onpopstate=function(){var n=window.ratNav?window.ratNav[window.location.pathname]:null;if(!n){window.location.reload();return}n.fn()}},initSidemenu:function(){var t=this;n("body > nav .r-all").click(function(i){if(i.preventDefault(),!t.$body.hasClass("r-lock-position")){t.$body.addClass("r-lock-position");t._$sidemenu=n("#r-sidemenu");t._$sidemenuBackground=n("<div class='r-sidemenu-background'>").click(function(){t.closeSidemenu()}).appendTo(t.$body).fadeIn(250);var r=t._$sidemenu.find("> .r-sidemenu-header");n("<div class='r-close'>").append("<div class='r-icon'>&times;<\/div>").appendTo(r).click(function(){t.closeSidemenu()});t._$sidemenu.css({display:"flex"});setTimeout(function(){t._$sidemenu.addClass("r-visible")},10);n("#r-sidemenu").on("click","li > .r-link > .r-toggle",function(t){t.preventDefault();n(this).hasClass("r-extend")?(n(this).removeClass("r-extend"),n(this).parent().siblings(".r-menu-sub").slideUp()):(n(this).addClass("r-extend"),n(this).parent().siblings(".r-menu-sub").slideDown())})}})},initUser:function(){n(".r-button-user-avatar").ratPopover({mode:"mouseTrack",onRender:function(t){t.append(n("body #r-user-popup").html())},onShow:function(){this.getElement().children().addClass("r-active")},onHidden:function(){this.getElement().children().removeClass("r-active")}})},initArea:function(){var t=n(document.body).data("area-name");t&&typeof t=="string"&&n.rat.setCookie("r-a",t)},initTags:function(){var t=n(".r-tags");t.length&&(this._$tags=t,t.find(".r-more").click(n.proxy(this.onTagsMoreClick,this)),t.find(".r-less").click(n.proxy(this.onTagsMoreClick,this)))},initLists:function(){this._myLists=new n.ratObjects.RatMyLists(this._contentId)},initShare:function(){var t=n(".r-action-share");t.length&&t.ratPopover({mode:"click",className:"r-share-popover",onRender:function(i){i.jsSocials({showLabel:!1,showCount:!1,shareIn:"blank",shares:["email","twitter","facebook","linkedin","messenger","telegram","pinterest","whatsapp"]});i.on("click","a",function(i){n(i.target).closest("a").bstooltip("hide");setTimeout(function(){t.ratPopover("hide")},0)}).find('[data-toggle="tooltip"]').bstooltip()}})},initAlerts:function(){var t=this,i,r;if(this._myAlerts=new n.ratObjects.RatMyAlerts,!n.rat.authenticated){this._myAlerts.infoReady(null);this._myAlerts.alertsReady(null);this.alertsBind();return}i=n("<div class='r-alerts-loader r-hidden'>").appendTo(document.body).attr("data-remote",!0).attr("data-remote-name","alerts").on("ratings-remote-setup",function(n){n.remoteData.c=t._myAlerts.getContentIds();Array.isArray(n.remoteData.c)&&n.remoteData.c.length!==0||(n.remoteData.cancel=!0,i.remove())}).on("ratings-remote-ready",function(r){if(i.remove(),r.remoteSuccess===!1){n.rat.alert(n.rat.errorMessage(T("Ratings.Alert|Unable to load alerts."),r.remoteResult));n(".r-alert").addClass("r-disabled").ratBusy(!1);t._myAlerts.alertsReady(null);return}t._myAlerts.alertsReady(r.remoteResult.alerts)});r=n("<div class='r-alerts-info-loader r-hidden'>").appendTo(document.body).attr("data-remote",!0).attr("data-remote-name","alerts-info").on("ratings-remote-setup",function(n){try{var t=JSON.parse(localStorage.getItem("r-remote-rating-changes"));Array.isArray(t)&&(n.cache.ratingChanges=t,n.remoteData.ratingChanges=!1)}catch(n){}}).on("ratings-remote-ready",function(i){if(r.remove(),n.rat.authenticated){if(i.remoteSuccess===!1){n.rat.alert(n.rat.errorMessage(T("Ratings.Alert|Unable to load the alerts information."),i.remoteResult));n(".r-rating-change").addClass("r-disabled r-binded r-rating-change-off").removeClass("r-rating-change-on r-rating-change-busy");t._myAlerts.infoReady(null);t._myAlerts.ratingChangesReady(null);return}var u=i.cache.ratingChanges||i.remoteResult["alerts-info"].ratingChanges;i.cache.ratingChanges||localStorage.setItem("r-remote-rating-changes",JSON.stringify(u));t._myAlerts.infoReady(i.remoteResult["alerts-info"]);t._myAlerts.ratingChangesReady(u)}})},initWn:function(){if(n.rat.authenticated){if(!window.OneSignal||typeof window.OneSignal.VERSION!="number"){setTimeout(n.proxy(this.initWp,this),1e3);return}if(window.OneSignal.isPushNotificationsSupported()){var t=this;window.OneSignal.getUserId().then(function(n){t.wnChange({deviceId:n})});window.OneSignal.getNotificationPermission().then(function(n){t.wnChange({enabled:n!=="default"&&n!=="denied"})});window.OneSignal.on("notificationPermissionChange",function(n){t.wnChange({enabled:n.to!=="default"&&n.to!=="denied"})})}}},initAnalysisReport:function(){var t=this;this._analysisReport=new n.ratObjects.RatAnalysisReport;this._analysisReport.init(t)},wnChange:function(t){var i,r;if(this._wn=n.extend(this._wn||{},t),typeof this._wn.deviceId=="string"&&typeof this._wn.enabled=="boolean"){i=sessionStorage.getItem("wn-state");try{i=JSON.parse(i)}catch(u){i=null}r=this;i&&i.deviceId===this._wn.deviceId&&i.enabled===this._wn.enabled||n.ajax({url:ratUserUrl+"/wn-state",method:"POST",data:this._wn,success:function(){sessionStorage.setItem("wn-state",JSON.stringify(r._wn))}})}},headerUpdate:function(){n(document).scrollTop()>5?document.body.classList.add("r-scrolled"):document.body.classList.remove("r-scrolled")},stickyHeaderUpdate:function(){var t,i;if(this._hasStickyHeader){if(window.ratHeaderHeight||(window.ratHeaderHeight=n("body > header").outerHeight(),window.ratStickyHeaderHeight=n(".r-sticky-header").outerHeight()),t=window.pageYOffset,t===0){this._stickyScrollInfo.lastDir=0;document.body.classList.remove("r-scroll-up");return}if(this._stickyScrollInfo.lastDir===0&&(this._stickyScrollInfo.start=this._stickyScrollInfo.last),this._stickyScrollInfo.lastDir=this._stickyScrollInfo.last-t>=0?this._stickyScrollInfo.lastDir===-1?0:1:this._stickyScrollInfo.lastDir===1?0:-1,this._stickyScrollInfo.lastDir===0){this._stickyScrollInfo.last=t;return}Math.abs(this._stickyScrollInfo.start-t)<=50||(this._stickyScrollInfo.lastDir===-1&&t>window.ratHeaderHeight+window.ratStickyHeaderHeight&&!document.body.classList.contains("r-scroll-down")?(document.body.classList.contains("r-scroll-up")||(i=n(".r-sticky-header").css({transition:"none"}),setTimeout(function(){i.css({transition:""})},400)),document.body.classList.remove("r-scroll-up"),document.body.classList.add("r-scroll-down")):this._stickyScrollInfo.lastDir===1&&document.body.classList.contains("r-scroll-down")&&(this._stickyScrollInfo.stickyReady||(this._stickyScrollInfo.stickyReady=!0,n(".r-sticky-header").css({top:window.ratHeaderHeight+"px"})),document.body.classList.remove("r-scroll-down"),document.body.classList.add("r-scroll-up")),this._stickyScrollInfo.last=t)}},quickSearch:function(t){var e=this._$quickSearch._$popover,u,f,r;if(e){var o=e.find(".r-quick-search-container"),s=e.find(".r-container"),i=s.find("> .r-results");if(this._$quickSearch.ratActiveIndex=-1,u=this._$quickSearchInput.val().trim(),f=n("#r-quick-search-area").val().trim(),(u!==this._$quickSearchInput._q||f!==this._$quickSearchInput._a)&&(t=null),t||u!==this._$quickSearchInput._q||f!==this._$quickSearchInput._a){if(this._$quickSearchInput._q=u,this._$quickSearchInput._a=f,!u){this._$quickSearch.removeClass("r-has-query");i.hide().empty();this.quickSearchRecentlySearchedUpdate();o.fadeIn();this.quickSearchResize();return}if(this._$quickSearch.addClass("r-has-query"),o.hide(),i.length||(i=n("<div class='r-results'>").appendTo(s)),i.is(":empty")&&!t&&i.ratBusy({fill:!0}),i.fadeIn(),this._$quickSearch._ajax&&(this._$quickSearch._ajax.abort("abort"),this._$quickSearch._ajax=null),t){this.quickSearchDataReady(t,i);return}r=this;this._$quickSearch._ajax=n.ajax({url:ratSearchApiUrl+"/quick-search?q="+encodeURIComponent(u)+"&a="+encodeURIComponent(n("#r-quick-search-area").val()),method:"GET",success:function(n){r.quickSearchDataReady(n,i);i.ratBusy(!1);r._$quickSearch._ajax=null;r._$quickSearch.data("ratData",n);r._$quickSearch.data("ratRecentlySearched",null)},error:function(t){t&&t.statusText==="abort"||(n.rat.handleError(t,i.ratEmpty(),!0),i.removeClass("r-is-empty").find("> .r-empty").remove(),i.ratBusy(!1),r._$quickSearch._ajax=null,r._$quickSearch.data("ratData",null))}})}}},quickSearchDataReady:function(t,i){var r=n(t),u,f;return i.replaceWith(r),u=this._$quickSearch.find("input[name='q']").val().trim(),f=ratSearchUrl+"?"+this._$quickSearch.serialize(),n("<a class='r-quick-search-footer'>").text(T('Ratings.Common|See all results for "#search#" »').replace("#search#",u)).attr("href",f).appendTo(r),r.find("> .r-empty").length&&r.addClass("r-is-empty"),n.rat.page.alertsBind(r),this.quickSearchResize(),this.dateBind(r),this.logoBind(r),r},quickSearchOpen:function(){var t,r,u,i;if(!this._$quickSearch.hasClass("r-dropdown-open")){if(this._$quickSearch.addClass("r-dropdown-open"),t=this,n.ratObjects.PopoverGlobal.initPopoverCapture(),r=this._$quickSearch.data("bs.popover"),!r)this._$quickSearch.popover({trigger:"manual",html:!0,sanitize:!1,template:'<div class="popover r-popover-init r-quick-search-popover"><div class="popover-body"><\/div><\/div>',placement:"bottom",fallbackPlacement:["left","right","top","bottom"],content:function(){var i=n("<div class='r-container'>").append(n("#r-quick-search-popup").html());return i.find(".r-tabs").ratTabs({sessionName:"r-quick-search-tab",tabIndex:0,onTabChanging:function(n){n.$newTabContent.data("ratLoaded")||(n.$newTabContent.data("ratLoaded",!0),n.$newTab.data("tab")==="r-tab-saved-searches"?t.quickSearchSavedSearches(n.$newTabContent):n.$newTab.data("tab")==="r-tab-recently-viewed"&&t.quickSearchRecentlyViewed(n.$newTabContent))},onTabChanged:function(){t.quickSearchResize();setTimeout(function(){t._$quickSearchInput.focus()},0)}}),i.find(".r-advance-search > a").click(n.proxy(t.searchStart,t)),t.signInBind(i),i}}).on("show.bs.popover",function(){setTimeout(function(){t._$quickSearch.removeClass("r-showing")},100)}).on("shown.bs.popover",function(){t._$quickSearch._$popover.css({"max-height":"0"});t._$quickSearch.addClass("r-dropdown-open-ready");t._$quickSearchInput.focus();setTimeout(function(){t.quickSearchResize()},0)}).on("hidden.bs.popover",function(){t._$quickSearchInput.blur()}).on("rat.popover.hide",function(){t._$quickSearch._popover&&(n.ratObjects.PopoverGlobal.remove(t._$quickSearch._$popover),t._$quickSearch._$popover.addClass("r-popover-init"),delete t._$quickSearch._popover,delete t._$quickSearch._$popover,t._$quickSearch.popover("hide"),t._$quickSearch.removeClass("r-dropdown-open"),t._$quickSearch.removeClass("r-dropdown-open-ready"),t._$quickSearch.hasClass("r-focused")&&setTimeout(function(){t._$quickSearchInput.blur()},0))});n.ratObjects.PopoverGlobal.closeAll();u=t._$quickSearch.outerWidth();t._$quickSearch.addClass("r-showing").popover("show");t._$quickSearch._popover=t._$quickSearch.data("bs.popover");setTimeout(function(){t._$quickSearch._$popover.removeClass("r-popover-init")},0);t._$quickSearch._$popover=n(t._$quickSearch._popover.tip).removeClass("r-closing").css({"min-width":u+"px"});i=t._$quickSearch.data("ratData");i&&t.quickSearch(i);n.ratObjects.PopoverGlobal.push(t._$quickSearch)}},quickSearchClose:function(){this._$quickSearch.trigger("rat.popover.hide")},quickSearchSavedSearches:function(t){var i=this,r=function(r){var e,f,u,o;if(r.length===0){t.find("> .r-empty").addClass("r-visible");return}for(e=n("<div class='r-searches'>").appendTo(t),t.find("> .r-empty").removeClass("r-visible"),f=0;f<r.length;f++)u=r[f],o=moment.utc(u.dateUtc).local().fromNow(),e.append(n("<a class='r-search'>").attr("href",ratSearchUrl+"?q="+encodeURIComponent(u.query)).attr("title",o+" - "+u.query).html((u.query.length>20?"&hellip;":"")+u.query.substring(Math.max(0,u.query.length-20))));n("<div class='r-footer'>").append(n("<a class='r-all'>").attr("href",i._$quickSearch._$popover.find(".r-quick-search-container").data("recentlySearchedUrl")).text("Show all my searches »")).appendTo(t)},u=i._$quickSearch.data("ratSavedSearches");if(u){r(u);return}n.rat.authenticated&&(t.ratBusy({fill:!0}),i._$quickSearch._ajax=n.ajax({url:ratSearchApiUrl+"/quick-search-recently-searched",method:"GET",success:function(u){if(n.rat.handleError(u,t.ratEmpty(),!0)){t.data("ratLoaded",!1).ratBusy(!1);return}i._$quickSearch.data("ratSavedSearches",u);r(u);t.ratBusy(!1)},error:function(i){n.rat.handleError(i,t.ratEmpty(),!0);t.ratBusy(!1)}}))},quickSearchRecentlySearchedUpdate:function(){var t=this._$quickSearch._$popover,n,i,r;if(t){if(n=t.find(".r-tabs"),i=n.find("> .r-tabs-container > .r-tab.r-active"),i.data("tab")!=="r-tab-recently-searched"){n.find("> .r-tabs-content > .r-tab-recently-searched").data("ratLoaded",null);return}r=n.find("> .r-tabs-content > .r-tab-content.r-active");this.quickSearchRecentlySearched(r)}},quickSearchRecentlyViewed:function(t){if(n.rat.authenticated){var i=this,r=function(r){t.ratEmpty();t.append(n(r));i.quickSearchResize();n.rat.page.alertsBind(t);n.rat.page.logoBind(t)},u=i._$quickSearch.data("ratRecentlyViewed");if(u){r(u);return}t.ratBusy({fill:!0});n.ajax({url:ratSearchApiUrl+"/quick-search-recently-viewed",method:"GET",cache:!1,success:function(u){if(n.rat.handleError(u,t.ratEmpty(),!0)){t.data("ratLoaded",!1).ratBusy(!1);return}i._$quickSearch.data("ratRecentlyViewed",u);r(u);t.ratBusy(!1)},error:function(i){n.rat.handleError(i,t.ratEmpty(),!0);t.ratBusy(!1)}})}},quickSearchResize:function(){var t=this._$quickSearch._$popover;if(t){t.css({"min-width":this._$quickSearch.outerWidth()+"px"});var u=n(document).scrollTop(),i=t.offset().top-u,r=this.$body.innerHeight(),f=t.find(".r-tabs-container").innerHeight();t.css({"max-height":r-i-10+"px"});t.find(".r-results").css({"max-height":r-i-f-20+"px"})}},closeSidemenu:function(){var n=this;n._$sidemenu.removeClass("r-visible");n._$sidemenuBackground.ratFadeOutRemove(250).done(function(){n._$sidemenu.find("> .r-sidemenu-header > .r-close").remove();n._$sidemenu.css({display:""});n.$body.removeClass("r-lock-position")})},alertsBind:function(t){if(this._myAlerts&&this._myAlerts.isReady()){var r=this,i=n.rat.page.getContentId(),u=t?t.find(".r-alertable:not(.r-binded)"):n(".r-alertable:not(.r-binded)");u.on("click",n.proxy(this.alertableOnClick,this)).each(function(t,u){var f=n(u),e;if(!n.rat.authenticated){f.addClass("r-binded").ratBusy(!1);return}e=f.data("alert-key");typeof e!="string"?f.addClass("r-binded r-disabled").ratBusy(!1):(i&&!f.attr("data-content-id")&&f.attr("data-content-id",i),r.alertableUpdate(f.addClass("r-binded")))})}},alertableOnClick:function(t){var i;if(t.preventDefault(),t.stopPropagation(),i=n(t.target).closest(".r-alertable"),!ratHelpMode()&&!this.alertableBusy(i)&&!i.hasClass("r-disabled")){if(!n.rat.authenticated){n.rat.signInForm(t);return}n(t.target).closest(".popover").length===0&&n.ratObjects.PopoverGlobal.closeAll();this.alertableBusy(i,!0);var r=this,e=i.data("alert-key"),f=i.data("content-id")||n.rat.page.getContentId(),u=parseInt(i.data("user-alert-id"));isNaN(u)?n.ajax({url:ratAlertsApiUrl+"/add",method:"POST",data:{c:f,k:e},success:function(t){n.rat.handleError(T("Ratings.Alert|Unable to add alert."),t)||r.alertableChanged(t,f);r.alertableBusy(i,!1)},error:function(t){n.rat.handleError(T("Ratings.Alert|Unable to add alert."),t);r.alertableBusy(i,!1)}}):n.ajax({url:ratAlertsApiUrl+"/delete",method:"DELETE",data:{u:u},success:function(t){if(!n.rat.handleError(t)){var o=r._myAlerts.get(u);Array.isArray(o)&&o.length>0?(o[0].enabled=!1,r.alertableChanged(o)):r.alertableChanged({contentId:f,userAlertId:u,alertKey:e,enabled:!1})}r.alertableBusy(i,!1)},error:function(t){n.rat.handleError(t);r.alertableBusy(i,!1)}})}},alertableChanged:function(t){var u,f,e,o,i,r;if(Array.isArray(t)){for(u=0;u<t.length;u++)f=t[u],this.alertableChanged(f);return}if(t.contentId||(t.contentId=this.getContentId()),this._myAlerts.changed(t),e=this,o=n(".r-alertable[data-alert-key='"+t.alertKey+"'][data-content-id='"+t.contentId+"']"),t.enabled!==!1){if(t.alertKey===ratRatingChangeAlertKey()){this._myAlerts._ratingChanges[t.contentId]=t.userAlertId;try{i=JSON.parse(localStorage.getItem("r-remote-rating-changes"));i.push([t.userAlertId,t.contentId]);localStorage.setItem("r-remote-rating-changes",JSON.stringify(i))}catch(s){sessionStorage.removeItem("r-remote-rating-changes")}}}else if(t.enabled=!1,t.alertKey===ratRatingChangeAlertKey()){delete this._myAlerts._ratingChanges[t.contentId];try{for(i=JSON.parse(localStorage.getItem("r-remote-rating-changes")),r=0;r<i.length;r++)i[r][0]===t.userAlertId&&i.splice(r,1);localStorage.setItem("r-remote-rating-changes",JSON.stringify(i))}catch(s){sessionStorage.removeItem("r-remote-rating-changes")}}o.each(function(t,i){e.alertableUpdate(n(i))})},alertableBusy:function(n,t){return typeof t!="boolean"?n.hasClass("r-rating-change")?n.hasClass("r-rating-change-busy"):n.hasClass("r-is-busy"):(n.hasClass("r-rating-change")?n[t?"addClass":"removeClass"]("r-rating-change-busy"):t?n.ratBusy({inline:!0,message:""}).bstooltip("hide"):n.ratBusy(!1),t)},alertableUpdate:function(n,t){if(!t){var i=n.data("content-id");typeof i=="string"&&(t=this._myAlerts.get(n),t=t?t[i]:t,t=Array.isArray(t)&&t.length>0?t[0]:null)}n.hasClass("r-rating-change")?t?n.removeClass("r-rating-change-off").addClass("r-rating-change-on").attr("data-user-alert-id",t.userAlertId).data("user-alert-id",t.userAlertId):n.removeClass("r-rating-change-on").addClass("r-rating-change-off").removeAttr("data-user-alert-id").data("user-alert-id",null):t&&t.enabled!==!1?n.addClass("r-selected").attr("aria-label",n.data("title-on")||"").attr("data-original-title",n.data("title-on")||"").attr("data-user-alert-id",t.userAlertId).data("user-alert-id",t.userAlertId):n.removeClass("r-selected").attr("aria-label",n.data("title-off")||"").attr("data-original-title",n.data("title-off")||"").removeAttr("data-user-alert-id").data("user-alert-id",null);this.alertableBusy(n,!1)},ratingInfoBind:function(t){var i=".r-rating:not(.r-binded)";(t?t.find(i):n(i)).addClass("r-binded").click(function(t){var u,r,f,i,e;if(t.preventDefault(),t.stopPropagation(),u=n(t.target).closest(".r-rating"),r=u.data("key"),!r){n.rat.alert("No rating key was found.");return}if(f=u.data("ratPopover"),f){f.hide();return}i=n.ratObjects.ratingDefinitions?n.ratObjects.ratingDefinitions[r]:null;e=u.ratPopover({autoShow:!0,destroyOnHide:!0,className:"r-rating-definition-popover",boundary:"window",onRender:function(t){if(i){t.append(n("<div class='r-title'>").text(i.title||"No Title")).append(n("<div class='r-content'>").html(i.content));return}t.ratBusy({fill:!0})},onShown:function(t){if(!i){var u=t.find(".r-container");n.ajax({url:ratQueryableApiUrl+"/field-information?n="+encodeURIComponent(r),method:"GET",success:function(t){t.info==null?i={title:T("Rating.Common|Not Found"),content:T("Rating.Common|The rating definition was not found.")+"<br/>"+r}:(n.ratObjects.ratingDefinitions||(n.ratObjects.ratingDefinitions={}),i={title:t.info[0],content:t.info[1]},n.ratObjects.ratingDefinitions[r]=i);u.append(n("<div class='r-title'>").text(i.title||T("Rating.Common|No Title"))).append(n("<div class='r-content'>").html(i.content));u.ratBusy(!1);e.updatePosition()},error:function(i){n.rat.handleError(i,$body);t.data("ratPopover").hide()}})}},onHidden:function(){}}).data("ratPopover")})},onTagsMoreClick:function(t){if(!ratHelpMode()){t.preventDefault();var i=this._$tags.find("> .r-more"),r=this._$tags.find("> .r-less");r.hasClass("r-hidden")?i.hasClass("r-filled")?(this._$tags.find("> .r-new-tags").removeClass("r-hidden"),i.addClass("r-hidden r-filled"),r.removeClass("r-hidden")):(i.ratBusy({fill:!0,inline:!0,message:""}),n.ajax({url:ratDataApiUrl+"/tags-more/"+encodeURIComponent(this._contentId),method:"GET",success:function(t){var f,u;if(!n.rat.handleError(T("Unable to retrieve more tags."),t)){for(f=[],u=0;u<t.length;u++){var e=t[u],o=n("<a class='r-tag r-new-tags' rel='tag'>").text(e.value).addClass("r-style-"+e.style).attr("href",ratSearchUrl+"?q=tags("+encodeURIComponent(e.value).replaceAll("%20","+")+")").css({display:"none"}),s=0;i.each(function(t,i){var r=s++==0?o:o.clone();f.push(r);n(i).before(r)})}n.each(f,function(n,t){t.fadeIn(250)});i.ratBusy(!1);i.addClass("r-hidden r-filled");r.removeClass("r-hidden")}},error:function(t){i.ratBusy(!1);n.rat.handleError(T("Unable to retrieve more tags."),t)}})):(i.removeClass("r-hidden"),r.addClass("r-hidden"),i.ratBusy(!1),this._$tags.find("> .r-new-tags").addClass("r-hidden"))}},signInBind:function(t){if(!n.rat.authenticated&&n("#r-sign-in-form").length!==0){var i=t?t.find(".r-sign-in:not(.r-binded)"):n(".r-sign-in:not(.r-binded)");i.addClass("r-binded").on("click",function(t){t.preventDefault();t.stopPropagation();n.ratObjects.PopoverGlobal.closeAll();n.rat.signInForm(t)})}},searchStart:function(t){var i;t&&t.preventDefault&&t.preventDefault();i=this;i._$quickSearch.trigger("rat.popover.hide");var f=i._$quickSearch.find("#r-quick-search-input").val().trim(),r=i._$quickSearch.find("#r-quick-search-area").val().trim(),u="q="+(r?"type("+n.rat.encodeURIComponent(r)+")+":"")+n.rat.encodeURIComponent(f);i.$body.find("> .r-search-body").length>0?window.history.replaceState(null,null,ratSearchUrl+"?"+u):(window.history.pushState(null,null,ratSearchUrl+"?"+u),i.navInit(),i.navSearch())},navInit:function(){window.ratNav||(window.ratNav={"/":{fn:n.proxy(this.navMain,this)}})},navSearch:function(){var e=this,u=this.$body,f=u.find("> main"),t=u.find("> .r-search-body"),r,i;t.length>0&&t.remove();n.ratObjects.PopoverGlobal.closeAll();n("#r-quick-search").removeClass("r-focus").fadeOut("fast",function(){n(document.body).addClass("r-search-bar-visible")});t=n("<div class='r-search-body r-init'>").insertAfter(f);t.ratBusy({fill:!0});f.addClass("d-none");t.removeClass("r-init");window.ratNav["/en/search"]||(window.ratNav["/en/search"]={fn:n.proxy(this.navSearch,this)});window.ratNav.currSelector=".r-search-body";r=function(){n.ajax({url:ratSearchApiUrl+"/view"+window.location.search,method:"GET",success:function(n){t.prepend(n);e.bodyChanged(t);t.ratBusy(!1)}})};window.kendo?r():(i=document.createElement("script"),i.setAttribute("src","/Ratings.Web.Core/scripts/kendo-ui/r-search.min.js?rv="+this.$body.data("r-kendo-version")),i.onload=function(){r()},document.body.appendChild(i))},navMain:function(){var t=n(window.ratNav.currSelector);t.remove();n(document.body).removeClass("r-search-bar-visible");n("#r-quick-search").css("display","flex").hide().fadeIn("normal");n(document.body).find("> main").removeClass("d-none");delete window.ratNav.currSelector},bodyChanged:function(t){this.bindContainer(t);n.rat.bodyChanged()},bindContainer:function(t,i,r){r=n.extend({},r||{});this.alertsBind(t);this.ratingInfoBind(t);this.signInBind(t);this.dateBind(t);this.logoBind(t);this.liveQuotesBind(t,i,r);(t?t.find(".r-click-add-class-parent:not(.r-click-add-class-parent-binded)"):n(".r-click-add-class-parent:not(.r-click-add-class-parent-binded)")).each(function(t,i){n(i).addClass("r-click-add-class-parent-binded").click(function(t){var i=n(t.target).ratFindIncludeSelf(".r-click-add-class-parent");i.parent().addClass(i.data("click-add-class"))})})},dateBind:function(t){var i=t?t.find(".r-date-est:not(.r-date-est-binded)"):n(".r-date-est:not(.r-date-est-binded)");i.each(function(t,i){var u=n(i),r=moment(u.data("date"));r.isValid()&&u.empty().addClass("r-date-est-binded").append(n("<span>").text(r.format(T("Ratings.Common|MMMM D, YYYY"))),n("<span class='r-time'>").text(r.format(T("Ratings.Common|hh:mm A"))))})},logoBind:function(t){var i=t?t.find(".r-crypto-logo:not(.r-binded)"):n(".r-crypto-logo:not(.r-binded)");i.each(function(t,i){var r=n(i);r.on("load",function(){r.parent().ratBusy(!1)}).on("error",function(){r.find("> img").attr("src",n.ratGlobal.cryptoDefaultImage);r.parent().ratBusy(!1)}).attr("src",r.data("logo"))})},onWindowScroll:function(){this.headerUpdate();this.stickyHeaderUpdate();n.rat.fireWindowViewportChanged();n.ratObjects._scrolled=!0},onWindowResize:function(){var t=this;setTimeout(function(){t.quickSearchResize();n.rat.fireWindowViewportChanged()},0)},liveQuotesBind:function(t,i,r){var f,h,e,u,l;r=n.extend({},r.liveQuotes||{});f=".r-live-quote";h=t?t.find(f):n(f);this._liveQuotes||(this._liveQuotes={});e={};u=this._liveQuotes.byTicker={};h.each(function(t,i){var h=n(i),o,f,s,c;(!r.inViewport||h.ratIsInViewport(0,!1))&&(o=h.data("quote-ticker"),f=h.data("quote-type"),typeof o=="string"&&o&&typeof f=="string"&&f)&&(s=u[o],s||(s=u[o]={}),f=f.toLocaleLowerCase(),c=s[f],c||(c=s[f]=[]),c.push(h),e[f]=!0)});var c=this,o=Object.keys(u).join("_"),s=Object.keys(e).join("_");if(!o||!s){delete this._liveQuotes;return}this._liveQuotes.tickers=o;this._liveQuotes.types=s;i===!0?l=n("<div class='r-live-quote-loader r-hidden'>").appendTo(document.body).attr("data-remote",!0).attr("data-remote-name","live-quotes").on("ratings-remote-setup",function(n){n.remoteData.tickers=o;n.remoteData.types=s}).on("ratings-remote-ready",function(n){l.remove();c.liveQuotesUpdate(n.remoteSuccess===!1||!n.remoteResult||!Array.isArray(n.remoteResult.quotes)?null:n.remoteResult.quotes)}):c.liveQuotesUpdate(0)},liveQuotesUpdate:function(t){var r,u,o,i,s,f,e,h,c;if(this._liveQuotes){if(Array.isArray(t)&&t)for(r=t.length-1;r>=0;r--)try{u=t[r];o=this._liveQuotes.byTicker[u.ticker];for(i in o)for(s=o[i],f=s.length-1;f>=0;f--)e=s[f],h=n.ratObjects.renders["quote-live-"+(e.data("quote-render")||i)],typeof h=="function"?h(e,u[i]):e.text(u[i])}catch(l){}c=typeof t=="number"?t:5e3;typeof this._liveQuotes.timerId=="number"&&clearTimeout(this._liveQuotes.timerId);this._liveQuotes.timerId=setTimeout(n.proxy(this.liveQuotesTimer,this),c)}},liveQuotesTimer:function(){if(this._liveQuotes){delete this._liveQuotes.timerId;this._liveQuotes._request&&(this._liveQuotes._request.abort("abort"),delete this._liveQuotes._request);var t=this;this._liveQuotes._request=n.ajax({url:ratDataApiUrl+"/live-quotes?y="+encodeURIComponent(this._liveQuotes.types)+"&t="+encodeURIComponent(this._liveQuotes.tickers),method:"GET",cache:!1,success:function(n){t.liveQuotesUpdate(n?n.quotes:null);delete t._liveQuotes._request},error:function(n){n&&n.statusText==="abort"||(t.liveQuotesUpdate(null),delete t._liveQuotes._request)}})}},speechkitReady:function(){n(".r-speechkit-container").css({display:"block"})}});n.fn.ratPage=function(){var i=n(this),t;return i.data("ratPage")?this:(t=i.data("page-type"),t=t&&typeof t=="string"?n.ratObjects["Rat"+t]||n.ratObjects["Rat"+t+"Page"]||n.ratObjects.RatPage:n.ratObjects.RatPage,i.data("ratPage",new t(i)),this)};n.ratObjects.startup.push({callback:function(){n(document.body).ratPage()},onBodyChange:!1});n.ratObjects.RatHomePage=n.ratObjects.RatPage.extend({init:function(t){n.ratObjects.RatPage.fn.init.call(this,t);this.$testimonial=n(".r-testimonials > .r-testimonial");this.$testimonialBar=n(".r-testimonials-container > .r-progress > .r-bar");this.testimonialVisible=0;this.testimonialInterval=5e3;this.nextTestimonial()},nextTestimonial:function(){var t=this;this.$testimonialBar.css({width:0}).animate({width:"100%"},t.testimonialInterval,"linear",function(){n(t.$testimonial[t.testimonialVisible]).fadeOut(100,function(){t.testimonialVisible++;t.testimonialVisible>=t.$testimonial.length&&(t.testimonialVisible=0);n(t.$testimonial[t.testimonialVisible]).hide().removeClass("r-hidden").fadeIn(200,function(){t.nextTestimonial()})})})}});i=n.ratObjects.Class.extend({init:function(t,i){this.$element=t;this.options=n.extend(i||{},{});this.$tabsContainer=t.find(".r-tabs-container");this.$tabsContainer.find("> .r-tab").each(function(t,i){n(i).data("tabIndex",t)});this.$tabsContainer.on("click","> .r-tab",n.proxy(this.onTabClick,this));if(this.sessionName=this.options.sessionName,typeof this.sessionName=="string"){var r=parseInt(sessionStorage.getItem(this.sessionName));typeof r!="number"||isNaN(r)||this.$tabsContainer.find("> .r-tab").each(function(t,i){r===t&&n(i).click()})}typeof this.options.tabIndex=="number"&&this.tabIndex(this.options.tabIndex)},onTabClick:function(t){var i=n(t.target).closest(".r-tab");if(!i.hasClass("r-active")){var u=this.$element.find(".r-tab-content."+i.data("tab")),r=this.$tabsContainer.find(".r-tab.r-active"),f=this.$element.find(".r-tab-content."+r.data("tab")),e={$newTab:i,$newTabContent:u,$oldTab:r,$oldTabContent:f};typeof this.options.onTabChanging=="function"&&this.options.onTabChanging.call(self,e);i.addClass("r-active");u.addClass("r-active");r.removeClass("r-active");f.removeClass("r-active");typeof this.options.onTabChanged=="function"&&this.options.onTabChanged.call(self,e);typeof this.sessionName=="string"&&sessionStorage.setItem(this.sessionName,i.data("tabIndex").toString())}},tabIndex:function(n){return typeof n!="number"?this.$tabsContainer.find("> .r-tab.r-active").data("tabIndex"):this.$tabsContainer.find("> .r-tab:ratData(tabIndex=="+n+")").click().data("tabIndex")}});n.fn.ratTabs=function(t){var r=this.data("ratTabs");return r?r:(this.each(function(){var u=n(this);r=new i(u,t);u.data("ratTabs",r)}),this)};n.ratObjects.PopoverGlobal={_all:[],_initPopoverCapture:!1,push:function(n){this._all.push(n);this._all.length===1&&document.body.classList.add("r-popover-visible")},remove:function(n){this._all.removeByValue(n);this._all.length===0&&document.body.classList.remove("r-popover-visible")},closeAll:function(){for(var t=this._all.length-1;t>=0;t--)this._all[t]instanceof n.ratObjects.Popover?this._all[t].hide(!1):this._all[t].trigger("rat.popover.hide",!0);this._all=[]},initPopoverCapture:function(){if(!this._initPopoverCapture){this._initPopoverCapture=!0;var t=this;n("html").on("mousedown",function(){n.ratObjects._scrolled=!1}).on("mouseup click",function(i){var f=new Date,u,r;if((!t._last||!(f-t._last<=100))&&(t._last=f,!n(document.body).hasClass("modal-open")&&!n(document.body).hasClass("r-popover-active"))){if(n.ratObjects._scrolled||t._all.length===0){n.ratObjects._scrolled=!1;return}(u=t._all[t._all.length-1],r=u instanceof jQuery?u.data("bs.popover"):u._$popover.data("bs.popover"),r.element.classList.contains("r-showing"))||r.element===i.target||r.tip===i.target||n.contains(r.element,i.target)||n.contains(r.tip,i.target)&&!i.target.classList.contains("r-close")||(r.tip.classList.add("r-closing"),n(r.element).trigger("rat.popover.hide"))}})}}};n.ratObjects.Popover=n.ratObjects.Class.extend({init:function(t,i){i=n.extend({onRender:this.onRender,exclusive:!0},i||{});this._$element=t;this._options=i;i.mode==="click"?this._modeClick():i.mode==="mouseTrack"&&this._modeMouseTrack()},getElement:function(){return this._$element},show:function(){var t,i,r;if(!this._popover){if(t=this,i=t.className(),i=typeof i=="string"&&i.length?" "+i:"",r=t._$element.data("bs.popover"),!r)t._$element.popover({trigger:"manual",boundary:this._options.boundary||"scrollParent",html:!0,sanitize:!1,template:'<div class="popover r-popover r-popover-init'+i+(t._options.className?" "+t._options.className:"")+'"><div class="arrow"><\/div><div class="popover-body"><\/div><\/div>',placement:this._options.placement||"bottom",content:function(){var i=n("<div class='r-container'>");typeof t._options.onRender=="function"&&t._options.onRender.call(t,i);i.find("> .r-menu").length===1&&n(this).data("bs.popover").tip.classList.add("r-is-menu");i.on("click",function(n){n.isDefaultPrevented()||t.stopMouseTracking()});return i}}).on("show.bs.popover",function(n){n.stopPropagation();setTimeout(function(){t._$element.removeClass("r-showing")},100)}).on("shown.bs.popover",function(n){n.stopPropagation()}).on("hidden.bs.popover",function(n){n.stopPropagation()}).on("rat.popover.hide",function(i){(i.stopPropagation(),t._popover)&&(typeof t._options.onHide=="function"&&t._options.onHide.apply(t,t._$element),t._$popover.addClass("r-popover-init"),t._hideCleanup(),t._$element.removeClass("r-active"),typeof t._options.onHidden=="function"&&t._options.onHidden.apply(t,t._$element),n.ratObjects.PopoverGlobal.remove(t))});this._options.exclusive&&n.ratObjects.PopoverGlobal.closeAll();typeof t._options.onShow=="function"&&t._options.onShow.call(t);t._$element.addClass("r-active r-showing").popover("show");t._popover=t._$element.data("bs.popover");t._$popover=n(t._popover.tip);setTimeout(function(){t._$popover&&t._$popover.removeClass("r-popover-init")},0);typeof t._options.onShown=="function"&&t._options.onShown.call(t,t._$popover);this._$popover.removeClass("r-closing").on("mouseleave",n.proxy(this._onMouseLeave,this));t._$element.is("[data-toggle='tooltip']")&&(t._$element.bstooltip("disable"),setTimeout(function(){t._$element.bstooltip("hide")},0));n.ratObjects.PopoverGlobal.push(this)}},hide:function(n){this._$element.trigger("rat.popover.hide",n!==!1)},updatePosition:function(){this._popover&&this._popover._popper.scheduleUpdate()},className:function(){return null},onRender:function(t){var r,i,f;if(Array.isArray(this._options.options)){var u=this,o=n("<ul class='r-menu r-menu-vertical'>").appendTo(t).on("click","> li > a",function(t){if(t.preventDefault(),typeof u._options.onOption=="function")u._options.onOption(n(t.target).closest("a").data("option"));u.hide()}),e=this._options.options;for(r=0;r<e.length;r++)i=e[r],f=n("<li>").appendTo(o).addClass("r-separator"),typeof i.cssClass=="string"&&f.addClass(i.cssClass),n("<a>").appendTo(f).html(i.text).data("option",i).attr("href",typeof i.href=="string"?i.href||"#":"#")}},element:function(){return this._$element},popoverElement:function(){return this._$popover},stopMouseTracking:function(){this._clicked=!0},_hideCleanup:function(){this._$element.popover("hide");this._options.destroyOnHide===!0&&(this._popover._popper.destroy(),this._$element.data("ratPopover",null),this._$element.data("bs.popover",null));delete this._popover;delete this._$popover;delete this._clicked;this._$element.is("[data-toggle='tooltip']")&&this._$element.bstooltip("enable")},_modeClick:function(){var n=this;this._$element.on("click",function(t){ratHelpMode()&&n._$element.hasClass("r-help-term")||(t.preventDefault(),t.stopPropagation(),typeof n._options.onElementClick!="function"||n._options.onElementClick.call(this,n._$element)!==!1)&&(n._clicked=!0,n.show())})},_modeMouseTrack:function(){var t=this;this._$element.on("click",function(n){ratHelpMode()&&t._$element.hasClass("r-help-term")||(n.preventDefault(),n.stopPropagation(),typeof t._options.onElementClick!="function"||t._options.onElementClick.call(this,t._$element)!==!1)&&(t._clicked=!0,t.show())}).on("mouseenter",function(){ratHelpMode()&&t._$element.hasClass("r-help-term")||t.show()}).on("mouseleave",n.proxy(this._onMouseLeave,this))},_onMouseLeave:function(){if((!ratHelpMode()||!this._$element.hasClass("r-help-term"))&&this._clicked!==!0&&this._options.mode==="mouseTrack"){var n=this;setTimeout(function(){!n._$popover||n._$popover.is(":hover")||n._$element.is(":hover")||n.hide()},300)}}});n.fn.extend({ratPopover:function(t,i){return n.ratObjects.PopoverGlobal.initPopoverCapture(),this.each(function(){var u=n(this),r=u.data("ratPopover"),f;if(!r){if(typeof t=="string")return;f=n.ratObjects["Popover"+i]||n.ratObjects.Popover;u.data("ratPopover",r=new f(u,t))}t&&typeof t=="string"?r[t]():t&&t.autoShow===!0&&r.show()})}});n.ratObjects.RatHelpTerm=n.ratObjects.Class.extend({init:function(n,t){this.$element=n;this.helpManager=t;var i=n.data("help-selector");this.$help=i&&typeof i=="string"?n.find(i):n},show:function(t){if(!this.isActive()){var i=this.$help;if(!i||!i.length){n.rat.alert("The specified help selector is invalid.");return}if(!this.getId()){n.rat.alert("Help id was not found.");return}if(!this.getArea()){n.rat.alert("Help area was not found.");return}(i.bstooltip("hide"),i.hasClass("r-help-active"))||(i.addClass("r-help-active"),this.onShowHelp(t).done(function(){i.removeClass("r-help-active")}))}},isActive:function(){return this.$help.hasClass("r-help-active")},getHelpManager:function(){return this.helpManager?this.helpManager:(this.helpManager=n(".r-help-manager").data("ratHelp")||null,this.helpManager)},getArea:function(){return this._area?this._area:(this._area=this.$help.data("help-area"),this._area&&typeof this._area=="string"||(this._area=this.$help.closest("[data-help-area]").data("help-area"),this._area&&typeof this._area=="string"||(this._area=null)),this._area)},getId:function(){return this._helpId?this._helpId:(this._helpId=this.$help.data("help-id"),typeof this._helpId=="string"&&(this._helpId=this._helpId.toLocaleLowerCase()),this._helpId||(this._helpId=this.$help.data("help-id")))},getArg:function(){return this._helpArg||(this._helpArg=this.$help.data("help-arg"))},getTitle:function(){return this._helpTitle||null},setTitle:function(n){this._helpTitle=n},getContent:function(){return this._helpContent||null},setContent:function(n){this._helpContent=n},fetchHelp:function(){var t=n.Deferred(),i=this.getArea();return i?(n.ajax({url:ratDataApiUrl+"/help/"+encodeURIComponent(i)+"/"+encodeURIComponent(this.getId())+"/"+(this.getArg()||""),method:"GET",cache:typeof this.cacheRequests=="boolean"?this.cacheRequests:!0,success:function(n){t.resolve(n.title,n.description)},error:function(n){t.reject(n)}}),t.promise()):(n.rat.alert("Help area was not found."),t)},onShowHelp:function(){var t,r,i,u;if(this._deferred)throw"Method already called";return t=this,r=this.$help,this._deferred=n.Deferred(),i=r.data("ratPopover"),i&&!i._ratHelpPopover&&(r.data("ratPopover.original",i),r.removeData("ratPopover"),i=r.data("bs.popover"),i&&(r.data("bs.popover.original",i),r.removeData("bs.popover")),i=null,u=this.getHelpManager(),u&&u.registerPopoverElement(r)),i||(i=r.ratPopover({className:"r-help-popover",onRender:function(i){if(t._helpContent){i.append(n("<div class='r-title'>").text(t._helpTitle||"No Title")).append(t._helpContent);return}i.ratBusy({fill:!0,inline:!0})},onShown:function(r){if(!t._helpContent){var u=r.find(".r-container");u.css("min-height",u.outerHeight()+"px");t.fetchHelp().done(function(r,f){t._helpTitle=r;t._helpContent=f;u.append(n("<div class='r-title'>").text(t._helpTitle||"No Title")).append(f);i.updatePosition();u.ratBusy(!1)}).fail(function(t){u.ratBusy(!1);n.rat.handleError(t,u)})}},onHidden:function(){t._deferred&&(t._deferred.resolve(),delete t._deferred)}}).data("ratPopover"),i._ratHelpPopover=!0),n.ratObjects.PopoverGlobal.closeAll(),setTimeout(function(){i.show()},0),t._deferred.promise()},bind:function(){var n=this;this.$element.click(function(t){t.preventDefault();t.stopPropagation();n.show(t)})}});n.ratObjects.RatHelpManager=n.ratObjects.Class.extend({init:function(t){this.$element=t;this._info=null;var i=this;t.on("click",function(t){t.preventDefault();i.isActive()?i.deactivate():i.activate();n(t.target).closest(".r-help-manager").bstooltip("hide")});n(document.body).on("show.bs.tooltip",function(t){return ratHelpMode()?(n(t.target).bstooltip("hide"),t.preventDefault(),!1):!0})},isActive:function(){return this.$element.hasClass("r-active")},activate:function(){this.infoLoad();this.showIntro();n(document.body).addClass("r-help-mode");this.$element.addClass("r-active");this.bindContainer(null)},deactivate:function(){var r,t,i;if(this._popoverElements)for(r=0;r<this._popoverElements.length;r++)t=this._popoverElements[r],i=t.data("ratPopover.original"),i?t.data("ratPopover",i):t.removeData("ratPopover"),t.removeData("ratPopover.original"),i=t.data("bs.popover.original"),i?t.data("bs.popover",i):t.removeData("bs.popover"),t.removeData("bs.popover.original");n(document.body).removeClass("r-help-mode");this.$element.removeClass("r-active").trigger({type:"ratings-help-mode",helpMode:!1});this._$terms.removeClass("r-help-binded").data("r-callback",null).not(".r-uses-callback").off("click",this._onClickProxy);this._$dynamicSymbols.find("> .r-help-symbol").remove();delete this._popoverElements;delete this._onClickProxy;delete this._$terms;delete this._$dynamicSymbols},bindContainer:function(t){var u,i,r;if(ratHelpMode()&&(t?t.trigger({type:"ratings-help-mode",helpMode:!0}):this.$element.trigger({type:"ratings-help-mode",helpMode:!0}),u=".r-help-term:not(.r-help-binded)",i=(t?t.find(u):n(u)).addClass("r-help-binded"),i.length!==0)){this._onClickProxy||(this._onClickProxy=n.proxy(this.onClick,this));i.data("r-callback",this._onClickProxy).not(".r-uses-callback").on("click",this._onClickProxy);r=i.filter(".r-help-symbol-dynamic");r.each(function(t,i){n(i).append(n("<span class='r-help-symbol'>"))});this._$terms?(this._$terms=this._$terms.add(i),this._$dynamicSymbols=this._$dynamicSymbols.add(r)):(this._$terms=i,this._$dynamicSymbols=r)}},infoLoad:function(){try{this._info=JSON.parse(localStorage.getItem("r-help"));this._info||(this._info={})}catch(n){this._info={}}this._info.intro===undefined&&(this._info.intro={intro:!0})},infoSave:function(){localStorage.setItem("r-help",JSON.stringify(this._info))},showIntro:function(){if(this._info.intro===!0&&this.$element.data("intro-shown")!==!0){var r=this.$element.data("intro"),i=this,u,t,f=n("<div class='modal fade r-modal' tabindex='-1' role='dialog' aria-hidden='true'>").append(n("<div class='modal-dialog modal-dialog-centered' role='document'>").append(n("<div class='modal-content'>").append(n("<div class='modal-header'>").append(n("<h1 class='modal-title'>").text(T("Contextual Help")),n("<button type='button' class='close' data-dismiss='modal' aria-label='Close'><span aria-hidden='true'>&times;<\/span><\/button>")),t=n("<div class='modal-body' style='min-height:5rem;'>"),n("<div class='modal-footer'>").append(n("<div class='r-left'>").append(u=n("<input id='__DontShowAgain' name='__DontShowAgain' type='checkbox'>"),n("<label for='__DontShowAgain'>").text(T("Don't show this message again"))),n("<button type='button' class='btn btn-link' data-dismiss='modal'>").text(T("Close")))))).on("shown.bs.modal",function(){r||n.ajax({url:ratDataApiUrl+"/help-intro",method:"GET",success:function(n){i.$element.data("intro-shown",!0);i.$element.data("intro",n);t.ratBusy(!1);t.prepend(n)},error:function(i){t.ratBusy(!1);n.rat.handleError(i,t)}})}).on("hidden.bs.modal",function(){u.prop("checked")&&(i._info[i._area].intro=!1,i.infoSave());n(this).remove()});r?(t.append(r),this.$element.data("intro-shown",!0)):t.ratBusy();f.modal({backdrop:"static",keyboard:!1,show:!0})}},onClick:function(t){var i,r;(t.preventDefault(),t.stopPropagation(),i=n(t.target).closest(".r-help-term"),i.hasClass("r-help-ignore"))||(r=i.data("r-help-term"),r||i.data("r-help-term",r=new n.ratObjects.RatHelpTerm(i,this)),r.show(t))},registerPopoverElement:function(n){this._popoverElements||(this._popoverElements=[]);this._popoverElements.push(n)}});n.fn.ratHelp=function(t,i){if(typeof t=="string"&&t==="bind-container"){if(!ratHelpMode())return this;var r=n(".r-help-manager").data("ratHelp");return this.each(function(){r.bindContainer(n(this))}),this}return this.each(function(){var r=n(this),u;(u=r.data("ratHelp"))||(r.hasClass("r-help-term")?r.data("ratHelp",u=new n.ratObjects.RatHelpTerm(r)):r.data("ratHelp",u=new n.ratObjects.RatHelpManager(r)));typeof t=="string"&&typeof u[t]=="function"&&u[t](i)}),this};t=n.ratQueryable={common:{ratingRankLast:15},fn:{initRatings:function(){var n;if(!t.common.ratings){var r=t.common.ratingsByRank={},u=t.common.ratingsNorm={},i=t.common.ratings=[{rating:"A+",rank:1},{rating:"A",rank:2},{rating:"A-",rank:3},{rating:"B+",rank:4},{rating:"B",rank:5},{rating:"B-",rank:6},{rating:"C+",rank:7},{rating:"C",rank:8},{rating:"C-",rank:9},{rating:"D+",rank:10},{rating:"D",rank:11},{rating:"D-",rank:12},{rating:"E+",rank:13},{rating:"E",rank:14},{rating:"E-",rank:15},{rating:"F",rank:16},{rating:"U",rank:17}];for(n=0;n<i.length;n++)r[i[n].rank]=i[n],u[i[n].rating.toLocaleUpperCase()]=i[n]}}}};n.ratObjects.PopoverSelect=n.ratObjects.Popover.extend({init:function(t,i){for(var u=i.items,r=0;r<u.length;r++)typeof u[r].value=="string"&&(u[r].valueNorm=u[r].value.toLocaleLowerCase());n.ratObjects.Popover.fn.init.call(this,t,i)},className:function(){return"r-popover-select"},onRender:function(t){var e=n("<div class='r-list'>").appendTo(t),u=this._options.items,f,i,r;if(!Array.isArray(u)||u.length===0){n("<div class='r-empty'>").html(this._options.emptyMessage||T("Ratings.Common|No items to display.")).appendTo(e);return}for(f=0;f<u.length;f++)i=u[f],r=n("<div class='r-item'>").data("ratItem",i).append("<span class='r-checkbox'>").append(n("<span class='r-text'>").text(i.text)).appendTo(e),i.$element=r,i.separator===!0&&r.addClass("r-separator"),typeof i.cssClass=="string"&&r.addClass(i.cssClass),typeof i.indent=="number"&&r.css({"padding-left":i.indent+1+"em"}),i.selected&&r.addClass("r-selected");e.on("click",".r-item",n.proxy(this.onItemClick,this))},forEachSelected:function(n){var i,t;if(typeof n=="function")for(i=this._options.items,t=0;t<i.length;t++)!i[t].selected||i[t].isAll||i[t].isGroup||n(i[t])},getAllItem:function(){for(var t=this._options.items,n=0;n<t.length;n++)if(t[n].isAll)return t[n];return undefined},getItem:function(n){var i,t;if(n instanceof jQuery)n=n.data("ratItem");else if(typeof n=="string"){for(n=n.toLocaleLowerCase(),i=this._options.items,t=0;t<i.length;t++)if(n===i[t].valueNorm){n=i[t];break}typeof n=="string"&&(n=null)}return!n||typeof n!="object"?null:n},isSelected:function(n){return n=this.getItem(n),n?n.selected===!0:undefined},isAnySelected:function(){for(var t=this._options.items,n=0;n<t.length;n++)if(t[n].selected&&!t[n].isAll&&!t[n].isGroup)return!0;return!1},selectToggle:function(n){return(n=this.getItem(n),!n)?undefined:this.select(n,!n.selected)},select:function(n,t){if(typeof t!="boolean")return n.selected;if(n=this.getItem(n),!n)return undefined;if(n.selected===t)return t;if(n.$element&&n.$element[t?"addClass":"removeClass"]("r-selected"),n.selected=t,!this._selecting)this.onChanged(n);return t},beginSelect:function(){for(var t=this._options.items,n=0;n<t.length;n++)t[n].selected=!1;this._selecting=!0},endSelect:function(){this._selecting=!1;this.onChanged()},IsItemsSelected:function(){for(var n,i=this._options.items,t=0;t<i.length;t++)if(n=i[t],!n.isAll&&!n.isGroup&&!n.selected)return!1;return!0},ItemsSelectedCount:function(){for(var n,i=0,r=this._options.items,t=0;t<r.length;t++)n=r[t],n.isAll||n.isGroup||!n.selected||i++;return i},groupItems:function(n){var i,r,t,u;if(typeof n!="string")return undefined;for(i=[],r=this._options.items,t=0;t<r.length;t++)u=r[t],u.group===n&&i.push(u);return i},IsGroupItemsSelected:function(n){var i,t,r;if(n&&typeof n=="object"&&typeof n.value=="string"&&(n=n.value),typeof n!="string")return undefined;for(i=this._options.items,t=0;t<i.length;t++)if(r=i[t],r.group===n&&!r.selected)return!1;return!0},updateItems:function(){this.onChanged()},onItemClick:function(t){var i=this;if(this.userChanged=!0,this._options.multiselect!==!0){if(this.isSelected(n(t.target).closest(".r-item"))){this.hide();return}this.forEachSelected(function(n){i.select(n,!1)})}this.selectToggle(n(t.target).closest(".r-item"));this._options.closeOnSelect===!0&&setTimeout(function(){i.hide()},100)},onChanged:function(n){var r,i,t,f,e,u;if(!this._changedLocked){if(this._changedLocked=!0,r=this._options.items,n)if(n.isAll)for(n.selected||this._options.allowNone!==!1||this.select(n,!0),t=0;t<r.length;t++)this.select(r[t],n.selected);else if(n.isGroup)for(f=this.groupItems(n.value),t=0;t<f.length;t++)this.select(f[t],n.selected);else typeof n.group=="string"&&(e=this.getItem(n.group),e&&this.select(e,this.IsGroupItemsSelected(n.group)));if(this._options.allowNone===!1&&this.ItemsSelectedCount()===0)for(t=0;t<r.length;t++)this.select(r[t],!0);if(u=this.getAllItem(),this.IsItemsSelected())for(t=0;t<r.length;t++)i=r[t],(i.isAll||i.isGroup&&!i.selected)&&this.select(i,!0),i.$element&&i.$element[i.selected?"addClass":"removeClass"]("r-selected");else for(u&&this.select(u,!1),t=0;t<r.length;t++)i=r[t],i.isGroup&&this.select(i,this.IsGroupItemsSelected(i)),i.$element&&i.$element[i.selected?"addClass":"removeClass"]("r-selected");this._updateElement();u&&u.selected&&delete this.userChanged;delete this._changedLocked;typeof this._options.onChanged=="function"&&this._options.onChanged.call(this,n);this.element().trigger("rat.changed",n);this._popover&&this._popover._popper.scheduleUpdate()}},_updateElement:function(){var i=this._options.updateElement,r;if(i instanceof jQuery)if(r=this.getAllItem(),r&&r.selected)i.text(r.text),i.attr("title",r.text);else if(this.isAnySelected()){for(var t=this._options.items,u=[],f={},n=0;n<t.length;n++)t[n].selected&&t[n].isGroup&&(f[t[n].value]=!0,u.push(t[n].text));for(n=0;n<t.length;n++)!t[n].selected||t[n].isGroup||f[t[n].group]||u.push(t[n].text);u.sort();u=u.join(this._options.textSeparator||", ");i.text(u);i.attr("title",u)}else i.text(r.text),i.attr("title",r.text)}});t.PopoverNavigation=n.ratObjects.Class.extend({init:function(t,i){this.popover=t;this.$container=i;this.$navigation=n("<div class='r-popover-navigation'>").appendTo(i)},hide:function(){this.popover.hide()},newPanel:function(t,i,r){var u=n("<div class='r-panel'>").appendTo(this.$navigation),f;return typeof t=="string"&&t&&(f=this,i||i===!1||(i=T("Ratings.Common|Cancel")),n("<div class='r-header'>").append(n("<div class='r-title'>").html(t),n("<div class='r-commands'>").append(typeof i=="string"?n("<span class='btn btn-light'>").html(i).click(function(){f.pop(u,r)}):null)).appendTo(u.addClass("r-has-header"))),u.addClass("r-hidden")},push:function(n){this.$navigation.find("> .r-panel").addClass("r-hidden");n.index()===0?n.removeClass("r-hidden"):n.removeClass("r-hidden").hide().fadeIn(200,function(){});this.popover.updatePosition()},pop:function(t,i){var r,u,f;if(t===!0&&(t=this.$navigation.find("> .r-panel:nth-child(2)")),typeof i=="function"&&i.fn.call(this,t),r=this.$navigation.find("> .r-panel"),t||(t=n(r[r.length-1])),u=t.index(),!(u<=0)){for(f=u;f<r.length;f++)n(r[f]).remove();n(r[u-1]).removeClass("r-hidden").hide().fadeIn(200);this.popover.updatePosition()}}});t.FieldInfo=n.ratObjects.Class.extend({init:function(n,t){this.builder=n;this.field=t;this.isLiveQuotes=t.attributes["live-quotes"]===!0},createFilter:function(n,i){return new t.Filter(this,n,i)},attributeString:function(n,t){var i=this.field.attributes[n];return typeof i=="string"?i:typeof t=="string"?t:null},attributeInt:function(n,t){var i=this.field.attributes[n];return typeof i=="string"&&(i=parseInt(i)),(isNaN(i)||typeof i!="number")&&(i=typeof t=="number"?t:null),i},attributeBool:function(n,t){var i=this.field.attributes[n];return typeof i=="boolean"?i:typeof t=="boolean"?t:null}});t.Filter=n.ratObjects.Class.extend({init:function(n,t,i){this.fieldInfo=n;this.builder=n.builder;this.field=n.field;this.$filter=t;this.options=i||{}},isEmpty:function(){return!0},render:function(){var t=n("<span class='r-container'>").append(n("<span class='r-caption'>").text(this.field.attributes["pill-text"]||this.field.displayName));this.needsUserKey()&&!n.rat.authenticated?t.addClass("r-sign-in").find("> .r-caption").text(T("Ratings.Queryable|Sign In")):this.options.hasValue&&n("<span class='r-value'>").appendTo(t);this.$filter.append(t,n("<span class='r-remove'>"));this.options.hasValue&&this.valueRender();this.validate();this._loading&&(t.find(".r-value,.r-operator").hide(),t.ratBusy({inline:!0}))},loading:function(n){this._loading=n===!0;var t=this.$filter.find(".r-container");if(n===!1){this.options.hasValue&&this.valueRender();t.find(".r-value,.r-operator").show();t.ratBusy(!1);this.$filter.removeClass("r-is-busy");this._needsOpen===!0&&(delete this._needsOpen,this.open());return}t.find(".r-value,.r-operator").hide();t.ratBusy({inline:!0});this.$filter.addClass("r-is-busy")},open:function(){var t,i;if(this._loading){this._needsOpen=!0;return}if(this.needsUserKey()&&!n.rat.authenticated){n.rat.signInForm();return}t=this;this._editorVisible=!0;i=this.popoverClassName();this.$filter.ratPopover({autoShow:!0,className:"r-popover-queryable"+(i?" "+i:""),onRender:function(n){t._$editorElement=n;t.editorRender(n)},onShown:function(){t.onEditorShown()},onHidden:function(){delete t._$editorElement;t._editorVisible=!1;t.onEditorHidden()}})},popover:function(){return this.$filter.data("ratPopover")},popoverUpdatePosition:function(){var n=this.popover();n&&n.updatePosition()},editorElement:function(){return this._$editorElement||null},editorRender:function(t){n("<div class='alert alert-danger'>").text("No editor defined.").appendTo(t)},onEditorShown:function(){},onEditorHidden:function(){},onRemoving:function(){this._editorVisible===!0&&this.$filter.data("ratPopover").hide()},onChanged:function(){this.valueRender();this.validate();this.popoverUpdatePosition();this.builder.onFilterChanged(this)},popoverClassName:function(){return null},valueRender:function(){this.empty()},empty:function(n){if(n!==!1&&(n=!0),this._emptyUpdating!==n){if(this._emptyUpdating=n,n){var t=this.field.attributes["filter-none"];this.$filter.find(".r-value").text(t||T("Ratings.Common|--")).addClass("r-empty")[t?"addClass":"removeClass"]("r-empty-custom");this.$filter.addClass("r-is-empty")}else this.$filter.find(".r-value").removeClass("r-empty"),this.$filter.removeClass("r-is-empty"),this.valueRender();delete this._emptyUpdating}},unavailable:function(){return this.$filter.hasClass("r-unavailable")},validate:function(){},invalid:function(n){return n&&typeof n=="string"?(this.$filter.addClass("r-invalid"),this.$filter.attr("title",n),!0):n===!1?(this.$filter.removeClass("r-invalid"),this.$filter.attr("title",null),!1):this.$filter.hasClass("r-invalid")},queryableName:function(){var n=this.field.queryableName;return n.substring(0,1).toLocaleLowerCase()+n.substring(1)},queryFilter:function(){},needsUserKey:function(){return this.field.attributes["needs-user-key"]===!0}});t.FieldInfoRating=t.FieldInfo.extend({createFilter:function(n,i){return new t.FilterRating(this,n,i)},getDisplayValue:function(t){var i=this.field.resultName;return i!=="rating"&&i!=="cryptoRating"&&i!=="investmentRating"&&i!=="safetyRating"?typeof t[i]!="string"?n("<span class='r-rating-plain-wrap r-none'>").text(T("Ratings.Common|--")).ratOuterHTML():n("<div class='r-rating-plain-wrap'>").text(t[i]).ratOuterHTML():!t.providerName||!this.field.providerNames.includes(t.providerName)?n("<span class='r-empty'>").append(T("Rating.Common|--")).ratOuterHTML():typeof t.rating!="string"?n("<span class='r-empty'>").append(T("Rating.Common|--")).ratOuterHTML():n("<div class='r-rating-wrap r-small'>").append(n.ratObjects.renders.ratingChange(t.contentId),n.ratObjects.renders.rating(t),n.ratObjects.renders.ratingRecentChange(t)).ratOuterHTML()}});t.FilterRating=t.Filter.extend({init:function(n,i,r){t.Filter.fn.init.call(this,n,i,{hasValue:!0});t.fn.initRatings();this.selected=[];this.queryFilterParse(r);this.selected.sort(function(n,t){return n-t});this.updateIsRange()},isEmpty:function(){return this.selected.length===0},editorRender:function(i){for(var u=n("<div class='r-ratings'>").appendTo(i),f=t.common.ratings,r=0;r<f.length;r++)u.append(this.ratingElement(t.common.ratings[r]));u.on("click",".r-rating-wrap",n.proxy(this.onRatingClick,this))},popoverClassName:function(){return"r-popover-rating"},ratingElement:function(t){var i=n("<span class='r-rating-wrap'>").append(n.ratObjects.renders.rating(t.rating)).addClass("r-large").data("ratRank",t.rank.toString());return this.selected.includes(t.rank)&&i.addClass("r-selected"),i},onRatingClick:function(t){var u=n(t.target).closest(".r-rating-wrap"),r=parseInt(u.data("ratRank")),o=u.hasClass("r-selected"),f=this.editorElement(),i;if(t.ctrlKey)o?this.selected.removeByValue(r):this.selected.push(r),u[o?"removeClass":"addClass"]("r-selected"),f.find(".r-rating-wrap.r-selecting").removeClass("r-selecting"),delete this.rangeMode;else if(this.rangeMode){var e=this.selected[0],s=Math.min(r,e),h=Math.max(r,e);for(f.find(".r-rating-wrap.r-selecting").removeClass("r-selecting"),i=s;i<=h;i++)e!==i&&(f.find(".r-rating-wrap:ratData(ratRank=="+i+")").addClass("r-selected"),this.selected.push(i));delete this.rangeMode}else this.selected.length=0,f.find(".r-rating-wrap").removeClass("r-selected").addClass("r-selecting"),this.selected.push(r),u.addClass("r-selected"),this.rangeMode=!0;this.onChanged()},onEditorHidden:function(){t.Filter.fn.onEditorHidden.call(this);delete this.rangeMode;this.valueRender()},onChanged:function(){this.selected.sort(function(n,t){return n-t});this.updateIsRange();t.Filter.fn.onChanged.call(this)},valueRender:function(n){var u,i,r,f,e;if(!this._valueRenderUpdating){if(this._valueRenderUpdating=!0,n&&n.length||(n=this.$filter.find(".r-value")),u=t.common.ratingsByRank,i="",this.selected.length===0)this.empty();else if(this.selected.length===1)i=u[this.selected[0]].rating,this.rangeMode&&(i+=" &#8211; ?"),n.html(i).removeClass("r-empty");else if(this.selected.length===t.common.ratings.length&&this.selected[this.selected.length-1]-this.selected[0]+1===t.common.ratings.length)this.empty(!1),n.text(T("Ratings.Common|All"));else{if(this._isRange&&this.selected.length>2){if(f=this.selected[0],e=this.selected[this.selected.length-1],f<=t.common.ratingRankLast&&(i=f===Math.min(e,t.common.ratingRankLast)?u[f].rating:u[f].rating+" &#8211; "+u[Math.min(e,t.common.ratingRankLast)].rating),e>t.common.ratingRankLast)for(r=t.common.ratingRankLast+1;r<=e;r++)i+=(i.length?", ":"")+u[r].rating}else for(r=0;r<this.selected.length;r++)i+=(i.length?", ":"")+u[this.selected[r]].rating;this.empty(!1);n.html(i)}delete this._valueRenderUpdating}},updateIsRange:function(){var t,i,n,r;if(this.selected.length<=1)return this._isRange=!1;for(t=!0,i=this.selected[0]-1,n=0;n<this.selected.length;n++)if(i++,r=this.selected[n],r!==i){t=!1;break}return this._isRange=t},queryFilter:function(){var i=this.queryableName(),n,o,u,r,f,e;if(this.selected.length===0)return i+"()";if(n=t.common.ratingsByRank,this.selected.length===1)return i+"(#"+n[this.selected[0]].rating+")";if(o=t.common.ratingsNorm,this._isRange)return(u=this.selected[0],r=this.selected[this.selected.length-1],o["A+"].rank===u&&r===t.common.ratingRankLast)?i+"(<>"+n[u].rating+","+n[r].rating+")":o["A+"].rank===u&&r<=t.common.ratingRankLast?i+"(>>"+n[r].rating+")":r===t.common.ratingRankLast?i+"(<<"+n[u].rating+")":i+"(<>"+n[u].rating+","+n[r].rating+")";for(f="",e=this.selected.length-1;e>=0;e--)f+=(f.length===0?"":",")+n[this.selected[e]].rating;return i+"(#"+f+")"},queryFilterParse:function(n){var c=t.common.ratingRankLast,i,f,s,a,e,h,v,y;if(typeof n!="string"||!n){for(i=1;i<=c;i++)this.selected.push(i);return}var r=t.common.ratings,p=t.common.ratingsNorm,u,o,l=/\s*([><!#])*([=<>])/gm;for(l.exec(n)?(u=n.substring(0,l.lastIndex),o=n.substring(l.lastIndex,n.length).split(",")):(u="=",o=n.split(",")),f=[],i=0;i<o.length;i++)if(s=o[i].trim(),s.length){if(a=p[s.toLocaleUpperCase()],!a)throw"Invalid rating '"+s+"'.";f.push(a)}if(e=f[0].rank,u===">="||u===">>")for(i=0;i<r.length;i++)r[i].rank<=e&&!this.selected.includes(r[i].rank)&&this.selected.push(r[i].rank);else if(u===">")for(i=0;i<r.length;i++)r[i].rank<e&&!this.selected.includes(r[i].rank)&&this.selected.push(r[i].rank);else if(u==="<="||u==="<<")for(i=0;i<r.length;i++)r[i].rank>=e&&r[i].rank<=c&&!this.selected.includes(r[i].rank)&&this.selected.push(r[i].rank);else if(u==="<")for(i=0;i<r.length;i++)r[i].rank>e&&r[i].rank<=c&&!this.selected.includes(r[i].rank)&&this.selected.push(r[i].rank);else if(u==="="||u==="#")for(i=0;i<r.length;i++)for(h=0;h<f.length;h++)r[i].rank!==f[h].rank||this.selected.includes(r[i].rank)||this.selected.push(r[i].rank);else if(u==="<>"){if(f.length<2)throw"Invalid between values, expected '{min},{max}'.";for(v=Math.min(f[0].rank,f[1].rank),y=Math.max(f[0].rank,f[1].rank),i=0;i<r.length;i++)r[i].rank>=v&&r[i].rank<=y&&this.selected.push(r[i].rank)}}});t.FieldInfoMultiselect=t.FieldInfo.extend({init:function(n,i){var u,f,r;if(t.FieldInfo.fn.init.call(this,n,i),u=this.attributeString("multiselect-values"),u){this.values=[];f=/([^=]*)[=]([^;]*)[;]?/gm;do r=f.exec(u),r&&this.values.push({text:r[1].trim(),value:r[2].trim()});while(r);this.values.length>0&&(this.customValues=!0)}},createFilter:function(n,i){return new t.FilterMultiselect(this,n,i)},getDisplayValue:function(t){var i=t[this.field.resultName],r;if(i===undefined||i===null)return n("<span class='r-empty'>").text(T("Rating.Common|--")).ratOuterHTML();if(!this.valuesDict&&this.values&&this.values.length>0)for(this.valuesDict={},r=this.values.length-1;r>=0;r--)this.valuesDict[this.values[r].value]=this.values[r].text;return this.valuesDict&&(i=this.valuesDict[i],i===undefined||i===null)?n("<span class='r-empty'>").text(T("Rating.Common|--")).ratOuterHTML():i}});t.FilterMultiselect=t.Filter.extend({init:function(n,i,r){var f,e,u;if(t.Filter.fn.init.call(this,n,i,{hasValue:!0}),this._searchable=n.attributeBool("multiselect-searchable",!1),this._needsLoading=!this._searchable||n.attributeBool("multiselect-needs-loading",!1),this._showTabs=n.attributeBool("multiselect-show-tabs",!0),this._remote=n.attributeString("multiselect-remote")||n.field.queryableName,this._max=n.attributeInt("multiselect-max",null),this._maxMessage=n.attributeString("multiselect-max-message"),this._emptyMessage=n.attributeString("multiselect-empty-message")||T("Ratings.Common|No items to display."),this._noneMessage=n.attributeString("multiselect-none-message")||this._emptyMessage,this._loadAll=n.attributeBool("multiselect-load-all",!1),this._data=this.fieldInfo.values,f=n.attributeString("multiselect-presets"),f){this.presets=[];e=/([^=]*)[=]([^;]*)[;]?/gm;do u=e.exec(f),u&&this.presets.push({text:u[1].trim(),value:u[2].trim(),preset:!0});while(u);this.presets.length===0&&delete this.presets}this._fetching=0;this.selected=[];this.selectedByValue={};this.queryFilterParse(r)},isEmpty:function(){return this.selected.length===0&&(!this._values||this._values.length===0)},popoverClassName:function(){return"r-popover-multiselect"},editorRender:function(t){var i,r,u;this._showTabs?(r=n("<div class='r-tabs-container'>").appendTo(t).on("click","> .r-tab",n.proxy(this.onTabClick,this)),this.$tabSearch=n("<div class='r-tab r-active' data-tab='r-tab-all'>").text(T("Ratings.Common|All")).appendTo(r),this.$tabSelected=n("<div class='r-tab' data-tab='r-tab-selected'>").text(T("Ratings.Common|Selected")).appendTo(r),u=n("<div class='r-tabs-content'>").appendTo(t),this.$tabSearchContent=n("<div class='r-tab-content r-tab-all r-active'>").appendTo(u),this.$tabSelectedContent=n("<div class='r-tab-content r-tab-selected'>").appendTo(u),i=this.$tabSearchContent):i=t;this._data&&this._data.length||(this._searchText="");this._searchable&&(this.$searchInput=n("<input type='text'>").attr("placeholder",T("Ratings.Common|Search")).val(this._searchText||"").ratInputAutoChange(n.proxy(this.onSearch,this)),n("<div class='r-search'>").append(this.$searchInput).appendTo(i),i.addClass("r-searchable"));this.$list=n("<div class='r-list'>").on("click",".r-item",n.proxy(this.onItemClick,this)).appendTo(i);this._data&&this._dataReady?this.listRender():this.fetch()},listRender:function(){var r=this.$list,o,e,t,f,i,u;if(r){if(this.maxMessage(!1),r.ratEmpty(),this._data.length===0){o=!this.$searchInput||this.$searchInput.val().trim().length===0;n("<div class='r-empty'>").text(o?this._emptyMessage:this._noneMessage).appendTo(r);r.addClass("r-list-empty");return}if(r.removeClass("r-is-empty"),e=n.ratObjects.renders[this.field.attributes.renderer]||n.ratObjects.renders["picker-item"],this.presets)for(t=0;t<this.presets.length;t++)i=this.presets[t],u=n("<div class='r-item r-preset'>").data("ratItem",i).append("<div class='r-checkbox'>").append(f=n("<div class='r-wrap'>")).appendTo(r),e.call(this,i,f,this._searchText),t+1===this.presets.length&&u.addClass("r-separator"),this.isPresetSelected(i)&&u.addClass("r-selected");for(t=0;t<this._data.length;t++)i=this._data[t],u=n("<div class='r-item'>").data("ratItem",i).append("<div class='r-checkbox'>").append(f=n("<div class='r-wrap'>")).appendTo(r),e.call(this,i,f,this._searchText),i.separator===!0&&u.addClass("r-separator"),this.selectedByValue[i.value]&&u.addClass("r-selected")}},onTabClick:function(t){var i=n(t.target).closest(".r-tab");if(!i.hasClass("r-active")){var r=i.closest(".r-container").find(".r-tab-content."+i.data("tab")),u=i.parent().find(".r-tab.r-active"),f=u.closest(".r-container").find(".r-tab-content."+u.data("tab"));r.hasClass("r-tab-selected")?this.renderTabSelected(r):(setTimeout(function(){r.find("input").focus()},0),delete this.$listSelected);i.addClass("r-active");r.addClass("r-active");u.removeClass("r-active");f.removeClass("r-active")}},onItemClick:function(t){var e=this,u=n(t.target).closest(".r-item"),i=u.data("ratItem"),f,r;if(this.$list.find(".r-preset").removeClass("r-selected"),i.preset){for(f=this.isPresetSelected(i),this._updating=!0,r=this.selected.length-1;r>=0;r--)this.select(this.selected[r],!1);f||i.values.forEach(function(n){e.select(n,!0)});this._updating=!1;u[f?"removeClass":"addClass"]("r-selected");this.onChanged(i)}else this.selectToggle(u),this.presets&&this.$list.find(".r-preset").each(function(t,i){var r=n(i);r[e.isPresetSelected(r.data("ratItem"))?"addClass":"removeClass"]("r-selected")});this._searchable&&this.editorElement().find(".r-search > input").focus()},onSelectedItemClick:function(t){this.selectToggle(n(t.target).closest(".r-item"))},onEditorShown:function(){this._searchable&&this.editorElement().find(".r-search > input").focus()},getItem:function(n){var i,t;if(n instanceof jQuery)n=n.data("ratItem");else if(typeof n=="string")for(i=this._data,t=0;t<i.length;t++)if(n===i[t].value){n=i[t];break}return!n||typeof n!="object"?null:n},isSelected:function(n){return n=this.getItem(n),n&&(this.selectedByValue[n.value]||null)!==null},isPresetSelected:function(n){if(n.preset!==!0||!n.value||(n.values||(n.values=[],n.value.split(",").forEach(function(t){(t=t.trim(),t)&&n.values.push(t)})),n.values.length===0||n.values.length!==this.selected.length))return!1;for(var t=0;t<n.values.length;t++)if(!this.selectedByValue[n.values[t]])return!1;return!0},selectToggle:function(n){return(n=this.getItem(n),!n)?undefined:this.select(n,!this.isSelected(n))},select:function(t,i){var r,u;if(typeof i!="boolean")return t.selected||!1;if(i&&this.maxMessage())return!1;if(t=this.getItem(t),!t)return undefined;if(this.isSelected(t)===i)return i;if(r=this.$list.find(".r-item"),this.$listSelected&&(r=n.merge(r,this.$listSelected.find(".r-item"))),r.each(function(r,u){var f=n(u),e=f.data("ratItem");e&&e.value===t.value&&f[i?"addClass":"removeClass"]("r-selected")}),i?(this.selected.push(t),this.selectedByValue[t.value]=t):(u=this.selectedByValue[t.value],this.selected.removeByValue(u),delete this.selectedByValue[t.value]),this.maxMessage(),!this._updating)this.onChanged(t);return i},onChanged:function(){this.selected.sort(function(n,t){return(n.text||n.value).localeCompare(t.text||t.value)});t.Filter.fn.onChanged.call(this)},valueRender:function(n){var t,i,r,u;if(!this._valueRenderUpdating){if(this._valueRenderUpdating=!0,n&&n.length||(n=this.$filter.find(".r-value")),this.presets)for(t=0;t<this.presets.length;t++)if(this.isPresetSelected(this.presets[t])){this.empty(!1);n.html(this.presets[t].text).removeClass("r-empty");delete this._valueRenderUpdating;return}for(i="",r=this.selected.length,t=0;t<r;t++)u=this.selected[t],i+=(t>0&&t+1===r?T("Ratings.Common| or "):i.length?T("Ratings.Common|, "):"")+(u.text||u.value);i.length===0?this.empty():(this.empty(!1),n.html(i).removeClass("r-empty"));delete this._valueRenderUpdating}},onSearch:function(t){if(this._loadAll){var r=t.val().trim().toLocaleLowerCase(),u=r.length===0,i=!0;u?(this.$list.find("> .r-item").show(),i=!1):this.$list.find("> .r-item").each(function(t,u){var e=n(u),f=e.data("ratItem");f.valueNorm||(f.valueNorm=f.value.toLocaleLowerCase());f.valueNorm.startsWith(r)?(e.show(),i=!1):e.hide()});i?this.$list.find("> .r-empty").length===0&&this.$list.append(n("<div class='r-empty'>").text(this._noneMessage)):this.$list.find("> .r-empty").remove()}else delete this._data,this.fetch(t.val().trim())},fetch:function(n){var r=this,i,t;if(this._searchText=n||"",this.$list&&this.$list.empty().ratBusy({fill:!0,inline:!0}),this._searchable&&!this._loadAll&&!n){this._data=[];r.listRender();r.popoverUpdatePosition();r.$list.ratBusy(!1);return}if(this.popoverUpdatePosition(),i=null,Array.isArray(this._data)&&this._data.length)for(i=[],t=0;t<this._data.length;t++)this._data[t].value!=null&&this._data[t].value!==undefined&&i.push(this._data[t].value);this.beginFetch(1,i,n)},renderTabSelected:function(t){var u,f,i,e,r;if(t.empty(),this.selected.length===0){t.append(n("<div class='r-empty'>").append(n("<span class='r-text'>").text("No selection to display.")));return}for(u=this.$listSelected=n("<div class='r-list'>").on("click",".r-item",n.proxy(this.onSelectedItemClick,this)).appendTo(t),f=n.ratObjects.renders[this.field.attributes.renderer]||n.ratObjects.renders["picker-item"],i=0;i<this.selected.length;i++)r=this.selected[i],n("<div class='r-item'>").addClass("r-selected").data("ratItem",r).append("<div class='r-checkbox'>").append(e=n("<div class='r-wrap'>")).appendTo(u),f.call(this,r,e)},maxMessage:function(t){var i=this.$list.parent().find(".r-max");return typeof this._max!="number"||this.selected.length<this._max?(i.remove(),!1):(i.length?t!==!1&&i.ratBlink():n("<div class='r-max alert alert-danger'>").text((this._maxMessage||T("Ratings.Common|Limit of {max} items reached.")).replaceAll("{max}",this._max)).insertBefore(this.$list),!0)},queryFilter:function(){var n,t="";if(this._values)for(n=0;n<this._values.length;n++)t+=(n>0?",":"")+this._values[n];else for(n=0;n<this.selected.length;n++)t+=(n>0?",":"")+this.selected[n].value;return this.queryableName()+"("+t+")"},queryFilterParse:function(n){var t,i,r;if(typeof n=="string"&&n){for(n=n.split(","),t=[],i=0;i<n.length;i++)(r=n[i].trim(),r.length)&&t.push(r);if(this._values=t,this.loading(!0),!this._searchable){this.fetch();return}this.beginFetch(2,t)}},beginFetch:function(t,i,r){var f,u;if(this._fetchRequest&&(this._fetchRequest.abort("abort"),delete this._fetchRequest),typeof t=="number"&&(this._fetching|=t),Array.isArray(i)&&(this._fetchValues=i),typeof r=="string"&&(this._fetchSearchText=r),typeof this._userReadyProxy=="function"&&(n.rat.page.$body.off(n.ratObjects.userReadyEvent,this._userReadyProxy),delete this._userReadyProxy),this.needsUserKey()&&!n.rat.userIsReady()){this._userReadyProxy=n.proxy(this.beginFetch,this);n.rat.page.$body.on(n.ratObjects.userReadyEvent,this._userReadyProxy);return}f=ratQueryableApiUrl+"/multiselect?n="+encodeURIComponent(this._remote);typeof this._fetchSearchText=="string"&&(f+="&q="+encodeURIComponent(this._fetchSearchText));Array.isArray(this._fetchValues)&&(f+="&v="+encodeURIComponent(this._fetchValues.join(";")));this.needsUserKey()&&n.rat.user.userKey&&(f+="&k="+n.rat.user.userKey);u=this;(this._fetching&1)>0&&(this._fetchRequest=n.ajax({url:f,method:"GET",success:function(t){if(!n.rat.handleError(t,u.$list||u.editorElement(),!0)){u.onFetchDataReady(t);u._dataReady=!0;u.listRender()}u.$list&&u.$list.ratBusy(!1);u.popoverUpdatePosition();u.onFetchDone(1)},error:function(t){if(!t||t.statusText!=="abort"){n.rat.handleError(t,u.$list||u.editorElement(),!0);u.$list&&u.$list.ratBusy(!1);u.popoverUpdatePosition();u.onFetchDone(1)}}}));(this._fetching&2)>0&&(_fetchRequest=n.ajax({url:f,method:"GET",success:function(t){n.rat.handleError(t)||(u._values=t);u.onFetchDone(2)},error:function(n){if(!n||n.statusText!=="abort"){delete u._values;u.onFetchDone(2)}}}))},onFetchDataReady:function(t){var i,r,u,f,e;if(this.fieldInfo.customValues&&Array.isArray(this._data)){for(i=0;i<this._data.length;i++)r=this._data[i],u=t.findIndexOf(function(n){return n.value===r.value}),r.count=u>=0?t[u].count:0;return}if(f={},Array.isArray(this._data))for(i=0;i<this._data.length;i++)this._data[i].value!=null&&this._data[i].value!==undefined&&(f[this._data[i].value]=this._data[i]);for(this._data=[],i=0;i<t.length;i++)typeof t[i].value!="string"&&(t[i].value=t[i].value.toString()),e=f[t[i].value]||{},this._data.push(n.extend(e,t[i]))},onFetchDone:function(n){var t,r,i;if(delete this._fetchValues,delete this._fetchSearchText,delete this._fetchRequest,this._fetching&=~n,this._fetching===0&&this._values){for(this.selected=[],this.selectedByValue={},t=0;t<this._values.length;t++)r=typeof this._values[t]=="string"?this._values[t]:this._values[t].value,i=this.findByValue(r),i||(i={value:r}),this.selected.push(i),this.selectedByValue[r]=i;delete this._values;this.loading(!1)}},findByValue:function(n){var i=this._data||this._values,t;if(!i)return null;for(t=0;t<i.length;t++)if(i[t].value===n)return i[t];return null}});t.FieldInfoRatingChange=t.FieldInfoMultiselect.extend({init:function(n,i){t.FieldInfoMultiselect.fn.init.call(this,n,i);this.displayValues={1:T("Ratings.Queryable|Upgraded"),2:T("Ratings.Queryable|Downgraded")}},getDisplayValue:function(t){var i=this.displayValues[t[this.field.resultName]];return i===undefined||i===null?n("<span class='r-empty'>").text(T("Rating.Common|--")).ratOuterHTML():i}});t.FieldInfoBitwise=t.FieldInfo.extend({init:function(n,i){t.FieldInfo.fn.init.call(this,n,i)},createFilter:function(n,i){return new t.FilterBitwise(this,n,i)}});t.FilterBitwise=t.Filter.extend({init:function(n,i,r){t.Filter.fn.init.call(this,n,i,{hasValue:!0});this._emptyMessage=n.attributeString("empty-message")||T("Ratings.Common|No items to display.");this._display=n.attributeString("display");this._fetching=0;this.selected=[];this.selectedByValue={};this.queryFilterParse(r)},popoverClassName:function(){return"r-popover-select"},isEmpty:function(){return this.selected.length===0&&(!this._values||this._values.length===0)},valueRender:function(n){var t,i,r,u;if(!this._valueRenderUpdating){for(this._valueRenderUpdating=!0,n&&n.length||(n=this.$filter.find(".r-value")),i="",r=this.selected.length,t=0;t<r;t++)u=this.selected[t],i+=(t>0&&t+1===r?T("Ratings.Common| or "):i.length?T("Ratings.Common|, "):"")+(this._display==="text"?u.text:u.value);i.length===0?this.empty():(this.empty(!1),n.html(i).removeClass("r-empty"));delete this._valueRenderUpdating}},editorRender:function(t){this.$list=n("<div class='r-list'>").on("click",".r-item",n.proxy(this.onItemClick,this)).appendTo(t);this.listRender()},queryFilter:function(){var n,t="";if(this._values)for(n=0;n<this._values.length;n++)t+=(n>0?",":"")+this._values[n];else for(n=0;n<this.selected.length;n++)t+=(n>0?",":"")+this.selected[n].value;return this.queryableName()+"("+t+")"},listRender:function(){var u,i,f,t,r;if(this.$list.ratEmpty(),this._items.length===0){n("<div class='r-empty'>").text(this._emptyMessage).appendTo(this.$list.addClass("r-is-empty"));return}for(u=n.ratObjects.renders[this.field.attributes.renderer]||n.ratObjects.renders["picker-item"],i=0;i<this._items.length;i++)t=this._items[i],r=n("<div class='r-item'>").data("ratItem",t).append("<div class='r-checkbox'>").append(f=n("<div class='r-wrap'>")).appendTo(this.$list),u.call(this,t,f),t.separator===!0&&r.addClass("r-separator"),this.selectedByValue[t.value]&&r.addClass("r-selected")},onItemClick:function(t){this.selectToggle(n(t.target).closest(".r-item"))},queryFilterParse:function(t){var u,r,f,i;if(typeof t=="string"&&t){for(t=t.split(","),u=[],r=0;r<t.length;r++)(f=t[r].trim().toLocaleLowerCase(),f.length)&&u.push(f);this._values=u}this.loading(!0);i=this;this._fetching|=1;n.ajax({url:ratQueryableApiUrl+"/bitwise?n="+encodeURIComponent(this.field.queryableName),method:"GET",success:function(n){i._items=n;i.onFetchDone(1)},error:function(){delete i._items;i.onFetchDone(1)}})},onFetchDone:function(n){var r,i,t;if(this._fetching&=~n,this._fetching===0){if(!Array.isArray(this._items)){this.invalid(T("Ratings.Common|Unable to load"));this.loading(!1);return}for(this.selected=[],this.selectedByValue={},r=this._items,this._items=[],i=0;i<r.length;i++)(t=r[i],!Array.isArray(t)||t.length<2)||(t={id:t[0],text:t[1],value:t.length>2?t[2]:t[0]},t.value=typeof t.value!="string"?t.value.toString().trim():t.value.trim(),t.valueNorm=t.value.toLocaleLowerCase(),this._items.push(t),this._values&&this._values.includes(t.valueNorm)&&(this.selected.push(t),this.selectedByValue[t.value]=t));delete this._values;this.loading(!1)}},getItem:function(n){var i,t;if(n instanceof jQuery)n=n.data("ratItem");else if(typeof n=="string")for(i=this._data,t=0;t<i.length;t++)if(n===i[t].value){n=i[t];break}return!n||typeof n!="object"?null:n},isSelected:function(n){return n=this.getItem(n),n&&(this.selectedByValue[n.value]||null)!==null},selectToggle:function(n){return(n=this.getItem(n),!n)?undefined:this.select(n,!this.isSelected(n))},select:function(t,i){if(t=this.getItem(t),!t)return undefined;if(typeof i!="boolean")return t.selected||!1;if(this.isSelected(t)===i)return i;if(this.$list.find(".r-item").each(function(r,u){var f=n(u),e=f.data("ratItem");e&&e.value===t.value&&f[i?"addClass":"removeClass"]("r-selected")}),i)this.selected.push(t),this.selectedByValue[t.value]=t;else{var r=this.selectedByValue[t.value];this.selected.removeByValue(r);delete this.selectedByValue[t.value]}this.onChanged(t);return i},onChanged:function(){this.selected.sort(function(n,t){return(n.text||n.value).localeCompare(t.text||t.value)});t.Filter.fn.onChanged.call(this)}});t.FieldInfoDate=t.FieldInfo.extend({init:function(n,i){t.FieldInfo.fn.init.call(this,n,i)},createFilter:function(n,i){return new t.FilterDate(this,n,i)},getDisplayFormat:function(){return this._displayFormat||(this._displayFormat=this.field.attributes["display-format"]||"MM/DD/YYYY")}});t.FilterDate=t.Filter.extend({init:function(n,i,r){t.Filter.fn.init.call(this,n,i,{hasValue:!0});this._operators=[{text:T("Ratings.Common|Equals"),value:"=",icon:"equal"},{text:T("Ratings.Common|Does not equal"),value:"!=",icon:"not-equal"},{text:T("Ratings.Common|Less than"),value:"<",icon:"less"},{text:T("Ratings.Common|Greater than"),value:">",icon:"greater"},{text:T("Ratings.Common|Less than or equal to"),value:"<=",icon:"less-equal"},{text:T("Ratings.Common|Greater than or equal to"),value:">=",icon:"greater-equal"}];this.queryFilterParse(r)},isEmpty:function(){return!this._date||typeof this._date!="object"},editorRender:function(t){var i=this;this._$operator=n("<div class='r-operator'>").appendTo(t).kendoDropDownList({dataTextField:"text",dataValueField:"value",dataSource:this._operators,value:this._operator||"=",valueTemplate:'<span class="r-icon r-icon-#: data.icon #"><\/span><span class="r-text">#: data.text #<\/span>',template:'<span class="r-icon r-icon-#: data.icon #"><\/span><span class="r-text">#: data.text #<\/span>',change:function(){i._operator=this.value();i.onChanged()},open:function(){n(document.body).addClass("r-popover-active")},close:function(){n(document.body).removeClass("r-popover-active")}});this._$date=n("<div class='r-date'>").appendTo(t).kendoCalendar({value:this._date?this._date.local().toDate():null,change:function(){i._date=moment.utc(this.value());i.onChanged()}})},popoverClassName:function(){return"r-popover-queryable r-popover-queryable-date"},onEditorHidden:function(){t.Filter.fn.onEditorHidden.call(this);this._$operator.data("kendoDropDownList").destroy();this._$date.data("kendoCalendar").destroy();this.valueRender()},valueRender:function(n){var t,i;if(n&&n.length||(n=this.$filter.find(".r-value")),this.isEmpty()){n.text(T("Ratings.Common|--"));return}for(t=null,i=0;i<this._operators.length;i++)if(this._operators[i].value===this._operator){t=this._operators[i].icon;break}t||(this._operator=this._operators[0].value,t=this._operators[0].icon);n.html("<span class='r-icon r-icon-"+t+"'><\/span>"+this._date.format("MM/DD/YYYY"))},queryFilter:function(){var n=this.queryableName();return this.isEmpty()?n+"()":n+"("+(this._operator||"=")+this._date.format("YYYY-M-D")+")"},queryFilterParse:function(n){if(n){var t=/([!]?[=]|[>][=]?|[<][=]?)\s*(\d{4})[-](\d{1,2})[-](\d{1,2})/gm.exec(n);if(t)try{this._operator=t[1];this._date=moment(new Date(parseInt(t[2]),parseInt(t[3])-1,parseInt(t[4])))}catch(i){}}}});t.FieldInfoString=t.FieldInfo.extend({init:function(n,i){t.FieldInfo.fn.init.call(this,n,i)},createFilter:function(n,i){return new t.FilterString(this,n,i)}});t.FilterString=t.Filter.extend({init:function(n,i,r){t.Filter.fn.init.call(this,n,i,{hasValue:!0});this._operators=[{text:T("Ratings.Common|Contains"),value:"~",icon:"contains"},{text:T("Ratings.Common|Does not contain"),value:"!~",icon:"not-contain"},{text:T("Ratings.Common|Starts with"),value:"~*",icon:"starts-with"},{text:T("Ratings.Common|Ends with"),value:"*~",icon:"ends-with"},{text:T("Ratings.Common|Equals"),value:"=",icon:"equal"},{text:T("Ratings.Common|Does not equal"),value:"!=",icon:"not-equal"}];this.queryFilterParse(r)},isEmpty:function(){return!this._string||typeof this._string!="string"},editorRender:function(t){var i=this;this._$operator=n("<div class='r-operator'>").appendTo(t).kendoDropDownList({dataTextField:"text",dataValueField:"value",dataSource:this._operators,value:this._operator,valueTemplate:'<span class="r-icon r-icon-#: data.icon #"><\/span><span class="r-text">#: data.text #<\/span>',template:'<span class="r-icon r-icon-#: data.icon #"><\/span><span class="r-text">#: data.text #<\/span>',change:function(){i._operator=this.value();i.onChanged()},open:function(){n(document.body).addClass("r-popover-active")},close:function(){n(document.body).removeClass("r-popover-active")}});this._$input=n("<input class='r-input' type='text'>").val(this._string||"").appendTo(t).ratInputAutoChange(function(){i._string=i._$input.val().trim();i.onChanged()})},popoverClassName:function(){return"r-popover-queryable r-popover-queryable-string"},onEditorShown:function(){this._$input.focus()},onEditorHidden:function(){t.Filter.fn.onEditorHidden.call(this);this._$operator.data("kendoDropDownList").destroy();this.valueRender()},valueRender:function(n){var t,i;if(n&&n.length||(n=this.$filter.find(".r-value")),this.isEmpty()){n.text(T("Ratings.Common|--"));return}for(t=null,i=0;i<this._operators.length;i++)if(this._operators[i].value===this._operator){t=this._operators[i];break}t==null&&(this._operator=this._operators[0].value,t=this._operators[0]||{});n.html("<span class='r-icon r-icon-"+t.icon+"' title='"+t.text+"'><\/span>"+this._string)},queryFilter:function(){var n=this.queryableName();return this.isEmpty()?n+"()":(this._operator||(this._operator=this._operators[0].value),n+"("+this._operator+this._string+")")},queryFilterParse:function(n){if(this._operator||(this._operator=this._operators[0].value),n){var t=/([!]?[=]|[~][*]|[*][~]|[!]?[~])\s*(.*)/gm.exec(n);if(t)try{this._operator=t[1];this._string=t[2].trim()}catch(i){}}}});t.FieldInfoNumber=t.FieldInfo.extend({init:function(n,i){t.FieldInfo.fn.init.call(this,n,i)},createFilter:function(n,i){return new t.FilterNumber(this,n,i)},getDisplayFormat:function(){return this._displayFormat||(this._displayFormat=(this.field.attributes["display-format"]||"0.00").toString().replaceAll("#","0"))},getEditorFormat:function(){return this._editorFormat||(this._editorFormat=(this.field.attributes["editor-format"]||this.getDisplayFormat()).toString().replaceAll("#","0"))},getEditorValue:function(n){return typeof n!="number"?"":numeral(n).format(this.getEditorFormat(n))}});t.FilterNumber=t.Filter.extend({init:function(n,i,r){t.Filter.fn.init.call(this,n,i,{hasValue:!0});this.queryFilterParse(r)},isEmpty:function(){return typeof this._value1!="number"&&typeof this._value2!="number"},editorRender:function(t){var i=this,o=n("<div class='r-editors'>").appendTo(t),s,r,u,f,e;if(this._$value1=n("<input class='r-value r-value-1' type='text'>").val(this.fieldInfo.getEditorValue(this._value1)).appendTo(o).ratInputAutoChange(function(){i._value1=numeral(i._$value1.val().trim()).value();i.onChanged()}),n("<span class='r-value-separator'>").html(T("Ratings.Common|to")).appendTo(o),this._$value2=n("<input class='r-value r-value-2' type='text'>").val(this.fieldInfo.getEditorValue(this._value2)).appendTo(o).ratInputAutoChange(function(){i._value2=numeral(i._$value2.val().trim()).value();i.onChanged()}),s=this.field.attributes["editor-common"],typeof s=="string"&&(r=s.split(";"),Array.isArray(r)&&r.length>0))for(u=null,f=0;f<r.length;f++)e=r[f].split("|"),e.length===2&&(u===null&&(u=n("<div class='r-editor-common'>").append(n("<span class='r-caption'>").html(T("Ratings.Common|Common"))).on("click","> .r-common",n.proxy(this.onCommonClick,this)).appendTo(t)),n("<span class='r-common'>").html(e[0]).data("r-value",e[1]).appendTo(u))},popoverClassName:function(){return"r-popover-queryable r-popover-queryable-number"},onEditorShown:function(){this._$value1.focus()},onEditorHidden:function(){t.Filter.fn.onEditorHidden.call(this);this.valueRender()},valueRender:function(n){n&&n.length||(n=this.$filter.find(".r-value"));this.isEmpty()?n.text(T("Ratings.Common|--")):typeof this._value1=="number"&&typeof this._value2=="number"?this._value1===this._value2?n.text(T("Ratings.Common|{0}").replace("{0}",this.fieldInfo.getEditorValue(this._value1))):n.text(T("Ratings.Common|{0} to {1}").replace("{0}",this.fieldInfo.getEditorValue(this._value1)).replace("{1}",this.fieldInfo.getEditorValue(this._value2))):typeof this._value1=="number"?n.text(T("Ratings.Common|>= {0}").replace("{0}",this.fieldInfo.getEditorValue(this._value1))):n.text(T("Ratings.Common|<= {0}").replace("{0}",this.fieldInfo.getEditorValue(this._value2)))},queryFilter:function(){var n=this.queryableName();return this.isEmpty()?n+"()":typeof this._value1=="number"&&typeof this._value2=="number"?this._value1===this._value2?n+"(#"+this.rawFormat(this._value1)+")":n+"("+this.rawFormat(this._value1)+"~"+this.rawFormat(this._value2)+")":typeof this._value1!="number"&&typeof this._value2=="number"?n+"(~"+this.rawFormat(this._value2)+")":n+"("+this.rawFormat(this._value1)+")"},queryFilterParse:function(n){if(n)try{if(n.startsWith("=")||n.startsWith("#")){this._value1=this._value2=numeral(n.substring(1).trim()).value();return}var t=n.split("~");Array.isArray(t)&&t.length===2?(this._value1=numeral(t[0].trim()).value(),this._value2=numeral(t[1].trim()).value()):(this._value1=numeral(n).value(),this._value2=null)}catch(i){this._value1=null;this._value2=null}},validate:function(){typeof this._value1=="number"&&typeof this._value2=="number"&&this._value1>this._value2?this.invalid(T("Ratings.Common|The first value must be less or equal to the second.")):this.invalid(!1)},rawFormat:function(n){return typeof n!="number"?"":numeral(n).format((this.field.attributes["raw-format"]||"0.[00]").toString().replaceAll("#","0"))},onCommonClick:function(t){var i=n(t.target).closest(".r-common"),r=i.data("r-value");this._frozen=!0;this.queryFilterParse(r);this._$value1.val(this.fieldInfo.getEditorValue(this._value1));this._$value2.val(this.fieldInfo.getEditorValue(this._value2));delete this._frozen;this.onChanged()}});t.FieldInfoMoney=t.FieldInfoNumber.extend({createFilter:function(n,i){return new t.FilterMoney(this,n,i)},getDisplayFormat:function(n){return n<1?(this._displayFormatTiny||(this._displayFormatTiny=this.field.attributes["display-format-tiny"]||this.field.attributes["display-format"]||"$0.00"),this._displayFormatTiny):this._displayFormat||(this._displayFormat=this.field.attributes["display-format"]||"$0.00")}});t.FilterMoney=t.FilterNumber.extend({popoverClassName:function(){return"r-popover-queryable r-popover-queryable-money"}});t.FieldInfoChange=t.FieldInfoNumber.extend({createFilter:function(n,i){return new t.FilterChange(this,n,i)},getDisplayFormat:function(){return this._displayFormat||(this._displayFormat=this.field.attributes["display-format"]||"0,0.00%")}});t.FilterChange=t.FilterNumber.extend({popoverClassName:function(){return"r-popover-queryable r-popover-queryable-change"}});t.QueryBuilder=n.ratObjects.Class.extend({init:function(t,i,r){if(this._loading=!0,this.editor=t,this._$element=i,this._options=r,this._$queryableForm=i.find(".r-queryable-form"),this._$filterType=i.find(".r-filter-type").click(n.proxy(this.onFilterTypePicker,this)),this._$filterAdd=i.find(".r-filter-add").click(n.proxy(this.onFilterPicker,this)),this._$orderBy=i.find(".r-order-by").click(n.proxy(this.onOrderByPicker,this)),this._$filterType.length===0){if(this._contentType=this._$queryableForm.data("content-type"),typeof this._contentType!="string"||!this._contentType)throw new"The content type was not specified.";this._options.allowContentTypePicking=!1}if(this._queryableInfo=this._$queryableForm.data("queryable-info"),typeof this._queryableInfo!="object"||!this._queryableInfo)throw new"The queryable information was not specified.";if(this._options.apiPath=this._$queryableForm.data("api"),typeof this._options.apiPath!="string"||!this._options.apiPath)throw new"An API path was not specified.";this._options.defaultQuery=this._$queryableForm.data("default-query");typeof this._options.defaultQuery=="string"&&this._options.defaultQuery||delete this._options.defaultQuery;this.resetQuery(!0);i.find(".r-queryable-options").click(n.proxy(this.onOptions,this));this._$queryableForm.on("click",".r-filter > .r-remove",n.proxy(this.onFilterRemove,this));this._$queryableForm.on("click",".r-filter > .r-container",n.proxy(this.onFilterEdit,this));this._loading=!1},initFieldsInfo:function(){this._fieldsInfo={};this._fieldsInfo["default"]=t.FieldInfo;this._fieldsInfo.rating=t.FieldInfoRating;this._fieldsInfo.multiselect=t.FieldInfoMultiselect;this._fieldsInfo.bitwise=t.FieldInfoBitwise;this._fieldsInfo.date=t.FieldInfoDate;this._fieldsInfo.string=t.FieldInfoString;this._fieldsInfo.number=t.FieldInfoNumber;this._fieldsInfo.money=t.FieldInfoMoney;this._fieldsInfo.change=t.FieldInfoChange;this._fieldsInfo["rating-change"]=t.FieldInfoRatingChange},loadQuery:function(){var u,f,e,n,o,t,r,v,y,p,w,s,i,h,c,b,k;if(this.beginUpdate(),this.queryParts=this.getQueryParts(),delete this._options.usingLocalStorage,!this.queryParts.hasQuery&&(u=this._options.storageKey,typeof u=="string"&&u&&window.localStorage))try{f=localStorage.getItem(u);typeof f=="string"&&f&&(this.queryParts=this.getQueryParts(f),this._options.usingLocalStorage=!0)}catch(nt){}if(this.queryParts.hasQuery||(e=this._options.defaultQuery,typeof e=="string"&&e&&(this.queryParts=this.getQueryParts(e))),typeof this.queryParts.q=="string"&&this.queryParts.q.length)try{var l=/(([\w-]+)\s*[(]([^)]*)[)])|(\s+(and|or)\s*)/gm,g=this._info.fieldsByQueryableName,a=!1;this.queryParts.a&&(this.setQueryableTypes(this.queryParts.a),a=!0);n=0;do if(t=l.exec(this.queryParts.q),t){if(n<t.index&&(o=this.queryParts.q.substring(n,t.index),typeof o=="string"&&o.trim().length>0))throw"Unknown expression '"+o+"' at position "+n+".";if(t[5]){n=l.lastIndex;continue}if(r=t[2],typeof r!="string"||!r.length)throw"No filter was specified at position "+n+".";if(r=r.trim().toLocaleLowerCase(),r==="type"){if(a)throw"Type filter was specified multiple times.";a=!0;this._options.allowContentTypePicking!==!1&&this.setQueryableTypes(t[3])}else{if(v=g[r],!v)throw"Invalid filter '"+t[2]+"' at position "+n+".";try{this.filterAdd(v.field,t[3])}catch(d){throw"Invalid expression at position "+n+"."+(typeof d=="string"?" "+d:"");}}n=l.lastIndex}while(t);if(y=this.queryParts.q.substring(n).trim(),y.length)this.editor.onSearchText(y)}catch(nt){this._filters=[];delete this._orderBy;this.editor.onSearchText("")}this.updateTypes();this.onTypeChanged(null);if(p=this.queryParts.o,typeof p=="string")for(w=p.toLowerCase().split(","),s=0;s<w.length;s++)i=w[s],i.endsWith(" desc")?(h="desc",i=i.substring(0,i.length-5)):i.endsWith(" asc")?(h="asc",i=i.substring(0,i.length-4)):h="asc",this.orderByAdd(i,h);if(this._$element.data("rendered")!==!0)this._$element.removeAttr("data-rendered").data("rendered",!1);else try{if(c=this._$queryableForm.data("editor-query"),typeof c=="string"&&c.length){if(this.isQueryLoaded(c)&&(b=this._$queryableForm.data("editor-count"),k=this._$queryableForm.data("editor-rows"),typeof b=="number"&&Array.isArray(k)))this.editor.onDataReady({count:b,rows:k},!0);this._$queryableForm.removeAttr("data-editor-count");this._$queryableForm.removeAttr("data-editor-rows")}}catch(o){}this.endUpdate();this.editor.onQueryLoaded()},resetQuery:function(n){if(this._info={},this._filters=[],this.initFieldsInfo(),this.initProviders(),this.initFields(),this.initTypesInfo(),n!==!0){this.beginUpdate();this._$filterAdd.parent().find("> .r-filter").remove();delete this._orderBy;delete this.queryParts;try{var t=this._options.storageKey;t&&localStorage&&localStorage.removeItem(t)}catch(i){}this.loadQuery();this.endUpdate()}},isQueryLoaded:function(n,t){var r,i;if(typeof n!="string"||!n)return null;if(!this.queryParts||!this.queryParts.hasQuery||(r=this.getQueryParts(n),!r.hasQuery))return!1;t=t===!0;for(i in this.queryParts)if(!this.queryPartIsEqual(i,this.queryParts[i],r[i],t))return!1;return!0},queryPartIsEqual:function(n,t,i){return t===i},isUpdating:function(){return typeof this._updating=="number"&&this._updating>0},getQueryAction:function(){return this._$queryableForm.attr("action")},setQueryableTypes:function(n){var r,i,u,t;if(this._options.allowContentTypePicking===!1||(typeof n=="string"&&(n=n.split(",")),!Array.isArray(n)))return!1;for(r=!0,i=this.filterTypePicker(),i.beginSelect(),u=0;u<n.length;u++)t=n[u],typeof t=="string"&&(t=t.trim()),t.length&&!i.select(t,!0)&&(r=!1);return i.endSelect(),r&&(i.userChanged=!0),r},beginUpdate:function(){this._updating=(this._updating||0)+1},endUpdate:function(){this._updating&&(this._updating==1&&(this.updateQuery(!0),this.updateOrderBy(!0),this.editor.onUpdatingEnding()),this._updating--,this._updating==0&&(delete this._updating,this.updateState(!1)))},orderBy:function(n){return n===null?(this._orderBy=null,this.updateOrderBy()):Array.isArray(n)&&(this._orderBy=n,this.updateOrderBy()),this._orderBy},orderByAdd:function(n,t){var r,u,i;if((Array.isArray(this._orderBy)||(this._orderBy=[]),n=this.getField(n),!n)||this._orderBy.length>=3)return!1;for(i=0;i<this._orderBy.length;i++)if(this._orderBy[i].field.id===n.id)return this._orderBy[i].dir=this._orderBy[i].dir==="desc"?"asc":"desc",this.updateOrderBy(),!0;if(n.attributes["allow-order-by"]===!1||!n.queryableNameNorm)return!1;for(r=this.getAvailableFields(),u=!1,i=0;i<r.length;i++)if(r[i].id===n.id){u=!0;break}return u?(t!=="asc"&&t!=="desc"&&(t="asc"),this._orderBy.push({field:n,dir:t}),this.updateOrderBy(),!0):!1},orderByRemove:function(n){if(n&&typeof n=="object"&&typeof n.field=="object"&&(n=n.field),n=this.getField(n),!n)return!1;for(var t=0;t<this._orderBy.length;t++)if(this._orderBy[t].field.id===n.id)return this._orderBy.splice(t,1),this.updateOrderBy(),!0;return!1},getQueryClause:function(n){return(n===!0?this._queryClean:this._query)||null},getOrderByClause:function(){return this._orderByClause||null},onOptions:function(i){var r=n(i.target).closest(".r-queryable-options"),u=this;r.ratPopover({autoShow:!0,className:"r-popover-queryable-options",onRender:function(i){var o=u.getOptions(),e,f;if(!Array.isArray(o)){n("<span class='r-empty'>").text(T("Rating.Queryable|No options are available.")).appendTo(i);return}var s=new t.PopoverNavigation(this,i),h=s.newPanel(),c=n("<div class='r-options'>").appendTo(h);for(e=0;e<o.length;e++)f=o[e],n("<div class='r-option'>").append(n("<span>").addClass(typeof f.icon=="string"&&f?f.icon:"r-no-icon"),n("<span class='r-text'>").html(f.text)).data("r-option",f).addClass(f.disabled?"r-disabled":null).appendTo(c);c.on("click",".r-option",function(n){u.onOptionClicked(n,s,r.data("ratPopover"))});s.push(h)}}).data("ratPopover")},onFilterTypePicker:function(){this._options.allowContentTypePicking!==!1&&this.filterTypePicker().show()},onFilterPicker:function(){var n=this;this._$filterAdd.ratPopover({autoShow:!0,className:"r-popover-queryable r-popover-queryable-add",onRender:function(i){var r=new t.PopoverNavigation(this,i);n.filterPickerRender(n.getAvailableFieldsPicker(),r)},onShown:function(n){n.find(".r-container > .r-search > input").focus()}})},filterTypePicker:function(){var t=this._$filterType.data("ratPopover"),n;return t?t:(n=this,this._$filterType.ratPopover({multiselect:!0,autoShow:!1,className:"r-popover-queryable r-popover-queryable-type",items:this._info.typeItems,selected:this._info.allSelected,allowNone:!0,noneIsAll:!0,updateElement:this._$filterType.find(".r-value"),onChanged:function(t){if(!n._loading)n.onTypeChanged(t)}},"Select"),this._$filterType.data("ratPopover"))},onOrderByPicker:function(){var n=this;this._$orderBy.ratPopover({autoShow:!0,className:"r-popover-queryable r-popover-queryable-order-by",onRender:function(i){var r=new t.PopoverNavigation(this,i),u=r.newPanel().addClass("r-order-by-panel");n.orderByPickerRender(u,r);r.push(u)}})},initProviders:function(){for(var n,r,t,i,e=this._info.providersByName={},o=this._info.providerTypesByName={},f=this._queryableInfo.providers,u=0;u<f.length;u++)for(n=f[u],n.typesByName={},e[n.name]=n,r=n.types,t=0;t<r.length;t++)i=r[t],r[t].provider=n,o[i.name]=i,n.typesByName[i.name]=i},initFields:function(){for(var n,r,f,i,u,o=this._info.fieldsByQueryableName={},h=this._info.providersByName,s=this._queryableInfo.fields,e=0;e<s.length;e++)for(n=s[e],n.nameNorm=n.name.toLocaleLowerCase(),typeof n.queryableName=="string"&&(n.queryableNameNorm=n.queryableName.toLocaleLowerCase()),n.resultName=n.attributes["result-name"]||n.name,typeof n.resultName=="string"&&(n.resultName=n.resultName.toCamelCase()),r=n.attributes.type,r=this._fieldsInfo[!r||typeof r!="string"?"default":r.toLocaleLowerCase()]||t.FieldInfo,n.fieldInfo=new r(this,n),n.providers=[],f=0;f<n.providerNames.length;f++)(i=h[n.providerNames[f]],i)&&(n.providers.push(i),i.fields||(i.fields=[],i.fieldsById={}),i.fields.push(n),i.fieldsById[n.id]=n,typeof n.queryableNameNorm=="string")&&(u=o[n.queryableNameNorm],u?u.providers.push(i):(u={field:n,providers:[i]},o[n.queryableNameNorm]=u))},initTypesInfo:function(){var t=this._info.providerTypes=[],l={},a=this._info.providerTypesByName,v,u,i,y,f,o,s,p,h,n,r,e,c;for(v in a)Object.prototype.hasOwnProperty.call(a,v)&&(u=a[v],u.pluralNameNorm=u.pluralName.toLocaleLowerCase(),i=u.dataType||T("Ratings.Common|--"),l[i]||(y=[],t.push({name:i,nameNorm:i.toLocaleLowerCase(),providerTypes:y}),l[i]=y),l[i].push(u));for(f={"--":255,newsletters:254},t.sort(function(n,t){return typeof f[n.nameNorm]=="number"||typeof f[t.nameNorm]=="number"?(f[n.nameNorm]||0)>(f[t.nameNorm]||0)?0:1:n.nameNorm.localeCompare(t.nameNorm)}),o=0;o<t.length;o++)t[o].providerTypes.sort(function(n,t){return n.pluralNameNorm.localeCompare(t.pluralNameNorm)});for(s=this._info.typeItems=[],p=this._info.typeItemAll={value:"all",text:"All",separator:!0,cssClass:"r-all",isAll:!0,selected:!0},s.push(p),h=0;h<t.length;h++)for(n=t[h],r=n.name.toLocaleLowerCase(),r!=="--"&&s.push({value:r,text:n.name,isGroup:!0,selected:!0,providerType:n}),e=0;e<n.providerTypes.length;e++)c=n.providerTypes[e],s.push({value:c.code,text:c.pluralName,group:r==="--"?null:r,indent:r==="--"?0:1,selected:!0,type:c,separator:e===n.providerTypes.length-1})},getOptions:function(){return this.editor.getOptions()},onOptionClicked:function(t,i,r){var f=n(t.target).closest(".r-option"),u=f.data("r-option");if(u&&typeof u.onClick=="function"&&!f.hasClass("r-disabled"))u.onClick(i,r)},getFilters:function(){return this._filters},getAvailableFields:function(){return this._info.available},getAvailableFieldsPicker:function(){var r,f,t;if(this._info.availablePicker)return this._info.availablePicker;var e={},i=[],o=this.getAvailableFields();for(r=0;r<o.length;r++){var n=o[r],s=!0,u=n.attributes["picker-group-name"];typeof u=="string"&&u.length>0&&(f=u.toLocaleLowerCase(),t=e[f],t?t.fields.push(n):(t=e[f]={isGroup:!0,name:u,fields:[n]},i.push(t)),s=n.attributes["picker-root"]===!0);s&&i.push(n)}return i.sort(function(n,t){var i=n.displayName||n.name||"",r=t.displayName||t.name||"";return i.localeCompare(r)}),this._info.availablePicker=i},getField:function(n){var r,i;if(n instanceof t.FieldInfo)return n.field;if(typeof n=="object"&&n&&typeof n.field=="object"&&(n=n.field),typeof n=="object"&&n&&n.name&&typeof n.id=="number")return n;if(r=this._queryableInfo.fields,typeof n=="number"){for(i=0;i<r.length;i++)if(r[i].id===n)return r[i]}else if(typeof n=="string")for(n=n.toLocaleLowerCase(),i=0;i<r.length;i++)if(r[i].nameNorm===n||r[i].queryableNameNorm===n)return r[i];return null},onTypeChanged:function(n){var f=this._options.allowContentTypePicking!==!1,t,e,r,s,i=null,v=this._$filterType.data("ratPopover"),h=!f||v.isAnySelected(),l,u,a;!h&&n&&n.isAll&&this._filters.length>0&&(this.updateTypes(!0),h=v.isAnySelected());var y=f?this._info.typeItemAll.selected||!h:!1,p=this._info.allSelected=[],c=this._info.selected=[],o="";for(e=0;e<this._info.typeItems.length;e++)if((t=this._info.typeItems[e],(t.selected||y)&&(f||t.value===this._contentType))&&(p.push(t),l=t.type,l)&&(c.push(t),o+=(o?";":"")+t.value,u=l.provider.fields,u))for(i||(i={}),r=0;r<u.length;r++)i[u[r].id]=u[r];if(!f&&c.length===0)throw new"The specified content type was not found.";if(this._info.selectedNames!==o){this._info.selectedNames=o;delete this._info.availablePicker;a=this._info.available=[];for(s in i)Object.prototype.hasOwnProperty.call(i,s)&&a.push(i[s]);a.sort(function(n,t){return n.displayName.localeCompare(t.displayName)});this.updateFilters();this.updateQuery();this.updateOrderBy();this.editor.onTypeChanged(c)}},onFieldInformation:function(t){var r=this.getField(t),i,u;r&&(u=n("<div class='modal fade r-modal' tabindex='-1' role='dialog' aria-hidden='true'>").append(n("<div class='modal-dialog modal-dialog-centered' role='document'>").append(n("<div class='modal-content'>").append(n("<div class='modal-header'>").append(n("<h5 class='modal-title'>").text(r.displayName),n("<button type='button' class='close' data-dismiss='modal' aria-label='Close'><span aria-hidden='true'>&times;<\/span><\/button>")),i=n("<div class='modal-body'>"),n("<div class='modal-footer'>").append(n("<button type='button' class='btn btn-light' data-dismiss='modal'>").text("Close"))))).on("shown.bs.modal",function(){r.info||(i.css("min-height",i.outerHeight()+"px"),n.ajax({url:ratQueryableApiUrl+"/field-information?f="+r.id,method:"GET",success:function(n){i.prepend(r.info=n.info[1]);i.ratBusy(!1)},error:function(t){i.ratBusy(!1);n.rat.handleError(t,i)}}))}).on("hidden.bs.modal",function(){n(this).remove()}),r.info?i.append(r.info):i.ratBusy(),u.modal({backdrop:"static",keyboard:!1,show:!0}))},availableFieldsGroupSort:function(n){n.sort(function(n,t){var i=n.attributes["picker-group-sort"],r=t.attributes["picker-group-sort"],u,f;return typeof i=="number"&&typeof r=="number"?i-r:typeof i=="string"&&typeof r=="string"?i.localeCompare(r):(u=n.displayName||n.name||"",f=t.displayName||t.name||"",u.localeCompare(f))})},popoverPanelSearch:function(t,i){return n("<div class='r-search'>").append(n("<input type='text'>").attr("maxlength","50").attr("placeholder",T("Ratings.Common|Search")).val("").ratInputAutoChange(function(t){var f=t.val().trim().toLocaleLowerCase(),r=t.closest(".r-panel").find("> .r-list"),u;r.find("> .r-row").each(function(t,i){var r=n(i),u=r.data("r-search-text");f&&u&&u.indexOf(f)===-1?r.addClass("r-hidden"):r.removeClass("r-hidden")});r.find("> .r-empty").remove();u=r.find("> .r-row").removeClass("r-last").filter(":not(.r-hidden)");u.length===0?r.append(n("<div class='r-empty'>").text(i)):n(u[u.length-1]).addClass("r-last")})).appendTo(t)},filterPickerRender:function(t,i,r){var o=this,s=i.newPanel(T("Ratings.Queryable|Add Filter"),r===!0?T("Ratings.Queryable|Back"):!1),f,e,u;for(r===!0&&this.availableFieldsGroupSort(t),this.popoverPanelSearch(s,T("Ratings.Queryable|No columns to display.")),f=n("<div class='r-list'>").appendTo(s).on("click","> .r-row",function(t){var r=n(t.target).closest(".r-row"),f=n(t.target).closest(".r-icon-info-circled",r),u;if(f.length){o.onFieldInformation(r.data("r-field"));return}if(u=n(t.target).closest(".r-item",r),!u.hasClass("r-disabled"))if(r.hasClass("r-group"))o.filterPickerRender(r.data("r-group").fields,i,!0);else{o.onFilterAdd(r.data("r-field"));i.hide()}}),e=0;e<t.length;e++){if(u=t[e],u.isGroup){n("<div class='r-row r-group'>").append(n("<div class='r-item'>").append(n("<span class='r-icon-columns'>"),n("<span class='r-text'>").html(u.name),n("<span class='r-icon-next'>"))).data("r-group",u).data("r-search-text",u.name.toLocaleLowerCase()).appendTo(f);continue}typeof u.queryableName=="string"&&n("<div class='r-row'>").append(n("<div class='r-item'>").append(n("<span class='r-icon-filter'>"),n("<span class='r-text'>").html(u.displayName)),n("<span class='r-icon-info-circled'>")).data("r-field",u).data("r-search-text",u.displayName.toLocaleLowerCase()).appendTo(f)}f.children().length===0&&n("<div class='r-empty'>").text(T("Ratings.Queryable|No filters to display.")).appendTo(f);i.push(s)},orderByPickerRender:function(t,i){var r=this,f,e,u;if(t.empty(),n("<div class='r-title'>").text(T("Ratings.Queryable|Order By:")).appendTo(t),u=n("<div class='r-list'>").appendTo(t).on("click","> .r-row",function(u){var f=n(u.target),e=f.closest(".r-row");f.closest(".r-icon-trash").length?r.orderByRemove(e.data("r-order-by")):r.orderByAdd(e.data("r-order-by").field);r.orderByPickerRender(t,i)}),Array.isArray(r._orderBy)||(r._orderBy=[]),r._orderBy.length===0)n("<div class='r-automatic'>").text(T("Ratings.Queryable|Automatic")).appendTo(u);else for(f=0;f<r._orderBy.length;f++)e=r._orderBy[f],n("<div class='r-row'>").append(n("<span class='r-item'>").append(n("<span class='r-direction'>").addClass(e.dir==="desc"?"r-icon-sort-desc":"r-icon-sort-asc"),n("<span class='r-text'>").html(e.field.displayName)),n("<span class='r-icon-trash'>")).data("r-order-by",e).appendTo(u);r._orderBy.length<3&&(u=n("<div class='r-add'>").text(T("Ratings.Queryable|Add Order By")).appendTo(t).click(function(){var u=i.newPanel(T("Ratings.Queryable|Add Order By")).addClass("r-add-panel").css("width",t.outerWidth()+"px");r._filters.length<1&&!r._contentType?(n("<div class='r-message'>").text(T("Ratings.Queryable|You must specify a filter before adding an order by.")).appendTo(u),i.push(u)):r.orderByPickerRenderItems(r.getAvailableFieldsPicker(),i,u,t)}))},orderByPickerRenderItems:function(t,i,r,u,f){var h=this,o,s,e;for(f===!0&&this.availableFieldsGroupSort(t),this.popoverPanelSearch(r,T("Ratings.Queryable|No columns to display.")),o=n("<div class='r-list'>").appendTo(r).on("click","> .r-row",function(t){var r=n(t.target).closest(".r-row"),o=n(t.target).closest(".r-item",r),e,f;o.hasClass("r-disabled")||(r.hasClass("r-group")?(e=i.newPanel(T("Ratings.Queryable|Add Order By"),T("Ratings.Queryable|Back")),h.orderByPickerRenderItems(r.data("r-group").fields,i,e,u,!0)):(f=r.data("r-field"),h.orderByAdd(f,f.attributes["default-order-by-direction"]||"asc")||n.rat.alert(T("Ratings.Queryable|Unable to add order by, please refresh the page and try again.")),h.orderByPickerRender(u,i),i.pop(!0)))}),s=0;s<t.length;s++){if(e=t[s],e.isGroup){n("<div class='r-row r-group'>").append(n("<div class='r-item'>").append(n("<span class='r-icon-columns'>"),n("<span class='r-text'>").html(e.name),n("<span class='r-icon-next'>"))).data("r-group",e).data("r-search-text",e.name.toLocaleLowerCase()).appendTo(o);continue}e.attributes["allow-order-by"]!==!1&&e.queryableNameNorm&&n("<div class='r-row'>").append(n("<div class='r-item'>").append(n("<span class='r-icon-sort-asc'>"),n("<span class='r-text'>").html(e.displayName))).data("r-field",e).data("r-search-text",e.displayName.toLocaleLowerCase()).appendTo(o)}o.children().length===0&&n("<div class='r-empty'>").text(T("Ratings.Queryable|No columns to display.")).appendTo(o);i.push(r)},onFilterAdd:function(n){var t=this.getField(n);t&&(this._$filterAdd.data("ratPopover").hide(),this.filterAdd(t))},onFilterRemove:function(t){var u=this,r,i;t.preventDefault();r=n(t.target).closest(".r-filter");i=r.data("r-filter");i.onRemoving();this._filters.removeByValue(i);r.ratFadeOutRemove().done(function(){u.onFilterRemoved(i)})},onFilterEdit:function(t){t.preventDefault();var i=n(t.target).closest(".r-filter").data("r-filter");i&&i.open()},onFilterAdded:function(n){var t=!1;this._loading||this._updating||(this.updateTypes(),this.updateQuery(),t=!0);this.editor.onFilterAdded(n);t&&setTimeout(function(){n.open()},200)},onFilterRemoved:function(n){this._loading||this._updating||(this.updateTypes(),this.updateQuery());this.editor.onFilterRemoved(n)},onOrderByChanged:function(n){this.editor.onOrderByChanged(n)},filterAdd:function(t,i){var r=n("<div class='r-filter'>").data("r-field",t).insertBefore(this._$filterAdd),u;this._loading||this._updating||r.addClass("r-init");try{u=t.fieldInfo.createFilter(r,i)}catch(f){r.remove();throw f;}u.render();this._filters.push(u);r.data("r-filter",u);this.onFilterAdded(u);this._loading||this._updating||setTimeout(function(){r.removeClass("r-init")},0)},filterRemove:function(){},updateTypes:function(n){var f,t,o,i,r,c,s,v,l,a,h,u,e;if(this._options.allowContentTypePicking!==!1){if(f=this.filterTypePicker(),f.userChanged&&n!==!0){this.updateFilters();return}if(this._filters.length===0){f.select(f.getAllItem(),!0);return}for(r={},t=0;t<this._filters.length;t++)for(c=this._filters[t],s=0;s<c.field.providerNames.length;s++)for(v=c.field.providerNames[s],l=this._info.providersByName[v],o=0;o<l.types.length;o++)i=l.types[o],r[i.name]=i;for(a=Object.keys(r),h=0;h<a.length;h++)for(i=r[a[h]],t=0;t<this._filters.length;t++)this.filterHasType(this._filters[t],i)||delete r[i.name];for(t=0;t<this._info.typeItems.length;t++)if(u=this._info.typeItems[t],i=u.type,u.selected=!(!i||!r[i.name]),u.selected&&u.isGroup)for(e=0;e<this._info.typeItems.length;e++)this._info.typeItems[e].group===u.nameNorm&&(this._info.typeItems[e].selected=!0);f.updateItems()}},updateFilters:function(){var u=this._info.selected,f,n,t,i,r;if(u){for(f=!1,n=0;n<this._filters.length;n++){for(t=this._filters[n],i=!0,r=0;r<u.length;r++)if(!this.filterHasType(t,u[r].type)){i=!1;f=!0;break}t.$filter[i?"removeClass":"addClass"]("r-unavailable");t.$filter.attr("title",i?null:T("Ratings.Common|This filter is not available for the selected types."))}this._$filterType[f?"addClass":"removeClass"]("r-unavailable")}},updateQuery:function(n){var h,f,r,e,o,s;if(!this._updating||n===!0){var t="",i="",u=!0;if(this._options.allowContentTypePicking!==!1?(h=this.filterTypePicker(),h.userChanged&&(f="",h.forEachSelected(function(n){f+=(f.length?",":"")+n.valueNorm}),f.length&&(t+="type("+f+")",i=t))):t+="type("+this._contentType+")",r=this._filters,Array.isArray(r)&&r.length>0)for(e=0;e<r.length;e++)u&&!r[e].isEmpty()&&(u=!1),o=r[e].queryFilter(),typeof o=="string"&&o.length&&(t.length&&(t+=" "),t+=o.trim(),i+=o.trim());s=this.editor.getSearchText();typeof s=="string"&&s.length&&(t+=(t.length?" ":"")+s,i+=(i.length?" ":"")+s,u=!1);!this._queryEmpty&&u&&this.onEmpty();t||(t=null);i||(i=null);this._queryEmpty=u;this._query=t;this._queryClean=i;this.updateState({q:i})}},updateOrderBy:function(n){var o,r,s,u,h,c,f,i,t,e;if(!this._updating||n===!0){if(Array.isArray(this._orderBy)){for(o=this.getAvailableFields(),r=this._orderBy,t=r.length-1;t>=0;t--){for(s=!1,u=0;u<o.length;u++)if(o[u].id===r[t].field.id){s=!0;break}s||r.splice(t,1)}this._orderByClause&&this._orderBy.length===0&&delete this._orderBy}if(h=Array.isArray(this._orderBy)?this._orderBy.length:0,c=h===0||this._orderBy[0].dir!=="desc",this._$orderBy.find("> .r-icon").removeClass("r-asc r-desc").addClass(c?"r-asc":"r-desc"),this._$orderBy[h===0?"addClass":"removeClass"]("r-none"),f=!1,i=null,this._orderByClause&&!Array.isArray(this._orderBy))f=!0,delete this._orderByClause;else{if(Array.isArray(this._orderBy))for(i="",t=0;t<this._orderBy.length;t++)e=this._orderBy[t],i+=(i.length>0?",":"")+e.field.queryableNameNorm+(typeof e.dir=="string"&&e.dir.toLowerCase()==="desc"?" desc":"");f=this._orderByClause!==i;this._orderByClause=i}if(this.updateState({o:i}),f)this.onOrderByChanged(r)}},filterHasType:function(n,t){for(var r=n.field,i=0;i<r.providers.length;i++)if(r.providers[i].typesByName[t.name])return!0;return!1},needsUserKey:function(){var n=this._filters,t;if(!Array.isArray(n)||n.length===0)return!1;for(t=0;t<n.length;t++)if(n[t].needsUserKey())return!0;return!1},queryIsEmpty:function(){return this._queryEmpty},hasFilters:function(){return this._filters.length>0},requireCount:function(){return this._options.requireCount||!1},onFilterChanged:function(n){this.updateQuery();this.editor.onFilterChanged(n)},onEmpty:function(){this.editor.onQueryEmpty()},filterUsingField:function(n){var u=this.getField(n),i,t,r;if(!u)return null;for(i=[],t=this._filters.length-1;t>=0;t--)r=this._filters[t],r.field.id===u.id&&i.push(r);return i},getQueryDefaults:function(){return{q:{value:null},o:{value:null},p:{value:1},s:{value:50},a:{value:null}}},getQueryParts:function(t){var u,i;if(!t&&!this._options.useQuerystring)return{hasQuery:!1};var f={},e=!1,r=this.getQueryDefaults();!t&&this._options.defaultQuery&&(r.t.value=n.rat.getQuerystring("t",this._options.defaultQuery),n.rat.getQuerystring("do")&&(r.o.value=n.rat.getQuerystring("o",this._options.defaultQuery)));for(u in r)i=n.rat.getQuerystring(u,t),typeof i=="string"&&i.length>0?e=!0:i=null,f[u]=i===undefined||i===null?r[u].value:i;return f.hasQuery=e,f},updateState:function(t,i){var l=this._isDirty||!1,e,f,o,s,u,v,c;if(t!==!1)for(t||(t={q:this.hasFilters()?this.getQueryClause(!0):null,o:this.getOrderByClause()}),this.queryParts||(this.queryParts={}),e=Object.keys(t),f=e.length-1;f>=0;f--)if(o=e[f],this.queryParts[o]!==t[o]){l=!0;break}if(!l)return!1;this._isDirty||(this._isDirty=i!==!1);for(s in t)this.queryParts[s]=t[s];if(!this._loading&&!this._updating){var h=this._options.storageKey,a=typeof h=="string"&&h&&window.localStorage&&!n.rat.getQuerystring("ns")?!0:!1,r=a?"":this.getQueryAction()+window.location.search,y=this.getQueryDefaults();for(u in this.queryParts)u!=="hasQuery"&&(v=y[u]||{value:null,encode:!0},c=this.queryParts[u],c!==v.value&&(r=n.rat.setQuerystring(u,c,r)));n.rat.user&&(this.needsUserKey()?r=n.rat.setQuerystring("k",n.rat.user.userKey,r):r.indexOf("k=")>=0&&(r=n.rat.setQuerystring("k",null,r)));r.indexOf("do=")>=0&&(r=n.rat.setQuerystring("do",null,r));a?localStorage.setItem(h,r):window.history.replaceState(null,null,r);this.onChanged()}},onChanged:function(){return this._loading||this._updating?!1:this._isDirty!==!0?void 0:(delete this._isDirty,this._queryEmpty&&this._options.requireFilter)?(this._renderedEmpty||(this._renderedEmpty=!0,this.editor.onQueryChanged()),!1):(delete this._renderedEmpty,this.editor.onQueryChanged(),!0)}});t.QueryManager=n.ratObjects.Class.extend({init:function(n,t){this.editor=n;this.builder=t},cancel:function(){this._request&&(this._request.abort("abort"),delete this._request,this.editor.loading(!1))},isBusy:function(){return this._request?!0:!1},fetch:function(){var t,i;if(this.cancel(),this.builder.queryIsEmpty()){this.editor.onDataReady(null);return}t=this;this.editor.loading();i=this.editor.options.apiPath+window.location.search;i=n.rat.setQuerystring("q",this.builder.getQueryClause(),i);i=n.rat.setQuerystring("o",this.builder.getOrderByClause(),i);this.builder.needsUserKey()&&(i=n.rat.setQuerystring("k",n.rat.user.userKey,i));this._request=n.ajax({url:i,method:"GET",success:function(n){if(n.success===!1)t.editor.onError(n);else t.editor.onDataReady(n);t.editor.loading(!1);delete t._request},error:function(n){if(delete t._request,!n||n.statusText!=="abort"){t.editor.onError(n);t.editor.loading(!1)}}})}});t.QueryableEditor=n.ratObjects.Class.extend({init:function(t,i,r){var u,f,e;i=n.extend(i||{},{requireCount:!0});u=this;this.$form=t.find(".r-queryable-form");this.$element=t;this.options=i;this.builder=this.createQueryBuilder();this.queryManager=this.createQueryManager();f=this.$form.data("page-size");i.pageSize=typeof f!="number"||f<=0||f>100?10:f;i.requireFilter=this.$form.data("require-filter");i.useQuerystring=this.$form.data("use-querystring")!==!1;i.storageKey=this.$form.data("storage-key");e=t.find(".r-search-input");this.$input=e.find("> input").ratInputAutoChange(n.proxy(this.searchChanged,this));this.$inputClear=e.find("> .r-clear");t.on("submit",function(n){n.preventDefault()});t.find(".r-search").on("click",function(){u.$input.focus()});this.$inputClear.on("click",function(){u.$inputClear.hide();u.$input.val("").focus();u.searchChanged()});this.$inputClear[this.$input.val().trim()?"show":"hide"]();!u.$input.is(":focus")&&u.$input.is("[autofocus]")&&setTimeout(function(){u.$input.focus()},200);r!==!1&&this.onReady()},loading:function(){},changing:function(n){return typeof n=="boolean"&&(this._changing=n),this._changing},onSearchText:function(){},onReady:function(){n.rat.getQuerystring("nc")&&window.history.replaceState(null,null,n.rat.setQuerystring("nc",null));this.builder.loadQuery();this.$element.ratBusy(!1)},onDataReady:function(t){var i=this.$element.find(".r-results-wrap"),r=this.$element.find(".r-no-query").removeClass("r-hidden");t==null?(i.empty(),r.fadeIn()):(i.empty().append(t),r.hide(),n.rat.page.bodyChanged(i))},onError:function(t){this.$element.find(".r-no-query").hide();this.$element.find(".r-results-wrap").empty().append(n("<div class='alert alert-danger'>").html(n.rat.errorMessage(T("Ratings.Queryable|Unable to process request."),t)))},onFilterChanged:function(){},onQueryChanged:function(){this.$element[this.builder.queryIsEmpty()?"addClass":"removeClass"]("r-query-empty");this.queryManager&&this._changing!==!0&&this.queryManager.fetch()},onQueryLoaded:function(){this.queryManager&&!this.builder.queryIsEmpty()&&this.$element.find("> .r-results-wrap .r-content").length===0&&this.queryManager.fetch()},onQueryEmpty:function(){this.builder.hasFilters()||n.rat.getQuerystring("q")===null||window.history.replaceState(null,null,n.rat.setQuerystring("q",null));this.$element.addClass("r-query-empty")},onFilterAdded:function(){},onFilterRemoved:function(){},onOrderByChanged:function(){},onTypeChanged:function(){},onUpdatingEnding:function(){},createQueryBuilder:function(){return new t.QueryBuilder(this,this.$element,this.options)},createQueryManager:function(){return new t.QueryManager(this,this.builder)},getOptions:function(){return null},searchChanged:function(){var n=this.$input.val().trim();this.$inputClear[n?"show":"hide"]();this.builder.updateQuery()},getSearchText:function(){return this.$input.val().trim()},onSearchText:function(n){this.$input.val(n)}});n.fn.ratQueryableEditor=function(i){var r=this.data("ratQueryableEditor");return r?r:(this.each(function(){var u=n(this),f=u.data("editor-type");r=f&&t[f+"Editor"]?new t[f+"Editor"](u,i):new t.QueryableEditor(u,i);u.data("ratQueryableEditor",r)}),this)};n.fn.ratPagedContent=function(t){return this.each(function(){var u=n(this),i=u.data("ratPagedContent");i||u.data("ratPagedContent",i=new r(u,typeof t=="string"?null:t));typeof t=="string"&&typeof i[t]=="function"&&i[t]()}),this};n.ratObjects.RatViewTimeline=n.ratObjects.Class.extend({init:function(t){this._$element=t;this._$timeline=t.find(".r-timeline");this._comments=null;this._containers=[];this._containersByKey={};this._dateStart=null;this._$filter=null;this._filter=null;this._loadMoreWaypoint=null;this._ajax=null;this._events=this.getEvents();this._filterAll=0;for(var i=0;i<this._events.length;i++)this._filterAll|=this._events[i].filter;this._filter=parseInt(n.rat.getQuerystring("f")||n.rat.getStateCookie())||this._filterAll;this.initActions();this.initComments()},initActions:function(){var t=this;this._$filter=this._$element.find(".r-timeline-filter").ratPopover({mode:"click",className:"r-popover-timeline-filter r-keep-padding",onRender:function(i){for(var r,e,u,o=n("<ul class='r-menu r-menu-vertical'>").on("click","> li",function(i){i.preventDefault();var r=n(i.target),u=parseInt(r.data("filter"));r.hasClass("r-checked")?(r.removeClass("r-checked"),t._filter&=~u):(r.addClass("r-checked"),t._filter|=u);t.filterChanged(!0)}).appendTo(i),f=0;f<t._events.length;f++)if(r=t._events[f],n("<li class='r-separator'>").append(n("<span class='r-timeline-event'>").addClass(r.style).addClass((t._filter&r.filter)>0?" r-checked":"").data("filter",""+r.filter).append(e=n("<span class='r-icon'>"),n("<span class='r-text'>").text(r.name))).appendTo(o),r.iconStyle&&e.addClass(r.iconStyle),r.iconAttrs)for(u in r.iconAttrs)Object.prototype.hasOwnProperty.call(r.iconAttrs,u)&&e.attr(u,r.iconAttrs[u])}});this.filterChanged()},initComments:function(){this.datesReady(this._$element.find(".r-timeline > .r-timeline-inner > .r-date"));this.loadMoreTrigger()},getEvents:function(){n.rat.alert("Inheritors must overwrite RatViewTimeline.getEvents")},filterChanged:function(t){var i=this,r;i._$filter[i._filter===i._filterAll?"removeClass":"addClass"]("r-selected");i._filter!==i._filterAll?(r=i._$timeline.find("> .r-filtering"),r.length===0&&(r.data("r-binded")||r.data("r-binded",!0).find("> .r-clear").click(n.proxy(i.clearFilter,i)))):i._$timeline.find("> .r-filtering").ratFadeOutRemove();i._$filter[i._filter===i._filterAll?"removeClass":"addClass"]("r-selected");n.rat.setStateCookie(i._filter===i._filterAll?null:i._filter);window.history.replaceState(null,null,n.rat.setQuerystring("f",i._filter===i._filterAll?null:i._filter));t===!0&&i.reload()},clearFilter:function(){this._filter=this._filterAll;this.filterChanged(!0)},datesReady:function(t,i){var r=this,e,u,f;if((i!==!1&&(i=!0),t.each(function(t,i){var u=n(i),f=moment.utc(u.data("date"));f.isValid()&&(u.data("moment",f),r._containers.push(u),r._containersByKey[f.format("YYYY-MM-DD")]={$container:u,date:f})}),e=!0,u=n(t[0]).data("moment"),r._dateStart=n(t[t.length-1]).data("moment"),r._dateStart&&u)&&(r._filter&1)!=0){if(!r._comments&&(f=r._$element.find(".r-date.r-today"),r._comments=f.ratComments({autoLoad:!1,delayLoading:!1,loadMode:"day",day:f.data("moment").format("YYYY-MM-DD")}).data("ratComments"),i)){f.attr("data-remote",!0).attr("data-remote-name","comments").on("ratings-remote-setup",function(n){n.remoteName==="comments"&&(n.remoteData.type="root-date-range",n.remoteData.sd=r._dateStart.format(),n.remoteData.ed=u.format(),n.remoteData.s=r._comments.getSlug())}).on("ratings-remote-ready",function(n){n.remoteName==="comments"&&r.loadCommentsReady(n.remoteSuccess===!1?n.remoteResult:n.remoteResult.data)});e=!1}e&&r.loadComments(r._dateStart,u)}},loadComments:function(t,i){var r=this;n.ajax({url:ratCommentsApiUrl+"/root-date-range",method:"POST",data:{sd:t.format(),ed:i.format(),s:r._comments.getSlug()},success:function(n){r.loadCommentsReady(n)},error:function(t){n.rat.handleError(T("Ratings.Data|Unable to load comments."),t,r._$element.find(".r-comments"),!1)}})},loadCommentsReady:function(n){var f=this,i,t,r,e,o,s,l,h,a,v,u,y,c;if(n.success===!1){f._comments.busy(!1);return}i={};e=n.dates;for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&(s=moment.utc(o),s.isValid()!==!1)&&(t=s.format("YYYY-MM-DD"),i[t]={count:e[o],comments:[],date:s,day:t});for(l=n.comments,h=0;h<l.length;h++)(a=l[h],v=moment.utc(a.createdOn),v.isValid()!==!1)&&(t=v.format("YYYY-MM-DD"),r=i[t],r)&&r.comments.push(a);for(t in i)Object.prototype.hasOwnProperty.call(i,t)&&(r=i[t],u=f._containersByKey[t],u||(u=f.insertDateContainer(r.date)),y=u.$container.hasClass("r-today"),c=u.$container.data("ratComments"),c||(c=u.$container.ratComments({slug:f._comments.getSlug(),autoLoad:!1,delayLoading:!1,loadMode:"day",day:t,allowNew:y}).data("ratComments")),c.addComments(r));f._comments.busy(!1)},insertDateContainer:function(t){var r=this,f,u;n(r._containers).each(function(i,r){var e=n(r),o=e.data("moment");return o?o.diff(t)<0?!1:(f=i,u=e,!0):!0});var o=t.format("YYYY-MM-DD"),e=t.format(T("Ratings.Common|MMMM D, YYYY")),i=n("<div class='r-date'>").attr("data-display",e).attr("data-date",t.format());return n('<div class="r-date-display" data-help-id="timeline-date">').text(e).appendTo(i),u?(r._containers.splice(f+1,0,i),i.insertAfter(u)):(r._containers.push(i),i.appendTo(r._containers[0].parent())),r._containersByKey[o]={$container:i,date:t}},loadMoreTrigger:function(){var n=this,t=n._$element.find(".r-timeline > .r-timeline-inner > .r-footer");t.length!==0&&(n._loadMoreWaypoint&&(n._loadMoreWaypoint.destroy(),n._loadMoreWaypoint=null),n._loadMoreWaypoint=new Waypoint({element:t,offset:"100%",handler:function(){n._loadMoreWaypoint.destroy();n._loadMoreWaypoint=null;n.loadMore()}}))},reload:function(){var i=this,t=this._$timeline.find("> .r-timeline-inner").empty().ratBusy();this._comments=null;this._containers=[];this._containersByKey={};this._dateStart=null;this._ajax&&(this._ajax.abort("abort"),this._ajax=null);this._ajax=n.ajax({url:this._$element.data("api-url")+"/timeline/"+encodeURIComponent(this._$element.data("search-key"))+"/"+this._filter,dataType:"html",success:function(r){i._ajax=null;var u=n(r);t.append(u.children());i.datesReady(t.find("> .r-date"),!1);i.loadMoreTrigger();t.ratBusy(!1)},error:function(r){(i._ajax=null,r&&r.statusText==="abort")||(n.rat.handleError(T("Ratings.Data|An error occurred while loading timeline."),r,t,!0),t.ratBusy(!1))}})},loadMore:function(){var t=this,i=this._$element.find(".r-timeline > .r-timeline-inner > .r-footer");n.ajax({url:this._$element.data("api-url")+"/timeline-more/"+encodeURIComponent(this._$element.data("search-key"))+"/"+this._filter+"/"+this._dateStart.format("YYYY-MM-DD"),dataType:"html",success:function(r){var u,e;i.remove();var o=n(r),s=t._$element.find(".r-timeline > .r-timeline-inner"),f=o.find("> .r-date");f.length!==0&&(u=n(f[0]),e=s.find("> .r-date:last"),u.children().each(function(t,i){var r=n(i),u;if(r.is(".r-date-display")){r.remove();return}(u=r.data("key"),u)&&e.find(".r-timeline-event:ratData(key=="+u+")").length>0&&r.remove()}),e.append(u.children()),u.remove(),t.datesReady(f),s.append(o.children()),t.loadMoreTrigger())},error:function(t){i.empty();n.rat.handleError(T("Ratings.Data|An error occurred while loading more events."),t,i,!0)}})}});n.ratObjects.RatAnalysisReport=n.ratObjects.Class.extend({init:function(){var t=this,i=n(".r-analysis-report");i&&i.click(n.proxy(t.downloadAnalysisReport,t))},downloadAnalysisReport:function(t){var i;if(t.preventDefault(),i=n(t.target).closest(".r-analysis-report"),i.bstooltip("hide"),!i.hasClass("r-downloading")){i.addClass("r-downloading");i.ratBusy({inline:!0,fill:!0,translucent:!0,message:""});var f=i.data("path"),e=i.data("document-name"),u,r=new XMLHttpRequest;r.addEventListener("readystatechange",function(){r.readyState===2&&r.status===200||r.readyState===3||r.readyState===4&&(i.removeClass("r-downloading"),i.ratBusy(!1),u=URL.createObjectURL(r.response),document.querySelector("#save-file").setAttribute("href",u),document.querySelector("#save-file").setAttribute("download",e+".pdf"),document.querySelector("#save-file").click(),setTimeout(function(){window.URL.revokeObjectURL(u)},6e4))});r.responseType="blob";r.open("get",f);r.send()}}})})(jQuery);